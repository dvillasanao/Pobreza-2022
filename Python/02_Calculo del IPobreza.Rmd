---
title: "C谩lculo del 铆ndice"
subtitle: 'ndice de pobreza 2022 / Python'
author: "Diana Villasana Ocampo"
output:
   html_document:
      highlight: tango
      theme: flatly
      toc: yes
      toc_depth: 2
      toc_float:
        collapsed: yes
---

\usepackage{color}

```{=html}
<style>
code.r{
  font-size: 10px;
}
pre {
  font-size: 12px
}
</style>

<style>
body {
text-align: justify;
font-style: normal;
font-family: "Montserrat";
font-size: 12px
}
h1.title {
  font-size: 40px;
  color: #000D3B;
}
h1 {
  color: #B6854D;
}
h2 {
  color: #172984;
}
h3 {
  color: #172984;
}
</style>
```

```{=html}
<style>
.nav>li>a {
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #0A2687;
}
.nav-pills>li.active>a, .nav-pills > li.active > a:hover, .nav-pills > li.active > a:focus {
    color: #ffffff;
    background-color: #09C2BC;
}
.top1-tiles a:nth-of-type(1):hover, .top-tiles1 a:nth-of-type(1):focus{
    color: #ffffff;
    background: #0A6A87
}
.top2-tiles a:nth-of-type(1):hover, .top2-tiles a:nth-of-type(1):focus{
    color: #ffffff;
    background: #0A6CC8
}
.top3-tiles a:nth-of-type(1):hover, .top2-tiles a:nth-of-type(1):focus{
    color: #ffffff;
    background: #596AB7
}
.top4-tiles a:nth-of-type(1):hover, .top2-tiles a:nth-of-type(1):focus{
    color: #ffffff;
    background: #A92AA4
}
</style>
```

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = FALSE, cache.lazy = FALSE, 
                         eval = FALSE, class.source = "fold-show")
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(digits = 2, encoding = "UTF8")
options(reticulate.repl.quiet = TRUE) #Python REPL in the R session, which can be used to interactively run Python code. All code executed within the REPL is run within the Python main module, and any generated Python objects will persist in the Python session
modo_notdebug = TRUE #es para separar las configuraciones de lo que ser铆a un despliegue a producci贸n y un ambiente local, el ALLOWED_HOST es un settings para definir los dominios permitidos cuando estar谩 en modo producci贸n,
```   
 

```{r, echo=FALSE}
rm(list = ls())
```

```{r, echo=FALSE}
setwd(here::here())
```
 Se define un `conda environment` a utilizar:

```{r,eval=FALSE}
#Se utiliza {reticulate} para instalar miniconda con:
require(reticulate)
#reticulate::install_miniconda()
##Se visualiza la configuraci贸n de python: que tengo actualemente.  
#reticulate::py_config()
reticulate::repl_python() #can be used to interactively run Python code
# Se define un `conda environment` a utilizar:
#reticulate::conda_create(envname='Pobreza-2022', 
 #                        python_version="3.11.5")
```
**Ubicaci贸n del proyecto** 

```{r}
root_dir = rprojroot::find_rstudio_root_file()
```


```{python}
import os
# Cambia el directorio de trabajo al directorio actual del script
os.path.dirname(os.getcwd())
current_directory = r.root_dir
os.chdir(current_directory)
os.getcwd()
```

**Se intalan la paqueter铆as de pyton** 
```{python}
# Se instalan los paquetes y librer铆as a utilizar en el programa
#pip install pandas
#pip install numpy
#pip install tabulate
import pandas as pd 
import numpy as np
from tabulate import tabulate
```


## Medici贸n multidimensional del 铆ndice de pobreza 2022 {.tabset .tabset-pills .top1-tiles}       

Se sigue la estructura del 铆ndice de pobreza, presentado en la p谩gina oficial del CONEVAL.   

De acuerdo con los Lineamientos y criterios generales para la definici贸n, identificaci贸n y medici贸n de la pobreza (2018) que se pueden consultar en el [Diario Oficial de la Federaci贸n](https://www.dof.gob.mx/nota_detalle.php?codigo=5542421&fecha=30/10/2018) y la Metodolog铆a para la medici贸n multidimensional de la pobreza en M茅xico, tercera edici贸n (https://www.coneval.org.mx/InformesPublicaciones/InformesPublicaciones/Documents/Metodologia-medicion-multidimensional-3er-edicion.pdf).   

Siguiendo la estructura del c谩lculo del 铆ndice multidimensional de la pobreza, se simplifican los c贸digos para entender el orden del c谩lculo de los indicadores sociodemogr谩ficos.      


### Indicadores de carencias sociales  {.tabset .tabset-pills .top2-tiles}    

#### I. Indicador de rezago educativo  {.tabset .tabset-pills .top3-tiles}     

```{python}
poblacion = pd.read_csv(current_directory + "/Bases de datos/poblacion.csv", low_memory = False)
```

**Indicador de carencia por rezago educativo `ic_rezedu`**

Se considera en situaci贸n de carencia por rezago educativo a la poblaci贸n que cumpla con alguno de los siguientes criterios:

1. Tiene de tres a 21 a帽os, no cuenta con la educaci贸n obligatoria y no asiste a un centro de educaci贸n formal. 
2. Tiene 22 a帽os o m谩s, naci贸 a partir del a帽o 1998 y no ha terminado la educaci贸n obligatoria (media superior).   
3. Tiene 16 a帽os o m谩s, naci贸 entre 1982 y 1997 y no cuenta con el nivel de educaci贸n obligatorio vigente en el momento en que deb铆a haberlo cursado (secundaria completa).   
4. Tiene 16 a帽os o m谩s, naci贸 antes de 1982 y no cuenta con el nivel de educaci贸n obligatorio vigente en el momento en que deb铆a haberlo cursado (primaria completa).	  

##### Opci贸n 1     

```{python}
import pandas as pd
import numpy as np

rezago_educativo = poblacion.copy()

# Convirtiendo variables string a numericas
rezago_educativo[['parentesco','edad','asis_esc','nivelaprob','gradoaprob','antec_esc','hablaind'
                ]] = rezago_educativo[['parentesco','edad','asis_esc','nivelaprob','gradoaprob','antec_esc','hablaind']].apply(pd.to_numeric, errors = 'coerce')
       
# Poblaci贸n objetivo: no se incluye a hu茅spedes ni trabajadores dom茅sticos
rezago_educativo = rezago_educativo[~((rezago_educativo['parentesco'] >= 400) & (rezago_educativo['parentesco'] < 500) |
                                      (rezago_educativo['parentesco'] >= 700) & (rezago_educativo['parentesco'] < 800))
                                      ]

# A帽o de nacimiento
rezago_educativo['anac_e'] = 2022 - rezago_educativo['edad'].fillna(0)

# Inasistencia escolar (se reporta para personas de 3 a帽os o m谩s)
rezago_educativo['inas_esc'] = np.NAN
rezago_educativo.loc[(rezago_educativo['asis_esc'] == 1), 'inas_esc'] = 0 # S铆 asiste
rezago_educativo.loc[(rezago_educativo['asis_esc'] == 2), 'inas_esc'] = 1 # No asiste

# Nivel educativo
rezago_educativo['niv_ed'] = np.NAN
# Con primaria incompleta o menos
rezago_educativo.loc[(rezago_educativo['nivelaprob'] < 2) | ((rezago_educativo['nivelaprob'] == 2) & (rezago_educativo['gradoaprob'] < 6)), 'niv_ed'] = 0
# Primaria completa o secundaria incompleta
rezago_educativo.loc[((rezago_educativo['nivelaprob'] == 2) & (rezago_educativo['gradoaprob'] == 6)) |
                      ((rezago_educativo['nivelaprob'] == 3) & (rezago_educativo['gradoaprob'] < 3)) |
                       (((rezago_educativo['nivelaprob'] == 5) | (rezago_educativo['nivelaprob'] == 6)) & 
                        (rezago_educativo['gradoaprob'] < 3) &                   
                         (rezago_educativo['antec_esc'] == 1)), 'niv_ed'] = 1
# Secundaria completa o media superior incompleta
rezago_educativo.loc[((rezago_educativo['nivelaprob'] == 3) & (rezago_educativo['gradoaprob'] == 3)) |
                      ((rezago_educativo['nivelaprob'] == 4) & (rezago_educativo['gradoaprob'] < 3)) |
                       ((rezago_educativo['nivelaprob'] == 5) & (rezago_educativo['antec_esc'] == 1) & (rezago_educativo['gradoaprob'] >= 3)) |
                        ((rezago_educativo['nivelaprob'] == 6) & (rezago_educativo['antec_esc'] == 1) & (rezago_educativo['gradoaprob'] >= 3)) |
                         ((rezago_educativo['nivelaprob'] == 5) & (rezago_educativo['antec_esc'] == 2) & (rezago_educativo['gradoaprob'] < 3)) |
                          ((rezago_educativo['nivelaprob'] == 6) & (rezago_educativo['antec_esc'] == 2) & (rezago_educativo['gradoaprob'] < 3)), 'niv_ed'] = 2
# Media superior completa o mayor nivel educativo
rezago_educativo.loc[((rezago_educativo['nivelaprob'] == 4) & (rezago_educativo['gradoaprob'] == 3)) |
                      ((rezago_educativo['nivelaprob'] == 5) & (rezago_educativo['antec_esc'] == 2) & (rezago_educativo['gradoaprob'] >= 3)) |
                       ((rezago_educativo['nivelaprob'] == 6) & (rezago_educativo['antec_esc'] == 2) & (rezago_educativo['gradoaprob'] >= 3)) |
                        ((rezago_educativo['nivelaprob'] == 5) & (rezago_educativo['antec_esc'] > 2)) |
                         ((rezago_educativo['nivelaprob'] == 6) & (rezago_educativo['antec_esc'] > 2)) |
                          ((rezago_educativo['nivelaprob'] >= 7) & (~rezago_educativo['nivelaprob'].isna())), 'niv_ed'] = 3

# Indicador de carencia por rezago educativo
rezago_educativo['ic_rezedu'] = np.NAN
# Presenta carencia
rezago_educativo.loc[(rezago_educativo['anac_e'] >= 1998) & (rezago_educativo['edad'].between(3, 21)) &
                      (rezago_educativo['inas_esc'] == 1) & (rezago_educativo['niv_ed'] < 3), 'ic_rezedu'] = 1 # Presenta carencia
rezago_educativo.loc[((rezago_educativo['anac_e'] >= 1982) & (rezago_educativo['anac_e'] <= 1997)) &
                      (rezago_educativo['edad'] >= 16) & (rezago_educativo['niv_ed'] < 2), 'ic_rezedu'] = 1 # Presenta carencia
rezago_educativo.loc[(rezago_educativo['anac_e'] <= 1981) & (rezago_educativo['edad'] >= 16) &  
                      (rezago_educativo['niv_ed'] == 0), 'ic_rezedu'] = 1 # Presenta carencia
rezago_educativo.loc[(rezago_educativo['anac_e'] >= 1998) & (rezago_educativo['edad'] >= 22) & 
                      (rezago_educativo['niv_ed'] < 3), 'ic_rezedu'] = 1 # Presenta carencia
                      
# No presenta carencia
rezago_educativo.loc[(rezago_educativo['edad'].between(0, 2)), 'ic_rezedu'] = 0 # No presenta carencia
rezago_educativo.loc[(rezago_educativo['anac_e'] >= 1998) & (rezago_educativo['edad'].between(3, 21)) & 
                      (rezago_educativo['inas_esc'] == 0), 'ic_rezedu'] = 0 # No presenta carencia
rezago_educativo.loc[(rezago_educativo['niv_ed'] == 3), 'ic_rezedu'] = 0 # No presenta carencia
rezago_educativo.loc[((rezago_educativo['anac_e'] >= 1982) & (rezago_educativo['anac_e'] <= 1997)) & (rezago_educativo['edad'] >= 16) &
                      ((rezago_educativo['niv_ed'] >= 2) & (~rezago_educativo['niv_ed'].isna())), 'ic_rezedu'] = 0 # No presenta carencia
rezago_educativo.loc[(rezago_educativo['anac_e'] <= 1981) & (rezago_educativo['edad'] >= 16) &
                      rezago_educativoativo['niv_ed'] >= 1) & (~rezago_educativo['niv_ed'].isna())), 'ic_rezedu'] = 0 # No presenta carencia
                      
# Hablante de lengua ind铆gena
rezago_educativo['hli'] = np.NAN
rezago_educativo.loc[(rezago_educativo['hablaind'] == 1) & (rezago_educativo['edad'] >= 3), 'hli'] = 1 # Habla lengua ind铆gena
rezago_educativo.loc[(rezago_educativo['hablaind'] == 2) & (rezago_educativo['edad'] >= 3), 'hli'] = 0 # No habla lengua ind铆gena

rezago_educativo = rezago_educativo[['folioviv', 'foliohog', 'numren', 'edad', 'anac_e', 'inas_esc', 'niv_ed',
                                     'ic_rezedu', 'parentesco', 'hli'
                                     ]]
```

**Se guarda la base de datos** 
```{python}
#del [[rezedu]] # Eliminamos el data.frame "rezedu"  
rezago_educativo.to_csv(current_directory + '/Output/Data/' + 'ic_rezedu22.csv', index = False)
```

##### Opci贸n 2  

```{python}
def convert_to_numeric(df):
    cols_to_convert = ['parentesco','edad','asis_esc','nivelaprob','gradoaprob','antec_esc','hablaind']
    df[cols_to_convert] = df[cols_to_convert].apply(pd.to_numeric, errors='coerce')
    return df

def filter_population(df):
    return df[~((df['parentesco'] >= 400) & (df['parentesco'] < 500) | (df['parentesco'] >= 700) & (df['parentesco'] < 800))]

def add_birth_year(df):
    df['anac_e'] = 2022 - df['edad'].fillna(0)
    return df

def add_inas_esc(df):
    df['inas_esc'] = np.NAN
    df.loc[(df['asis_esc'] == 1), 'inas_esc'] = 0
    df.loc[(df['asis_esc'] == 2), 'inas_esc'] = 1
    return df

def add_niv_ed(df):
    df['niv_ed'] = np.NAN
    df.loc[(df['nivelaprob'] < 2) | ((df['nivelaprob'] == 2) & (df['gradoaprob'] < 6)), 'niv_ed'] = 0
    df.loc[((df['nivelaprob'] == 2) & (df['gradoaprob'] == 6)) |
           ((df['nivelaprob'] == 3) & (df['gradoaprob'] < 3)) |
           (((df['nivelaprob'] == 5) | (df['nivelaprob'] == 6)) & (df['gradoaprob'] < 3) & (df['antec_esc'] == 1)), 'niv_ed'] = 1
    df.loc[((df['nivelaprob'] == 3) & (df['gradoaprob'] == 3)) |
           ((df['nivelaprob'] == 4) & (df['gradoaprob'] < 3)) |
           ((df['nivelaprob'] == 5) & (df['antec_esc'] == 1) & (df['gradoaprob'] >= 3)) |
           ((df['nivelaprob'] == 6) & (df['antec_esc'] == 1) & (df['gradoaprob'] >= 3)) |
           ((df['nivelaprob'] == 5) & (df['antec_esc'] == 2) & (df['gradoaprob'] < 3)) |
           ((df['nivelaprob'] == 6) & (df['antec_esc'] == 2) & (df['gradoaprob'] < 3)), 'niv_ed'] = 2
    df.loc[((df['nivelaprob'] == 4) & (df['gradoaprob'] == 3)) |
           ((df['nivelaprob'] == 5) & (df['antec_esc'] == 2) & (df['gradoaprob'] >= 3)) |
           ((df['nivelaprob'] == 6) & (df['antec_esc'] == 2) & (df['gradoaprob'] >= 3)) |
           ((df['nivelaprob'] == 5) & (df['antec_esc'] > 2)) |
           ((df['nivelaprob'] == 6) & (df['antec_esc'] > 2)) |
           ((df['nivelaprob'] >= 7) & (~df['nivelaprob'].isna())), 'niv_ed'] = 3
    return df

def add_ic_rezedu(df):
    df['ic_rezedu'] = np.NAN
    df.loc[(df['anac_e'] >= 1998) & (df['edad'].between(3, 21)) &
           (df['inas_esc'] == 1) & (df['niv_ed'] < 3), 'ic_rezedu'] = 1
    df.loc[((df['anac_e'] >= 1982) & (df['anac_e'] <= 1997)) &
           (df['edad'] >= 16) & (df['niv_ed'] < 2), 'ic_rezedu'] = 1
    df.loc[(df['anac_e'] <= 1981) & (df['edad'] >= 16) & (df['niv_ed'] == 0), 'ic_rezedu'] = 1
    df.loc[(df['anac_e'] >= 1998) & (df['edad'] >= 22) & (df['niv_ed'] < 3), 'ic_rezedu'] = 1
    df.loc[(df['edad'].between(0, 2)), 'ic_rezedu'] = 0
    df.loc[(df['anac_e'] >= 1998) & (df['edad'].between(3, 21)) & (df['inas_esc'] == 0), 'ic_rezedu'] = 0
    df.loc[(df['niv_ed'] == 3), 'ic_rezedu'] = 0
    df.loc[((df['anac_e'] >= 1982) & (df['anac_e'] <= 1997)) & (df['edad'] >= 16) &
           ((df['niv_ed'] >= 2) & (~df['niv_ed'].isna())), 'ic_rezedu'] = 0
    df.loc[(df['anac_e'] <= 1981) & (df['edad'] >= 16) &
           ((df['niv_ed'] >= 1) & (~df['niv_ed'].isna())), 'ic_rezedu'] = 0
    return df

def add_hli(df):
    df['hli'] = np.NAN
    df.loc[(df['hablaind'] == 1) & (df['edad'] >= 3), 'hli'] = 1
    df.loc[(df['hablaind'] == 2) & (df['edad'] >= 3), 'hli'] = 0
    return df

rezedu = (poblacion.copy()
          .pipe(convert_to_numeric)
          .pipe(filter_population)
          .pipe(add_birth_year)
          .pipe(add_inas_esc)
          .pipe(add_niv_ed)
          .pipe(add_ic_rezedu)
          .pipe(add_hli)
          [['folioviv', 'foliohog', 'numren', 'edad', 'anac_e', 'inas_esc', 'niv_ed', 'ic_rezedu', 'parentesco', 'hli']]
          )
```


#### II. Indicador de carencia por acceso a los servicios de salud  {.tabset .tabset-pills .top3-tiles}       

```{python}
#del [[trabajos]] # Eliminamos el data.frame "trabajos" 
ocupados = pd.read_csv(current_directory + "/Bases de datos/trabajos.csv", low_memory = False)
```

**Indicador de carencia por servicios de salud `ic_asalud`**  

Se considera en situaci贸n de carencia por acceso a servicios de salud a la poblaci贸n que:    
 
 1. No se encuentra inscrita al Seguro Popular* o afiliada a alguna instituci贸n  por prestaci贸n laboral, contrataci贸n voluntaria o afiliaci贸n de un familiar por parentesco directo a recibir servicios m茅dicos por alguna instituci贸n que los preste como: las instituciones de seguridad social (`IMSS`, `ISSSTE federal o estatal`, `Pemex`, `Ej茅rcito` o `Marina`), los servicios m茅dicos privados, u otra instituci贸n m茅dica.      
 
 - Se reporta la poblaci贸n que respondi贸 estar afiliado o inscrito al Seguro Popular, o que tiene derecho a los servicios del
 Instituto de Salud para el Bienestar (`INSABI`), lo anterior de acuerdo con el cuestionario de la ENIGH 2022.     
 

##### Opci贸n 1     
 
```{python}
#Convirtiendo variables string a numericas
ocupados[['subor', 'indep', 'tiene_suel','pago','id_trabajo']] = ocupados[['subor', 'indep', 'tiene_suel','pago','id_trabajo']].apply(pd.to_numeric, errors = 'coerce')

# Tipo de trabajador: identifica la poblaci贸n subordinada e independiente
ocupados['tipo_trab'] = np.NAN
# Subordinados
ocupados.loc[(ocupados['subor'] == 1), 'tipo_trab'] = 1
# Independientes que reciben un pago
ocupados.loc[(ocupados['subor'] == 2) & (ocupados['indep'] == 1) & (ocupados['tiene_suel'] == 1), 'tipo_trab'] = 2
ocupados.loc[(ocupados['subor'] == 2) & (ocupados['indep'] == 2) & (ocupados['pago'] == 1), 'tipo_trab'] = 2
#Independientes que no reciben un pago
ocupados.loc[(ocupados['subor'] == 2) & (ocupados['indep'] == 1) & (ocupados['tiene_suel'] == 2), 'tipo_trab'] = 3
ocupados.loc[(ocupados['subor'] == 2) & (ocupados['indep'] == 2) & ((ocupados['pago'] == 2) | (ocupados['pago'] == 3)), 'tipo_trab'] = 3

# Ocupaci贸n principal o secundaria
ocupados['ocupa'] = np.NAN
ocupados.loc[(ocupados['id_trabajo'] == 1), 'ocupa'] = 1
ocupados.loc[(ocupados['id_trabajo'] == 2), 'ocupa'] = 1

ocupados = ocupados[['folioviv', 'foliohog', 'numren', 'id_trabajo', 'tipo_trab', 'ocupa']]

# Distinci贸n de prestaciones en trabajo principal y secundario
ocupados = pd.pivot_table(ocupados, 
                          index = ['folioviv', 'foliohog', 'numren'], 
                          columns = 'id_trabajo', 
                          values = ['tipo_trab', 'ocupa'], 
                          aggfunc = np.sum, 
                          fill_value = 0)
                          
ocupados.columns = [f'{i}{j}' for i, j in ocupados.columns]
ocupados = ocupados.reset_index()

# Identificaci贸n de la poblaci贸n trabajadora (toda la que reporta al menos un empleo en la base de trabajos.csv)
ocupados['trab'] = 1
ocupados = ocupados[['folioviv', 'foliohog', 'numren', 'trab'] + [col for col in ocupados.columns if col.startswith('tipo_trab') or col.startswith('ocupa')]]
```

**Se guarda la base de datos** 
```{python}
ocupados.to_csv(current_directory + '/Output/Data/' + 'ocupados22.csv.csv', index = False)
```

**Indicador de carencia por acceso a los servicios de salud** 

```{python}
#Indicador de carencia por acceso a los servicios de salud
salud = poblacion.copy()
# Poblaci贸n objetivo: no se incluye a hu茅spedes ni trabajadores dom茅sticos
salud = salud.loc[~((salud['parentesco'] >= 400) & (salud['parentesco'] < 500) |
                    (salud['parentesco'] >= 700) & (salud['parentesco'] < 800))]

salud = pd.merge(salud, 
                  ocupados, 
                   on = ['folioviv', 'foliohog', 'numren'], 
                    how = 'left')

#Convirtiendo variables string a numericas
salud[['parentesco', 'trab', 'edad', 'act_pnea1', 'act_pnea2','ocupa1', 'atemed', 'inst_1', 'inst_2', 'inst_3', 'inst_4', 'inst_5', 'inst_6', 
       'inscr_1', 'inscr_2', 'inscr_3', 'inscr_4', 'inscr_5', 'inscr_6', 'inscr_7', 'asis_esc', 'pop_insabi', 'segvol_2']
      ] = salud[['parentesco', 'trab', 'edad', 'act_pnea1', 'act_pnea2','ocupa1', 'atemed', 'inst_1', 'inst_2', 'inst_3', 'inst_4', 'inst_5', 
                 'inst_6', 'inscr_1', 'inscr_2', 'inscr_3', 'inscr_4', 'inscr_5', 'inscr_6', 'inscr_7', 'asis_esc', 'pop_insabi', 'segvol_2']
                 ].apply(pd.to_numeric, errors = 'coerce')

# PEA (personas de 16 a帽os o m谩s)
salud['pea'] = np.NAN
salud.loc[(salud['trab'] == 1) & (salud['edad'] >= 16) & 
           (~salud['edad'].isna()), 'pea'] = 1 # PEA: ocupada
salud.loc[((salud['act_pnea1'] == 1) | (salud['act_pnea2'] == 1)) & 
           (salud['edad'] >= 16) & (~salud['edad'].isna()),'pea'] = 2 # PEA: desocupada
salud.loc[((salud['edad'] >= 16) & (~salud['edad'].isna()) &
           (((salud['act_pnea1'] != 1) | (salud['act_pnea1'].isna())) &
            ((salud['act_pnea2'] != 1) | (salud['act_pnea2'].isna()))) &
             (((salud['act_pnea1'] >= 2) & (salud['act_pnea1'] <= 6)) |
              ((salud['act_pnea2'] >= 2) & (salud['act_pnea2'] <= 6)))),'pea'] = 0 # PNEA
   
# Tipo de trabajo
## Ocupaci贸n principal
salud['tipo_trab1'] = np.where(salud['pea'] == 1, 
                                salud['tipo_trab1'], 
                                 salud['tipo_trab1']) # Depende de un patr贸n, jefe o superior 
salud['tipo_trab1'] = np.where((salud['pea'] == 0) | (salud['pea'] == 2), 
                                 np.NAN, 
                                  salud['tipo_trab1']) # No depende de un jefe y recibe o tiene asignado un sueldo
salud['tipo_trab1'] = np.where(salud['pea'].isna(), 
                                np.NAN, 
                                 salud['tipo_trab1']) # No depende de un jefe y no recibe o no tiene asignado un sueldo
## Ocupaci贸n secundaria
salud['tipo_trab2'] = np.where(salud['pea'] == 1, 
                                salud['tipo_trab2'], 
                                 salud['tipo_trab2']) # Depende de un patr贸n, jefe o superior
salud['tipo_trab2'] = np.where((salud['pea'] == 0) | (salud['pea'] == 2), 
                                 np.NAN, 
                                  salud['tipo_trab2']) # No depende de un jefe y recibe o tiene asignado un sueldo
salud['tipo_trab2'] = np.where(salud['pea'].isna(), 
                                np.NAN, 
                                 salud['tipo_trab2']) # No depende de un jefe y no recibe o no tiene asignado un sueldo

# Servicios m茅dicos prestaciones laborales
salud['smlab1'] = np.NAN
## Ocupaci贸n principal
salud.loc[(salud['ocupa1'] == 1), 'smlab1'] = 0 # Sin servicios m茅dicos
salud.loc[((salud['ocupa1'] == 1) & (salud['atemed'] == 1) &
           ((salud['inst_1'] == 1) | (salud['inst_2'] == 2) | (salud['inst_3'] == 3) | (salud['inst_4'] == 4)) & 
            (salud['inscr_1'] == 1), 'smlab1')] = 1 # Con servicios m茅dicos

## Ocupaci贸n secundaria
salud['smlab2'] = np.NAN
salud.loc[(salud['ocupa2'] == 1), 'smlab2'] = 0 # Sin servicios m茅dicos
salud.loc[((salud['ocupa2'] == 1) & (salud['atemed'] == 1) &
           ((salud['inst_1'] == 1) | (salud['inst_2'] == 2) | (salud['inst_3'] == 3) | (salud['inst_4'] == 4)) & 
            (salud['inscr_1'] == 1), 'smlab2')] = 1 # Con servicios m茅dicos

# Contrataci贸n voluntaria de servicios m茅dicos
salud['smcv'] = np.NAN
salud.loc[((salud['edad'] >= 12) & (~salud['edad'].isna())), 'smcv'] = 0 # No cuenta
salud.loc[((salud['atemed'] == 1) & ((salud['inst_1'] == 1) | 
           (salud['inst_2'] == 2) | (salud['inst_3'] == 3) | 
            (salud['inst_4'] == 4)) & (salud['inscr_6'] == 6) & 
             (salud['edad'] >= 12) & (~salud['edad'].isna())), 'smcv'] = 1 # S铆 cuenta

# Acceso directo a servicios de salud
salud['sa_dir'] = np.NAN
## Ocupaci贸n principal
salud.loc[((salud['tipo_trab1'] == 1) & (salud['smlab1'] == 1)), 'sa_dir'] = 1 # Con acceso
salud.loc[((salud['tipo_trab1'] == 2) & ((salud['smlab1'] == 1) | (salud['smcv'] == 1))), 'sa_dir'] = 1 # Con acceso
salud.loc[((salud['tipo_trab1'] == 3) & ((salud['smlab1'] == 1) | (salud['smcv'] == 1))), 'sa_dir'] = 1 # Con acceso

## Ocupaci贸n secundaria
salud.loc[((salud['tipo_trab2'] == 1) & (salud['smlab2'] == 1)), 'sa_dir'] = 1 # Con acceso
salud.loc[((salud['tipo_trab2'] == 2) & ((salud['smlab2'] == 1) | (salud['smcv'] == 1))), 'sa_dir'] = 1 # Con acceso
salud.loc[((salud['tipo_trab2'] == 3) & ((salud['smlab2'] == 1) | (salud['smcv'] == 1))), 'sa_dir'] = 1 # Con acceso
salud.loc[(salud['sa_dir'].isna()), 'sa_dir'] = 0 # Sin acceso

# N煤cleos familiares
salud['par'] = np.NAN
salud.loc[((salud['parentesco'] >= 100) & (salud['parentesco'] < 200)), 'par'] = 1 # Jefe o jefa del hogar
salud.loc[((salud['parentesco'] >= 200) & (salud['parentesco'] < 300)), 'par'] = 2 # C贸nyuge del  jefe/a
salud.loc[((salud['parentesco'] >= 300) & (salud['parentesco'] < 400)), 'par'] = 3 # Hijo del jefe/a
salud.loc[((salud['parentesco'] == 601)), 'par'] = 4 # Padre o Madre del jefe/a
salud.loc[((salud['parentesco'] == 615)), 'par'] = 5 # Suegro del jefe/a
salud.loc[(salud['par'].isna()), 'par'] = 6 # Sin acceso

# Asimismo, se utilizar谩 la informaci贸n relativa a la asistencia a la escuela
salud['inas_esc'] = np.NAN
salud.loc[((salud['asis_esc'] == 1)), 'inas_esc'] = 0 # S铆 asiste
salud.loc[((salud['asis_esc'] == 2)), 'inas_esc'] = 1 # No asiste

# En primer lugar se identifican los principales parentescos respecto a la jefatura del hogar y si ese miembro cuenta con acceso directo
salud['jef'] = np.NAN
salud.loc[((salud['par'] == 1) & (salud['sa_dir'] == 1)), 'jef'] = 1
salud.loc[((((salud['inst_2'] == 2) | (salud['inst_3'] == 3)) & (salud['inscr_6'] == 6)) &
           ((salud['inst_1'].isna()) & (salud['inst_4'].isna()) & (salud['inst_6'].isna())) &
            ((salud['inscr_1'].isna()) & (salud['inscr_2'].isna()) & (salud['inscr_3'].isna()) &
             (salud['inscr_4'].isna()) & (salud['inscr_5'].isna()) & (salud['inscr_7'].isna()))), 'jef'] = np.NAN

salud['cony'] = np.NAN
salud.loc[((salud['par'] == 2) & (salud['sa_dir'] == 1)), 'cony'] = 1
salud.loc[((((salud['inst_2'] == 2) | (salud['inst_3'] == 3)) & (salud['inscr_6'] == 6)) &
           ((salud['inst_1'].isna()) & (salud['inst_4'].isna()) & (salud['inst_6'].isna())) &
            ((salud['inscr_1'].isna()) & (salud['inscr_2'].isna()) & (salud['inscr_3'].isna()) &
             (salud['inscr_4'].isna()) & (salud['inscr_5'].isna()) & (salud['inscr_7'].isna()))), 'cony'] = np.NAN

salud['hijo'] = np.NAN
salud.loc[((salud['par'] == 3) & (salud['sa_dir'] == 1)), 'hijo'] = 1
salud.loc[((((salud['inst_2'] == 2) | (salud['inst_3'] == 3)) & (salud['inscr_6'] == 6)) &
           ((salud['inst_1'].isna()) & (salud['inst_4'].isna()) & (salud['inst_6'].isna())) &
            ((salud['inscr_1'].isna()) & (salud['inscr_2'].isna()) & (salud['inscr_3'].isna()) &
             (salud['inscr_4'].isna()) & (salud['inscr_5'].isna()) & (salud['inscr_7'].isna()))), 'hijo'] = np.NAN

salud = salud.groupby(['folioviv', 'foliohog']).apply(lambda x: pd.Series({'jef_sa': x['jef'].sum(skipna = True),
                                                                           'cony_sa': x['cony'].sum(skipna = True),
                                                                           'hijo_sa': x['hijo'].sum(skipna = True)})).reset_index().merge(salud, on = ['folioviv', 'foliohog'])

salud.loc[(salud['jef_sa'] > 0), 'jef_sa'] = 1 # Acceso directo a servicios de salud de la jefatura del hogar
salud.loc[(salud['cony_sa'] > 0), 'cony_sa'] = 1 # Acceso directo a servicios de salud del c贸nyuge de la jefatura del hogar
salud.loc[(salud['hijo_sa'] > 0), 'hijo_sa'] = 1 # Acceso directo a servicios de salud de hijos(as) de la jefatura del hogar

# Otros n煤cleos familiares: se identifica a la poblaci贸n con acceso a servicios de salud mediante otros n煤cleos familiares a trav茅s de la 
# afiliaci贸n o inscripci贸n a servicios de salud por alg煤n familiar dentro o fuera del hogar, muerte del asegurado o por contrataci贸n propia; 

salud['s_salud'] = np.NAN
salud.loc[((~salud['pop_insabi'].isna()) & (~salud['atemed'].isna())), 's_salud'] = 0 # No cuenta
salud.loc[((salud['atemed'] == 1) & ((salud['inst_1'] == 1) | (salud['inst_2'] == 2) | (salud['inst_3'] == 3) | (salud['inst_4'] == 4)) &
           ((salud['inscr_3'] == 3) | (salud['inscr_4'] == 4) | (salud['inscr_6'] == 6) | (salud['inscr_7'] == 7))), 's_salud'] = 1 # S铆 cuenta

# Indicador de carencia por servicios de salud
# Indicador de carencia por acceso a los servicios de salud
salud['ic_asalud'] = np.NAN

## Acceso directo
salud.loc[((salud['sa_dir'] == 1)), 'ic_asalud'] = 0 

## Parentesco directo: jefatura
salud.loc[((salud['par'] == 1) & (salud['cony_sa'] == 1)), 'ic_asalud'] = 0 # No presenta carencia
salud.loc[((salud['par'] == 1) & (salud['pea'] == 0) & (salud['hijo_sa'] == 1)), 'ic_asalud'] = 0 # No presenta carencia

## Parentesco directo: c贸nyuge
salud.loc[((salud['par'] == 2) & (salud['jef_sa'] == 1)), 'ic_asalud'] = 0 # No presenta carencia
salud.loc[((salud['par'] == 2) & (salud['pea'] == 0) & (salud['hijo_sa'] == 1)), 'ic_asalud'] = 0 # No presenta carencia

## Parentesco directo: descendientes
salud.loc[((salud['par'] == 3) & (salud['edad'] < 16) & (salud['jef_sa'] == 1)), 'ic_asalud'] = 0 # No presenta carencia
salud.loc[((salud['par'] == 3) & (salud['edad'] < 16) & (salud['cony_sa'] == 1)), 'ic_asalud'] = 0 # No presenta carencia
salud.loc[((salud['par'] == 3) & (salud['edad'].between(16, 25)) & (salud['inas_esc'] == 0) & (salud['jef_sa'] == 1)), 'ic_asalud'] = 0 # No presenta carencia
salud.loc[((salud['par'] == 3) & (salud['edad'].between(16, 25)) & (salud['inas_esc'] == 0) & (salud['cony_sa'] == 1)), 'ic_asalud'] = 0 # No presenta carencia

## Parentesco directo: ascendientes
salud.loc[((salud['par'] == 4) & (salud['pea'] == 0) & (salud['jef_sa'] == 1)), 'ic_asalud'] = 0 # No presenta carencia
salud.loc[((salud['par'] == 5) & (salud['pea'] == 0) & (salud['cony_sa'] == 1)), 'ic_asalud'] = 0 # No presenta carencia

## Otros n煤cleos familiares
salud.loc[((salud['s_salud'] == 1)), 'ic_asalud'] = 0 # No presenta carencia

## Acceso reportado
salud.loc[((salud['pop_insabi'] == 1) | 
           ((salud['pop_insabi'] == 2) & (salud['atemed'] == 1) & ((salud['inst_1'] == 1) | 
            (salud['inst_2'] == 2) | 
             (salud['inst_3'] == 3) | 
              (salud['inst_4'] == 4) | 
               (salud['inst_5'] == 5) | 
                (salud['inst_6'] == 6))) | 
                 (salud['segvol_2'] == 2)), 'ic_asalud'] = 0 # No presenta carencia
salud.loc[(salud['ic_asalud'].isna()), 'ic_asalud'] = 1 # Presenta carencia

# Poblaci贸n con presencia de discapacidad, sea f铆sica o mental
salud['discap'] = np.NAN
salud.loc[((salud['disc_camin'] == '3') | (salud['disc_camin'] == '4')), 'discap'] = 0 # Sin presencia de discapacidad
salud.loc[((salud['disc_ver'] == '3') | (salud['disc_ver'] == '4')), 'discap'] = 0 # Sin presencia de discapacidad
salud.loc[((salud['disc_brazo'] == '3') | (salud['disc_brazo'] == '4')), 'discap'] = 0 # Sin presencia de discapacidad
salud.loc[((salud['disc_apren'] == '3') | (salud['disc_apren'] == '4')), 'discap'] = 0 # Sin presencia de discapacidad
salud.loc[((salud['disc_oir'] == '3') | (salud['disc_oir'] == '4')), 'discap'] = 0 # Sin presencia de discapacidad
salud.loc[((salud['disc_vest'] == '3') | (salud['disc_vest'] == '4')), 'discap'] = 0 # Sin presencia de discapacidad
salud.loc[((salud['disc_habla'] == '3') | (salud['disc_habla'] == '4')), 'discap'] = 0 # Sin presencia de discapacidad
salud.loc[((salud['disc_acti'] == '3') | (salud['disc_acti'] == '4')), 'discap'] = 0 # Sin presencia de discapacidad
salud.loc[((salud['disc_camin'] == '&') | (salud['disc_ver'] == '&') |
          (salud['disc_brazo'] == '&') | (salud['disc_apren'] == '&') |
          (salud['disc_oir'] == '&') | (salud['disc_vest'] == '&') &
          (salud['disc_habla'] == '&') | (salud['disc_acti'] == '&')), 'discap'] = np.NAN # Sin presencia de discapacidad
salud.loc[((salud['disc_camin'] == '1') | (salud['disc_camin'] == '2')), 'discap'] = 1 # Con presencia de discapacidad
salud.loc[((salud['disc_ver'] == '1') | (salud['disc_ver'] == '2')), 'discap'] = 1 # Con presencia de discapacidad
salud.loc[((salud['disc_brazo'] == '1') | (salud['disc_brazo'] == '2')), 'discap'] = 1 # Con presencia de discapacidad
salud.loc[((salud['disc_apren'] == '1') | (salud['disc_apren'] == '2')), 'discap'] = 1 # Con presencia de discapacidad
salud.loc[((salud['disc_oir'] == '1') | (salud['disc_oir'] == '2')), 'discap'] = 1 # Con presencia de discapacidad
salud.loc[((salud['disc_vest'] == '1') | (salud['disc_vest'] == '2')), 'discap'] = 1 # Con presencia de discapacidad
salud.loc[((salud['disc_habla'] == '1') | (salud['disc_habla'] == '2')), 'discap'] = 1 # Con presencia de discapacidad
salud.loc[((salud['disc_acti'] == '1') | (salud['disc_acti'] == '2')), 'discap'] = 1 # Con presencia de discapacidad

salud = salud[['folioviv', 'foliohog', 'numren', 'sexo', 'pop_insabi', 'atemed', 'inst_1', 'inst_2', 'inst_3', 'inst_4', 'inst_5', 'inst_6', 
               'inscr_1', 'inscr_2', 'inscr_3', 'inscr_4', 'inscr_5', 'inscr_6', 'inscr_7', 'inscr_8', 'segvol_1', 'segvol_2', 'segvol_3', 
               'segvol_4', 'segvol_5', 'segvol_6', 'segvol_7', 'sa_dir', 'jef_sa', 'cony_sa', 'hijo_sa', 'ic_asalud', 'discap']]
```

##### Opci贸n 2    

```{python}
import pandas as pd
import numpy as np

def convert_to_numeric(df):
    cols_to_convert = ['subor', 'indep', 'tiene_suel', 'pago', 'id_trabajo']
    df[cols_to_convert] = df[cols_to_convert].apply(pd.to_numeric, errors = 'coerce')
    return df

def add_tipo_trab(df):
    df['tipo_trab'] = np.NAN
    df.loc[(df['subor'] == 1), 'tipo_trab'] = 1
    df.loc[(df['subor'] == 2) & (df['indep'] == 1) & (df['tiene_suel'] == 1), 'tipo_trab'] = 2
    df.loc[(df['subor'] == 2) & (df['indep'] == 2) & (df['pago'] == 1), 'tipo_trab'] = 2
    df.loc[(df['subor'] == 2) & (df['indep'] == 1) & (df['tiene_suel'] == 2), 'tipo_trab'] = 3
    df.loc[(df['subor'] == 2) & (df['indep'] == 2) & ((df['pago'] == 2) | (df['pago'] == 3)), 'tipo_trab'] = 3
    return df

def add_ocupa(df):
    df['ocupa'] = np.NAN
    df.loc[df['id_trabajo'].isin([1, 2]), 'ocupa'] = 1
    return df

def pivot_and_finalize(df):
    df = df[['folioviv', 'foliohog', 'numren', 'id_trabajo', 'tipo_trab', 'ocupa']]
    df = pd.pivot_table(df, index=['folioviv', 'foliohog', 'numren'], columns='id_trabajo', 
                        values=['tipo_trab', 'ocupa'], aggfunc=np.sum, fill_value=0)
    df.columns = [f'{i}{j}' for i, j in df.columns]
    df = df.reset_index()
    df['trab'] = 1
    df = df[['folioviv', 'foliohog', 'numren', 'trab'] + 
            [col for col in df.columns if col.startswith('tipo_trab') or col.startswith('ocupa')]]
    return df

ocupados = (ocupados.copy()
            .pipe(convert_to_numeric)
            .pipe(add_tipo_trab)
            .pipe(add_ocupa)
            .pipe(pivot_and_finalize))
```


**Indicador de carencia por acceso a los servicios de salud** 

```{python}
# Funciones auxiliares
def filtrar_salud(df):
    return df.loc[~(
        ((df['parentesco'] >= 400) & (df['parentesco'] < 500)) |
        ((df['parentesco'] >= 700) & (df['parentesco'] < 800))
    )]

def convertir_numericas(df):
    cols_numericas = ['parentesco', 'trab', 'edad', 'act_pnea1', 'act_pnea2', 'ocupa1', 'atemed', 
                      'inst_1', 'inst_2', 'inst_3', 'inst_4', 'inst_5', 'inst_6', 
                      'inscr_1', 'inscr_2', 'inscr_3', 'inscr_4', 'inscr_5', 'inscr_6', 'inscr_7', 
                      'asis_esc', 'pop_insabi', 'segvol_2']
    df[cols_numericas] = df[cols_numericas].apply(pd.to_numeric, errors='coerce')
    return df

def crear_pea(df):
    df['pea'] = np.nan
    df.loc[(df['trab'] == 1) & (df['edad'] >= 16), 'pea'] = 1
    df.loc[((df['act_pnea1'] == 1) | (df['act_pnea2'] == 1)) & (df['edad'] >= 16), 'pea'] = 2
    df.loc[(df['edad'] >= 16) & (
        ((df['act_pnea1'] >= 2) & (df['act_pnea1'] <= 6)) |
        ((df['act_pnea2'] >= 2) & (df['act_pnea2'] <= 6))
    ), 'pea'] = 0
    return df

def procesar_tipos_trabajo(df):
    df['tipo_trab1'] = np.where(df['pea'] == 1, df['tipo_trab1'], np.nan)
    df['tipo_trab1'] = np.where((df['pea'] == 0) | (df['pea'] == 2), np.nan, df['tipo_trab1'])
    df['tipo_trab2'] = np.where(df['pea'] == 1, df['tipo_trab2'], np.nan)
    df['tipo_trab2'] = np.where((df['pea'] == 0) | (df['pea'] == 2), np.nan, df['tipo_trab2'])
    return df

def procesar_servicios_medicos(df):
    smlab1 = ((df['ocupa1'] == 1) & (df['atemed'] == 1) &
              ((df['inst_1'] == 1) | (df['inst_2'] == 2) | (df['inst_3'] == 3) | (df['inst_4'] == 4)) &
              (df['inscr_1'] == 1))
    smlab2 = ((df['ocupa2'] == 1) & (df['atemed'] == 1) &
              ((df['inst_1'] == 1) | (df['inst_2'] == 2) | (df['inst_3'] == 3) | (df['inst_4'] == 4)) &
              (df['inscr_1'] == 1))
    smcv = (df['edad'] >= 12) & (df['atemed'] == 1) & ((df['inst_1'] == 1) | (df['inst_2'] == 2) |
                                                      (df['inst_3'] == 3) | (df['inst_4'] == 4)) & (df['inscr_6'] == 6)
    df['smlab1'] = np.where(smlab1, 1, np.nan)
    df['smlab2'] = np.where(smlab2, 1, np.nan)
    df['smcv'] = np.where(smcv, 1, np.nan)
    return df
  
# Define una funci贸n para calcular las variables auxiliares
def calcular_variables_auxiliares(data):
    data['inas_esc'] = np.where(data['asis_esc'] == 1, 0, np.where(data['asis_esc'] == 2, 1, np.nan))
    data['jef'] = np.where((data['par'] == 1) & (data['sa_dir'] == 1), 1, np.nan)
    data['cony'] = np.where((data['par'] == 2) & (data['sa_dir'] == 1), 1, np.nan)
    data['hijo'] = np.where((data['par'] == 3) & (data['sa_dir'] == 1), 1, np.nan)
    
    return data

# Define una funci贸n para realizar el agrupamiento y c谩lculo de las variables relacionadas con acceso a servicios de salud
def calcular_acceso_servicios(data):
    acceso_directo = data.groupby(['folioviv', 'foliohog']).agg(
        jef_sa=('jef', lambda x: 1 if x.sum() > 0 else 0),
        cony_sa=('cony', lambda x: 1 if x.sum() > 0 else 0),
        hijo_sa=('hijo', lambda x: 1 if x.sum() > 0 else 0)
    ).reset_index()
    
    data = pd.merge(data, acceso_directo, on=['folioviv', 'foliohog'], how='left')
    
    data['jef_sa'] = np.where(data['jef_sa'] > 0, 1, 0)
    data['cony_sa'] = np.where(data['cony_sa'] > 0, 1, 0)
    data['hijo_sa'] = np.where(data['hijo_sa'] > 0, 1, 0)
    
    return data
```

```{python}
# Cargar datos originales
salud = pobla.copy()

# Aplicar transformaciones encadenadas
salud = salud.pipe(filtrar_salud)\
            .pipe(convertir_numericas)\
            .pipe(crear_pea)\
            .pipe(procesar_tipos_trabajo)\
            .pipe(procesar_servicios_medicos)
            
# Usa funciones de tuber铆as para encadenar las operaciones
salud_procesado = (
    poblacion.copy()
    .pipe(calcular_variables_auxiliares)
    .pipe(calcular_acceso_servicios)
)

```

#### III. Indicador de carencia por acceso a la seguridad social {.tabset .tabset-pills .top3-tiles}  

##### Opci贸n 1 {.tabset .tabset-pills .top4-tiles} 

###### Prestaciones laborales

```{python}
# Prestaciones laborales
trabajos = pd.read_csv(current_directory + "/Bases de datos/trabajos.csv", low_memory = False) 
```

```{python}
prestaciones = trabajos.copy()

#Convirtiendo variables string a numericas
prestaciones[['subor', 'indep', 'tiene_suel', 'pago', 'pres_8', 'id_trabajo']] = prestaciones[['subor', 'indep', 'tiene_suel', 'pago', 'pres_8', 'id_trabajo']
                                                                                             ].apply(pd.to_numeric, errors = 'coerce')

# Tipo de trabajador: identifica la poblaci贸n subordinada e independiente
prestaciones['tipo_trab'] = np.NAN
## Subordinados
prestaciones.loc[(prestaciones['subor'] == 1), 'tipo_trab'] = 1

## Independientes que reciben un pago
prestaciones.loc[((prestaciones['subor'] == 2) & (prestaciones['indep'] == 1) & (prestaciones['tiene_suel'] == 1)), 'tipo_trab'] = 2
prestaciones.loc[((prestaciones['subor'] == 2) & (prestaciones['indep'] == 2) & (prestaciones['pago'] == 1)), 'tipo_trab'] = 2

## Independientes que no reciben un pago
prestaciones.loc[((prestaciones['subor'] == 2) & (prestaciones['indep'] == 1) & (prestaciones['tiene_suel'] == 2)), 'tipo_trab'] = 3
prestaciones.loc[((prestaciones['subor'] == 2) & (prestaciones['indep'] == 2) & ((prestaciones['pago'] == 2) | (prestaciones['pago'] == 3))), 'tipo_trab'] = 3
 

# Ahorro para el retiro o pensi贸n para la vejez (SAR, Afore)
prestaciones['aforlab'] = np.NAN
prestaciones.loc[(prestaciones['pres_8'].isna()), 'aforlab'] = 0 
prestaciones.loc[(prestaciones['pres_8'] == 8), 'aforlab'] = 1 

# Ocupaci贸n principal o secundaria
prestaciones['ocupa'] = np.NAN
prestaciones.loc[(prestaciones['id_trabajo'] == 1), 'ocupa'] = 1 
prestaciones.loc[(prestaciones['id_trabajo'] == 2), 'ocupa'] = 1 

# Distinci贸n de prestaciones en trabajo principal y secundario
prestaciones = prestaciones[['folioviv', 'foliohog', 'numren', 'id_trabajo', 'tipo_trab', 'aforlab', 'ocupa']]

prestaciones = pd.pivot_table(prestaciones, 
                               index = ['folioviv', 'foliohog', 'numren'], 
                                columns = 'id_trabajo', 
                                 values = ['tipo_trab', 'aforlab', 'ocupa'], 
                                  aggfunc = np.sum, 
                                   fill_value = 0)
prestaciones.columns = [f'{i}{j}' for i, j in prestaciones.columns]
prestaciones = prestaciones.reset_index()

#Identificaci贸n de la poblaci贸n trabajadora (toda la que reporta al menos un empleo en la base de trabajos.csv)
prestaciones['trab'] = 1
prestaciones = prestaciones[['folioviv', 'foliohog', 'numren', 'trab', 'tipo_trab1', 'tipo_trab2', 'aforlab1', 'aforlab2', 'ocupa1', 'ocupa2']]
```


**Se guarda la base de datos** 
```{python}
prestaciones.to_csv(current_directory + '/Output/Data/' + '/prestaciones22.csv.csv', index = False)
```

###### Ingresos por jubilaciones o pensiones

```{python}
# Ingresos por jubilaciones o pensiones
pensiones = pd.read_csv(current_directory + "/Bases de datos/ingresos.csv", low_memory = False)

pensiones = pensiones[((pensiones['clave'] == 'P032') | (pensiones['clave'] == 'P033') | 
                       (pensiones['clave'] == 'P104') | (pensiones['clave'] == 'P045'))]
```


```{python}
# Definici贸n de los deflactores 2022 
dic21 =	0.9475376203	
ene22 =	0.9531433002
feb22 =	0.9610510246	
mar22 =	0.9705661414	
abr22 =	0.9758164180	
may22 =	0.9775368933
jun22 =	0.9857919437	
jul22 =	0.9930938669
ago22 =	1.0000000000
sep22 =	1.0062034038
oct22 =	1.0118979346
nov22 =	1.0177217030
dic22 =	1.0216069077
```

```{python}
#Convirtiendo variables string a numericas
pensiones[['mes_1', 'mes_2', 'mes_3', 'mes_4', 'mes_5', 'mes_6', 'ing_1', 'ing_2', 'ing_3', 'ing_4', 'ing_5', 'ing_6']
          ] = pensiones[['mes_1', 'mes_2', 'mes_3', 'mes_4', 'mes_5', 'mes_6', 'ing_1', 'ing_2', 'ing_3', 'ing_4', 'ing_5', 'ing_6']].apply(pd.to_numeric, errors = 'coerce')
          
# Se deflactan los ingresos por jubilaciones, pensionesiones y programas de adultos mayores de acuerdo con el mes de levantamiento
pensiones['ing_6'] = np.where(pensiones['mes_6'].isna(), pensiones['ing_6'] ,
                      np.where(pensiones['mes_6'] == 2, pensiones['ing_6'] / feb22,
                       np.where(pensiones['mes_6'] == 3, pensiones['ing_6'] / mar22,
                        np.where(pensiones['mes_6'] == 4, pensiones['ing_6'] / abr22,
                         pensiones['ing_6'] / may22))))
pensiones['ing_5'] = np.where(pensiones['mes_5'].isna(), pensiones['ing_5'] ,
                      np.where(pensiones['mes_5'] == 3, pensiones['ing_5'] / mar22,
                       np.where(pensiones['mes_5'] == 4, pensiones['ing_5'] / abr22,
                        np.where(pensiones['mes_5'] == 5, pensiones['ing_5'] / may22,
                         pensiones['ing_5'] / jun22))))
pensiones['ing_4'] = np.where(pensiones['mes_4'].isna(), pensiones['ing_4'] ,
                      np.where(pensiones['mes_4'] == 4, pensiones['ing_4'] / abr22,
                       np.where(pensiones['mes_4'] == 5, pensiones['ing_4'] / may22,
                        np.where(pensiones['mes_4'] == 6, pensiones['ing_4'] / jun22,
                         pensiones['ing_4'] / jul22 ))))
pensiones['ing_3'] = np.where(pensiones['mes_3'].isna(), pensiones['ing_3'] ,
                      np.where(pensiones['mes_3'] == 5, pensiones['ing_3'] / may22,
                       np.where(pensiones['mes_3'] == 6, pensiones['ing_3'] / jun22,
                        np.where(pensiones['mes_3'] == 7, pensiones['ing_3'] / jul22,
                         pensiones['ing_3'] / ago22))))
pensiones['ing_2'] = np.where(pensiones['mes_2'].isna(), pensiones['ing_2'] ,
                      np.where(pensiones['mes_2'] == 6, pensiones['ing_2'] / jun22,
                       np.where(pensiones['mes_2'] == 7, pensiones['ing_2'] / jul22,
                        np.where(pensiones['mes_2'] == 8, pensiones['ing_2'] / ago22,
                         pensiones['ing_2'] / sep22))))
pensiones['ing_1'] = np.where(pensiones['mes_1'].isna(), pensiones['ing_1'] ,
                      np.where(pensiones['mes_1'] == 7, pensiones['ing_1'] / jul22,
                       np.where(pensiones['mes_1'] == 8, pensiones['ing_1'] / ago22,
                        np.where(pensiones['mes_1'] == 9, pensiones['ing_1'] / sep22,
                         pensiones['ing_1'] / oct22 ))))

# Ingreso promedio mensual por programas de adultos mayores
pensiones['ing_pam'] = np.where((pensiones['clave'] == 'P104') | (pensiones['clave'] == 'P045'),
                                  np.apply_along_axis(np.mean, 1, pensiones[['ing_1', 'ing_2', 'ing_3', 'ing_4', 'ing_5', 'ing_6']]), 0)
# Ingreso promedio mensual por jubilaciones y pensiones
pensiones['ing_pens'] = np.where((pensiones['clave'] == 'P032') | (pensiones['clave'] == 'P033'),
                                   np.apply_along_axis(np.mean, 1, pensiones[['ing_1', 'ing_2', 'ing_3', 'ing_4', 'ing_5', 'ing_6']]), 0)

pensiones = pensiones.groupby(['folioviv', 'foliohog', 'numren'])[['ing_pens', 'ing_pam']].sum(numeric_only = True)
pensiones = pensiones.reset_index()
```


**Se guarda la base de datos** 
```{python}
pensiones.to_csv(current_directory + '/Output/Data/' + '/pensiones22.csv.csv', index = False)
```


###### Construcci贸n del indicador

**Indicador de carencia por acceso a la seguridad social** 

Se encuentra en situaci贸n de carencia por acceso a la seguridad social a la poblaci贸n que:    
1. No disponga de acceso directo a la seguridad social.   
2. No cuente con parentesco directo con alguna persona dentro del hogar que tenga acceso directo.    
3. No recibe servicios m茅dicos por parte de alg煤n familiar dentro o fuera del hogar, por muerte del asegurado o por contrataci贸n propia.  
4. No recibe ingreso por parte de un programa de adultos mayores donde el monto sea mayor o igual al valor promedio de la canasta alimentaria rural y urbana.    

```{python}
# Valor monetario de las l铆neas de pobreza extrema por ingresos rural y urbana
lp1_urb = 2086.21
lp1_rur = 1600.18
lp_pam = (lp1_urb + lp1_rur)/2
```

 
 
```{python}
# Construcci贸n del indicador
seguridad_social = poblacion.copy()

# Poblaci贸n objetivo: no se incluye a hu茅spedes ni trabajadores dom茅sticos
seguridad_social = seguridad_social[~((seguridad_social['parentesco'] >= 400) & (seguridad_social['parentesco'] < 500) |
                   (seguridad_social['parentesco'] >= 700) & (seguridad_social['parentesco'] < 800))]

# Integraci贸n de bases
seguridad_social = pd.merge(seguridad_social, prestaciones, 
                             on = ['folioviv', 'foliohog', 'numren'], 
                              how = 'left')
seguridad_social = pd.merge(seguridad_social, pensiones, 
                    on = ['folioviv', 'foliohog', 'numren'], 
                     how = 'left')

#Convirtiendo variables string a numericas
seguridad_social[['parentesco', 'trab', 'edad', 'act_pnea1', 'act_pnea2','ocupa1', 'atemed', 'trabajo_mp',
                  'inst_1', 'inst_2', 'inst_3', 'inst_4', 'inst_5', 'inst_6', 'inscr_1', 'inscr_2', 'inscr_3', 
                  'inscr_4', 'inscr_5', 'inscr_6', 'inscr_7', 'asis_esc', 'pop_insabi', 'segvol_1']
                 ] = seguridad_social[['parentesco', 'trab', 'edad', 'act_pnea1', 'act_pnea2','ocupa1', 'atemed', 'trabajo_mp',
                                       'inst_1', 'inst_2', 'inst_3', 'inst_4', 'inst_5', 'inst_6', 'inscr_1', 'inscr_2', 'inscr_3', 
                                       'inscr_4', 'inscr_5', 'inscr_6', 'inscr_7', 'asis_esc', 'pop_insabi', 'segvol_1']].apply(pd.to_numeric, errors = 'coerce')

# PEA (personas de 16 a帽os o m谩s)
seguridad_social['pea'] = np.NAN
seguridad_social.loc[(seguridad_social['trab'] == 1) & (seguridad_social['edad'] >= 16) & 
                      (~seguridad_social['edad'].isna()), 'pea'] = 1 # PEA: ocupada
seguridad_social.loc[((seguridad_social['act_pnea1'] == 1) | (seguridad_social['act_pnea2'] == 1)) & 
                      (seguridad_social['edad'] >= 16) & (~seguridad_social['edad'].isna()), 'pea'] = 2 # PEA: desocupada
seguridad_social.loc[((seguridad_social['edad'] >= 16) & (~seguridad_social['edad'].isna()) &
                      (((seguridad_social['act_pnea1'] != 1) | (seguridad_social['act_pnea1'].isna())) &
                       ((seguridad_social['act_pnea2'] != 1) | (seguridad_social['act_pnea2'].isna()))) &
                        (((seguridad_social['act_pnea1'] >= 2) & (seguridad_social['act_pnea1'] <= 6)) |
                         ((seguridad_social['act_pnea2'] >= 2) & (seguridad_social['act_pnea2'] <= 6)))), 'pea'] = 0 # PNEA

# Acceso directo a la seguridad social
## Ocupaci贸n principal
seguridad_social['tipo_trab1'] = np.where(seguridad_social['pea'] == 1, 
                                           seguridad_social['tipo_trab1'], 
                                            seguridad_social['tipo_trab1']) # Depende de un patr贸n, jefe o superior 
seguridad_social['tipo_trab1'] = np.where((seguridad_social['pea'] == 0) | (seguridad_social['pea'] == 2), 
                                            np.NAN, 
                                             seguridad_social['tipo_trab1']) # No depende de un jefe y recibe o tiene asignado un sueldo
seguridad_social['tipo_trab1'] = np.where(seguridad_social['pea'].isna(), 
                                           np.NAN, 
                                            seguridad_social['tipo_trab1']) # No depende de un jefe y no recibe o no tiene asignado un sueldo
## Ocupaci贸n secundaria
seguridad_social['tipo_trab2'] = np.where(seguridad_social['pea'] == 1, 
                                           seguridad_social['tipo_trab2'], 
                                            seguridad_social['tipo_trab2']) # Depende de un patr贸n, jefe o superior
seguridad_social['tipo_trab2'] = np.where((seguridad_social['pea'] == 0) | (seguridad_social['pea'] == 2), 
                                            np.NAN, 
                                             seguridad_social['tipo_trab2']) # No depende de un jefe y recibe o tiene asignado un sueldo
seguridad_social['tipo_trab2'] = np.where(seguridad_social['pea'].isna(), 
                                           np.NAN, 
                                            seguridad_social['tipo_trab2']) # No depende de un jefe y no recibe o no tiene asignado un sueldo
## Jubilados y pensionados
seguridad_social['jub'] = np.NAN
seguridad_social.loc[((seguridad_social['trabajo_mp'] == 2) & ((seguridad_social['act_pnea1'] == 2) | 
                      (seguridad_social['act_pnea2'] == 2))), 'jub'] = 1 # Poblaci贸n pensionada o jubilada
seguridad_social.loc[((seguridad_social['ing_pens'] > 0) & (~seguridad_social['ing_pens'].isna())), 'jub'] = 1 # Poblaci贸n pensionada o jubilada
seguridad_social.loc[(seguridad_social['inscr_2'] == 2), 'jub'] = 1 # Poblaci贸n pensionada o jubilada
seguridad_social.loc[(seguridad_social['jub'].isna()), 'jub'] = 0 # Poblaci贸n no pensionada o jubilada

# Prestaciones b谩sicas

# Prestaciones laborales (Servicios m茅dicos)
## Ocupaci贸n principal
seguridad_social['smlab1'] = np.NAN
seguridad_social.loc[(seguridad_social['ocupa1'] == 1), 'smlab1'] = 0 # Con servicios m茅dicos
seguridad_social.loc[((seguridad_social['ocupa1'] == 1) & (seguridad_social['atemed'] == 1) & 
                      ((seguridad_social['inst_1'] == 1) | (seguridad_social['inst_2'] == 2) | 
                       (seguridad_social['inst_3'] == 3) | (seguridad_social['inst_4'] == 4)) & 
                        (seguridad_social['inscr_1'] == 1)), 'smlab1'] = 1 # Sin servicios m茅dicos
## Ocupaci贸n secundaria
seguridad_social['smlab2'] = np.NAN
seguridad_social.loc[(seguridad_social['ocupa2'] == 1), 'smlab2'] = 0 # Con servicios m茅dicos
seguridad_social.loc[((seguridad_social['ocupa2'] == 1) & (seguridad_social['atemed'] == 1) & 
                      ((seguridad_social['inst_1'] == 1) | (seguridad_social['inst_2'] == 2) | 
                       (seguridad_social['inst_3'] == 3) | (seguridad_social['inst_4'] == 4)) & 
                        (seguridad_social['inscr_1'] == 1)), 'smlab2'] = 1 # Sin servicios m茅dicos

# Contrataci贸n voluntaria: servicios m茅dicos y ahorro para el retiro o pensi贸n para la vejez (SAR, Afore, Haber de retiro)
## Servicios m茅dicos
seguridad_social['smcv'] = np.NAN
seguridad_social.loc[((seguridad_social['edad'] >= 12) & (~seguridad_social['edad'].isna())), 'smcv'] = 0 # No cuenta
seguridad_social.loc[((seguridad_social['atemed'] == 1) & ((seguridad_social['inst_1'] == 1) |
                      (seguridad_social['inst_2'] == 2) | (seguridad_social['inst_3'] == 3) |
                       (seguridad_social['inst_4'] == 4)) & (seguridad_social['inscr_6'] == 6) & 
                        ((seguridad_social['edad'] >= 12) & (~seguridad_social['edad'].isna()))), 'smcv'] = 1 # S铆 cuenta
                        
## SAR o Afore
seguridad_social['aforecv'] = np.NAN              
seguridad_social.loc[((seguridad_social['segvol_1'].isna()) & ((seguridad_social['edad'] >= 12) & 
                      (~seguridad_social['edad'].isna()))), 'aforecv'] = 0 # No cuenta    
seguridad_social.loc[((seguridad_social['segvol_1'] == 1) & ((seguridad_social['edad'] >= 12) & 
                      (~seguridad_social['edad'].isna()))), 'aforecv'] = 1 # S铆 cuenta 
                      
## Acceso directo a la seguridad social
seguridad_social['ss_dir'] = np.NAN
seguridad_social.loc[(seguridad_social['ss_dir'].isna()), 'ss_dir'] = 0 # Sin acceso

## Ocupaci贸n principal
seguridad_social.loc[((seguridad_social['tipo_trab1'] == 1) & (seguridad_social['smlab1'] == 1)), 'ss_dir'] = 1 # Con acceso
seguridad_social.loc[((seguridad_social['tipo_trab1'] == 2) & ((seguridad_social['smlab1'] == 1) |
                      (seguridad_social['smcv'] == 1)) & ((seguridad_social['aforlab1'] == 1) | 
                       (seguridad_social['aforecv'] == 1))), 'ss_dir'] = 1 # Con acceso
seguridad_social.loc[((seguridad_social['tipo_trab1'] == 3) & ((seguridad_social['smlab1'] == 1) | 
                       (seguridad_social['smcv'] == 1)) & (seguridad_social['aforecv'] == 1)), 'ss_dir'] = 1 # Con acceso

## Ocupaci贸n secundaria
seguridad_social.loc[((seguridad_social['tipo_trab2'] == 1) & (seguridad_social['smlab2'] == 1)), 'ss_dir'] = 1 # Con acceso
seguridad_social.loc[((seguridad_social['tipo_trab2'] == 2) & ((seguridad_social['smlab2'] == 1) | 
                      (seguridad_social['smcv'] == 1)) & ((seguridad_social['aforlab2'] == 1) | 
                       (seguridad_social['aforecv'] == 1))), 'ss_dir'] = 1 # Con acceso
seguridad_social.loc[((seguridad_social['tipo_trab2'] == 3) & ((seguridad_social['smlab2'] == 1) | 
                       (seguridad_social['smcv'] == 1)) & (seguridad_social['aforecv'] == 1)), 'ss_dir'] = 1 # Con acceso   

## Jubilados y pensionados
seguridad_social.loc[(seguridad_social['jub'] == 1), 'ss_dir'] = 1 # Con acceso 

## N煤cleos familiares   
seguridad_social['par'] = np.NAN
seguridad_social.loc[((seguridad_social['parentesco'] >= 100) & (seguridad_social['parentesco'] < 200)), 'par'] = 1 # Jefe o jefa del hogar
seguridad_social.loc[((seguridad_social['parentesco'] >= 200) & (seguridad_social['parentesco'] < 300)), 'par'] = 2 # C贸nyuge del  jefe/a
seguridad_social.loc[((seguridad_social['parentesco'] >= 300) & (seguridad_social['parentesco'] < 400)), 'par'] = 3 # Hijo del jefe/a
seguridad_social.loc[((seguridad_social['parentesco'] == 601)), 'par'] = 4 # Padre o Madre del jefe/a
seguridad_social.loc[((seguridad_social['parentesco'] == 615)), 'par'] = 5 # Suegro del jefe/a
seguridad_social.loc[(seguridad_social['par'].isna()), 'par'] = 6 # Sin acceso

# Asimismo, se utilizar谩 la informaci贸n relativa a la asistencia a la escuela
seguridad_social['inas_esc'] = np.NAN
seguridad_social.loc[((seguridad_social['asis_esc'] == 1)), 'inas_esc'] = 0 # S铆 asiste
seguridad_social.loc[((seguridad_social['asis_esc'] == 2)), 'inas_esc'] = 1 # No asiste

# En primer lugar se identifican los principales parentescos respecto a la jefatura del hogar y si ese miembro cuenta con acceso directo
seguridad_social['jef'] = np.NAN
seguridad_social.loc[((seguridad_social['par'] == 1) & (seguridad_social['ss_dir'] == 1)), 'jef'] = 1
seguridad_social.loc[((((seguridad_social['inst_2'] == 2) | (seguridad_social['inst_3'] == 3)) & (seguridad_social['inscr_6'] == 6)) & 
                      ((seguridad_social['inst_1'].isna()) & (seguridad_social['inst_4'].isna()) & (seguridad_social['inst_6'].isna())) &
                       ((seguridad_social['inscr_1'].isna()) & (seguridad_social['inscr_2'].isna()) & (seguridad_social['inscr_3'].isna()) &
                        (seguridad_social['inscr_4'].isna()) & (seguridad_social['inscr_5'].isna()) & (seguridad_social['inscr_7'].isna()))), 'jef'] = np.NAN

seguridad_social['cony'] = np.NAN
seguridad_social.loc[((seguridad_social['par'] == 2) & (seguridad_social['ss_dir'] == 1)), 'cony'] = 1
seguridad_social.loc[((((seguridad_social['inst_2'] == 2) | (seguridad_social['inst_3'] == 3)) & (seguridad_social['inscr_6'] == 6)) &
                      ((seguridad_social['inst_1'].isna()) & (seguridad_social['inst_4'].isna()) & (seguridad_social['inst_6'].isna())) &
                       ((seguridad_social['inscr_1'].isna()) & (seguridad_social['inscr_2'].isna()) & (seguridad_social['inscr_3'].isna()) &
                        (seguridad_social['inscr_4'].isna()) & (seguridad_social['inscr_5'].isna()) & (seguridad_social['inscr_7'].isna()))), 'cony'] = np.NAN

seguridad_social['hijo'] = np.NAN
seguridad_social.loc[((seguridad_social['par'] == 3) & (seguridad_social['ss_dir'] == 1) & (seguridad_social['jub'] == 1) & 
                      ((seguridad_social['edad'] > 25) & (~seguridad_social['edad'].isna()))), 'hijo'] = 1
seguridad_social.loc[((seguridad_social['par'] == 3) & (seguridad_social['ss_dir'] == 1) & (seguridad_social['jub'] == 0)), 'hijo'] = 1
seguridad_social.loc[((((seguridad_social['inst_2'] == 2) | (seguridad_social['inst_3'] == 3)) & (seguridad_social['inscr_6'] == 6)) &
                      ((seguridad_social['inst_1'].isna()) & (seguridad_social['inst_4'].isna()) & (seguridad_social['inst_6'].isna())) &
                       ((seguridad_social['inscr_1'].isna()) & (seguridad_social['inscr_2'].isna()) & (seguridad_social['inscr_3'].isna()) &
                        (seguridad_social['inscr_4'].isna()) & (seguridad_social['inscr_5'].isna()) & (seguridad_social['inscr_7'].isna()))), 'hijo'] = np.NAN

seguridad_social = seguridad_social.groupby(['folioviv', 'foliohog']
                                           ).apply(lambda x: pd.Series({'jef_ss': x['jef'].sum(skipna=True),
                                                                        'cony_ss': x['cony'].sum(skipna=True),
                                                                        'hijo_ss': x['hijo'].sum(skipna=True)})
                                                                      ).reset_index().merge(seguridad_social, 
                                                                                             on = ['folioviv', 'foliohog'])

seguridad_social.loc[(seguridad_social['jef_ss'] > 0), 'jef_ss'] = 1 # Acceso directo a servicios de salud de la jefatura del hogar
seguridad_social.loc[(seguridad_social['cony_ss'] > 0), 'cony_ss'] = 1 # Acceso directo a servicios de salud del c贸nyuge de la jefatura del hogar
seguridad_social.loc[(seguridad_social['hijo_ss'] > 0), 'hijo_ss'] = 1 # Acceso directo a servicios de salud de hijos(as) de la jefatura del hogar

# Otros n煤cleos familiares: se identifica a la poblaci贸n con acceso a la seguridad social mediante otros n煤cleos familiares a trav茅s de la afiliaci贸n o inscripci贸n 
#a servicios de salud por alg煤n familiar dentro o fuera del hogar, muerte del asegurado o por contrataci贸n propia.

seguridad_social['s_salud'] = np.NAN
seguridad_social.loc[((~seguridad_social['pop_insabi'].isna()) & (~seguridad_social['atemed'].isna())), 's_salud'] = 0 # Sin acceso
seguridad_social.loc[((seguridad_social['atemed'] == 1) & ((seguridad_social['inst_1'] == 1) |
                      (seguridad_social['inst_2'] == 2) | (seguridad_social['inst_3'] == 3) | 
                       (seguridad_social['inst_4'] == 4)) & ((seguridad_social['inscr_3'] == 3) | 
                        (seguridad_social['inscr_4'] == 4) | (seguridad_social['inscr_6'] == 6) | 
                         (seguridad_social['inscr_7'] == 7))), 's_salud'] = 1 # Con acceso

# Programas sociales de pensiones para adultos mayores
seguridad_social['pam'] = np.NAN
seguridad_social.loc[((seguridad_social['edad'] >= 65) & (~seguridad_social['edad'].isna())), 'pam'] = 0 # No recibe
seguridad_social.loc[((seguridad_social['edad'] >= 65) & (~seguridad_social['edad'].isna()) & 
                      (seguridad_social['ing_pam'] >= lp_pam) & (~seguridad_social['ing_pam'].isna())), 'pam'] = 1 # Recibe

#Indicador de carencia por acceso a la seguridad social
seguridad_social['ic_segsoc'] = np.NAN
## Acceso directo
seguridad_social.loc[(seguridad_social['ss_dir'] == 1), 'ic_segsoc'] = 0 # No presenta carencia

## Parentesco directo: jefatura
seguridad_social.loc[((seguridad_social['par'] == 1) & (seguridad_social['cony_ss'] == 1)), 'ic_segsoc'] = 0 # No presenta carencia
seguridad_social.loc[((seguridad_social['par'] == 1) & (seguridad_social['pea'] == 0) & 
                      (seguridad_social['hijo_ss'] == 1)), 'ic_segsoc'] = 0 # No presenta carencia

## Parentesco directo: c贸nyuge
seguridad_social.loc[((seguridad_social['par'] == 2) & (seguridad_social['jef_ss'] == 1)), 'ic_segsoc'] = 0 # No presenta carencia
seguridad_social.loc[((seguridad_social['par'] == 2) & (seguridad_social['pea'] == 0) & 
                      (seguridad_social['hijo_ss'] == 1)), 'ic_segsoc'] = 0 # No presenta carencia

## Parentesco directo: descendientes
seguridad_social.loc[((seguridad_social['par'] == 3) & (seguridad_social['edad'] < 16) & 
                      (seguridad_social['jef_ss'] == 1)), 'ic_segsoc'] = 0 # No presenta carencia
seguridad_social.loc[((seguridad_social['par'] == 3) & (seguridad_social['edad'] < 16) & 
                      (seguridad_social['cony_ss'] == 1)), 'ic_segsoc'] = 0 # No presenta carencia
seguridad_social.loc[((seguridad_social['par'] == 3) & (seguridad_social['edad'].between(16, 25)) & 
                      (seguridad_social['inas_esc'] == 0) & (seguridad_social['jef_ss'] == 1)), 'ic_segsoc'] = 0 # No presenta carencia
seguridad_social.loc[((seguridad_social['par'] == 3) & (seguridad_social['edad'].between(16, 25)) & 
                      (seguridad_social['inas_esc'] == 0) & (seguridad_social['cony_ss'] == 1)), 'ic_segsoc'] = 0 # No presenta carencia

## Parentesco directo: ascendientes
seguridad_social.loc[((seguridad_social['par'] == 4) & (seguridad_social['pea'] == 0) &
                      (seguridad_social['jef_ss'] == 1)), 'ic_segsoc'] = 0 # No presenta carencia
seguridad_social.loc[((seguridad_social['par'] == 5) & (seguridad_social['pea'] == 0) & 
                      (seguridad_social['cony_ss'] == 1)), 'ic_segsoc'] = 0 # No presenta carencia

## Otros n煤cleos familiares
seguridad_social.loc[(seguridad_social['s_salud'] == 1), 'ic_segsoc'] = 0 # No presenta carencia

## Programa de adultos mayores
seguridad_social.loc[(seguridad_social['pam'] == 1), 'ic_segsoc'] = 0 # No presenta carencia
seguridad_social.loc[(seguridad_social['ic_segsoc'].isna()), 'ic_segsoc'] = 1 # Presenta carencia

seguridad_social = seguridad_social[['folioviv', 'foliohog', 'numren', 'tipo_trab1', 'tipo_trab2', 'aforlab1', 'aforlab2', 'pea', 'jub', 
'smlab1', 'smlab2', 'smcv', 'aforecv', 'ss_dir', 'par', 'jef_ss', 'cony_ss', 'hijo_ss', 's_salud', 'pam', 'ing_pam', 'ic_segsoc']]
```

**Se guarda la base de datos** 
```{python}
seguridad_social.to_csv(current_directory + '/Output/Data/' + '/ic_segsoc22.csv.csv', index = False)
```

##### Opci贸n 2 {.tabset .tabset-pills .top4-tiles} 

###### Prestaciones laborales

```{python}
# Prestaciones laborales
trabajos = pd.read_csv(current_directory + "/Bases de datos/trabajos.csv", low_memory = False) 
```

```{python}
prestaciones = trabajos.copy()

#Convirtiendo variables string a numericas
prestaciones[['subor', 'indep', 'tiene_suel', 'pago', 'pres_8', 'id_trabajo']] = prestaciones[['subor', 'indep', 'tiene_suel', 'pago', 'pres_8', 'id_trabajo']
                                                                                             ].apply(pd.to_numeric, errors = 'coerce')

# Tipo de trabajador: identifica la poblaci贸n subordinada e independiente
prestaciones['tipo_trab'] = np.NAN
## Subordinados
prestaciones.loc[(prestaciones['subor'] == 1), 'tipo_trab'] = 1

## Independientes que reciben un pago
prestaciones.loc[((prestaciones['subor'] == 2) & (prestaciones['indep'] == 1) & (prestaciones['tiene_suel'] == 1)), 'tipo_trab'] = 2
prestaciones.loc[((prestaciones['subor'] == 2) & (prestaciones['indep'] == 2) & (prestaciones['pago'] == 1)), 'tipo_trab'] = 2

## Independientes que no reciben un pago
prestaciones.loc[((prestaciones['subor'] == 2) & (prestaciones['indep'] == 1) & (prestaciones['tiene_suel'] == 2)), 'tipo_trab'] = 3
prestaciones.loc[((prestaciones['subor'] == 2) & (prestaciones['indep'] == 2) & ((prestaciones['pago'] == 2) | (prestaciones['pago'] == 3))), 'tipo_trab'] = 3
 

# Ahorro para el retiro o pensi贸n para la vejez (SAR, Afore)
prestaciones['aforlab'] = np.NAN
prestaciones.loc[(prestaciones['pres_8'].isna()), 'aforlab'] = 0 
prestaciones.loc[(prestaciones['pres_8'] == 8), 'aforlab'] = 1 

# Ocupaci贸n principal o secundaria
prestaciones['ocupa'] = np.NAN
prestaciones.loc[(prestaciones['id_trabajo'] == 1), 'ocupa'] = 1 
prestaciones.loc[(prestaciones['id_trabajo'] == 2), 'ocupa'] = 1 

# Distinci贸n de prestaciones en trabajo principal y secundario
prestaciones = prestaciones[['folioviv', 'foliohog', 'numren', 'id_trabajo', 'tipo_trab', 'aforlab', 'ocupa']]

prestaciones = pd.pivot_table(prestaciones, 
                               index = ['folioviv', 'foliohog', 'numren'], 
                                columns = 'id_trabajo', 
                                 values = ['tipo_trab', 'aforlab', 'ocupa'], 
                                  aggfunc = np.sum, 
                                   fill_value = 0)
prestaciones.columns = [f'{i}{j}' for i, j in prestaciones.columns]
prestaciones = prestaciones.reset_index()

#Identificaci贸n de la poblaci贸n trabajadora (toda la que reporta al menos un empleo en la base de trabajos.csv)
prestaciones['trab'] = 1
prestaciones = prestaciones[['folioviv', 'foliohog', 'numren', 'trab', 'tipo_trab1', 'tipo_trab2', 'aforlab1', 'aforlab2', 'ocupa1', 'ocupa2']]
```


**Se guarda la base de datos** 
```{python}
prestaciones.to_csv(current_directory + '/Output/Data/' + '/prestaciones22.csv.csv', index = False)
```

###### Ingresos por jubilaciones o pensiones

```{python}
# Ingresos por jubilaciones o pensiones
pensiones = pd.read_csv(current_directory + "/Bases de datos/ingresos.csv", low_memory = False)

pensiones = pensiones[((pensiones['clave'] == 'P032') | (pensiones['clave'] == 'P033') | 
                       (pensiones['clave'] == 'P104') | (pensiones['clave'] == 'P045'))]
```


```{python}
# Definici贸n de los deflactores 2022 
dic21 =	0.9475376203	
ene22 =	0.9531433002
feb22 =	0.9610510246	
mar22 =	0.9705661414	
abr22 =	0.9758164180	
may22 =	0.9775368933
jun22 =	0.9857919437	
jul22 =	0.9930938669
ago22 =	1.0000000000
sep22 =	1.0062034038
oct22 =	1.0118979346
nov22 =	1.0177217030
dic22 =	1.0216069077
```

```{python}
#Convirtiendo variables string a numericas
pensiones[['mes_1', 'mes_2', 'mes_3', 'mes_4', 'mes_5', 'mes_6', 'ing_1', 'ing_2', 'ing_3', 'ing_4', 'ing_5', 'ing_6']
          ] = pensiones[['mes_1', 'mes_2', 'mes_3', 'mes_4', 'mes_5', 'mes_6', 'ing_1', 'ing_2', 'ing_3', 'ing_4', 'ing_5', 'ing_6']].apply(pd.to_numeric, errors = 'coerce')
          
# Se deflactan los ingresos por jubilaciones, pensionesiones y programas de adultos mayores de acuerdo con el mes de levantamiento
pensiones['ing_6'] = np.where(pensiones['mes_6'].isna(), pensiones['ing_6'] ,
                      np.where(pensiones['mes_6'] == 2, pensiones['ing_6'] / feb22,
                       np.where(pensiones['mes_6'] == 3, pensiones['ing_6'] / mar22,
                        np.where(pensiones['mes_6'] == 4, pensiones['ing_6'] / abr22,
                         pensiones['ing_6'] / may22))))
pensiones['ing_5'] = np.where(pensiones['mes_5'].isna(), pensiones['ing_5'] ,
                      np.where(pensiones['mes_5'] == 3, pensiones['ing_5'] / mar22,
                       np.where(pensiones['mes_5'] == 4, pensiones['ing_5'] / abr22,
                        np.where(pensiones['mes_5'] == 5, pensiones['ing_5'] / may22,
                         pensiones['ing_5'] / jun22))))
pensiones['ing_4'] = np.where(pensiones['mes_4'].isna(), pensiones['ing_4'] ,
                      np.where(pensiones['mes_4'] == 4, pensiones['ing_4'] / abr22,
                       np.where(pensiones['mes_4'] == 5, pensiones['ing_4'] / may22,
                        np.where(pensiones['mes_4'] == 6, pensiones['ing_4'] / jun22,
                         pensiones['ing_4'] / jul22 ))))
pensiones['ing_3'] = np.where(pensiones['mes_3'].isna(), pensiones['ing_3'] ,
                      np.where(pensiones['mes_3'] == 5, pensiones['ing_3'] / may22,
                       np.where(pensiones['mes_3'] == 6, pensiones['ing_3'] / jun22,
                        np.where(pensiones['mes_3'] == 7, pensiones['ing_3'] / jul22,
                         pensiones['ing_3'] / ago22))))
pensiones['ing_2'] = np.where(pensiones['mes_2'].isna(), pensiones['ing_2'] ,
                      np.where(pensiones['mes_2'] == 6, pensiones['ing_2'] / jun22,
                       np.where(pensiones['mes_2'] == 7, pensiones['ing_2'] / jul22,
                        np.where(pensiones['mes_2'] == 8, pensiones['ing_2'] / ago22,
                         pensiones['ing_2'] / sep22))))
pensiones['ing_1'] = np.where(pensiones['mes_1'].isna(), pensiones['ing_1'] ,
                      np.where(pensiones['mes_1'] == 7, pensiones['ing_1'] / jul22,
                       np.where(pensiones['mes_1'] == 8, pensiones['ing_1'] / ago22,
                        np.where(pensiones['mes_1'] == 9, pensiones['ing_1'] / sep22,
                         pensiones['ing_1'] / oct22 ))))

# Ingreso promedio mensual por programas de adultos mayores
pensiones['ing_pam'] = np.where((pensiones['clave'] == 'P104') | (pensiones['clave'] == 'P045'),
                                  np.apply_along_axis(np.mean, 1, pensiones[['ing_1', 'ing_2', 'ing_3', 'ing_4', 'ing_5', 'ing_6']]), 0)
# Ingreso promedio mensual por jubilaciones y pensiones
pensiones['ing_pens'] = np.where((pensiones['clave'] == 'P032') | (pensiones['clave'] == 'P033'),
                                   np.apply_along_axis(np.mean, 1, pensiones[['ing_1', 'ing_2', 'ing_3', 'ing_4', 'ing_5', 'ing_6']]), 0)

pensiones = pensiones.groupby(['folioviv', 'foliohog', 'numren'])[['ing_pens', 'ing_pam']].sum(numeric_only = True)
pensiones = pensiones.reset_index()
```


**Se guarda la base de datos** 
```{python}
pensiones.to_csv(current_directory + '/Output/Data/' + '/pensiones22.csv.csv', index = False)
```


###### Construcci贸n del indicador

**Indicador de carencia por acceso a la seguridad social** 

Se encuentra en situaci贸n de carencia por acceso a la seguridad social a la poblaci贸n que:    
1. No disponga de acceso directo a la seguridad social.   
2. No cuente con parentesco directo con alguna persona dentro del hogar que tenga acceso directo.    
3. No recibe servicios m茅dicos por parte de alg煤n familiar dentro o fuera del hogar, por muerte del asegurado o por contrataci贸n propia.  
4. No recibe ingreso por parte de un programa de adultos mayores donde el monto sea mayor o igual al valor promedio de la canasta alimentaria rural y urbana.    

```{python}
# Valor monetario de las l铆neas de pobreza extrema por ingresos rural y urbana
lp1_urb = 2086.21
lp1_rur = 1600.18
lp_pam = (lp1_urb + lp1_rur)/2
```

 
 
```{python}
# Construcci贸n del indicador
seguridad_social = poblacion.copy()

# Poblaci贸n objetivo: no se incluye a hu茅spedes ni trabajadores dom茅sticos
seguridad_social = seguridad_social[~((seguridad_social['parentesco'] >= 400) & (seguridad_social['parentesco'] < 500) |
                   (seguridad_social['parentesco'] >= 700) & (seguridad_social['parentesco'] < 800))]

# Integraci贸n de bases
seguridad_social = pd.merge(seguridad_social, prestaciones, 
                             on = ['folioviv', 'foliohog', 'numren'], 
                              how = 'left')
seguridad_social = pd.merge(seguridad_social, pensiones, 
                    on = ['folioviv', 'foliohog', 'numren'], 
                     how = 'left')

#Convirtiendo variables string a numericas
seguridad_social[['parentesco', 'trab', 'edad', 'act_pnea1', 'act_pnea2','ocupa1', 'atemed', 'trabajo_mp',
                  'inst_1', 'inst_2', 'inst_3', 'inst_4', 'inst_5', 'inst_6', 'inscr_1', 'inscr_2', 'inscr_3', 
                  'inscr_4', 'inscr_5', 'inscr_6', 'inscr_7', 'asis_esc', 'pop_insabi', 'segvol_1']
                 ] = seguridad_social[['parentesco', 'trab', 'edad', 'act_pnea1', 'act_pnea2','ocupa1', 'atemed', 'trabajo_mp',
                                       'inst_1', 'inst_2', 'inst_3', 'inst_4', 'inst_5', 'inst_6', 'inscr_1', 'inscr_2', 'inscr_3', 
                                       'inscr_4', 'inscr_5', 'inscr_6', 'inscr_7', 'asis_esc', 'pop_insabi', 'segvol_1']].apply(pd.to_numeric, errors = 'coerce')

# PEA (personas de 16 a帽os o m谩s)
seguridad_social['pea'] = np.NAN
seguridad_social.loc[(seguridad_social['trab'] == 1) & (seguridad_social['edad'] >= 16) & 
                      (~seguridad_social['edad'].isna()), 'pea'] = 1 # PEA: ocupada
seguridad_social.loc[((seguridad_social['act_pnea1'] == 1) | (seguridad_social['act_pnea2'] == 1)) & 
                      (seguridad_social['edad'] >= 16) & (~seguridad_social['edad'].isna()), 'pea'] = 2 # PEA: desocupada
seguridad_social.loc[((seguridad_social['edad'] >= 16) & (~seguridad_social['edad'].isna()) &
                      (((seguridad_social['act_pnea1'] != 1) | (seguridad_social['act_pnea1'].isna())) &
                       ((seguridad_social['act_pnea2'] != 1) | (seguridad_social['act_pnea2'].isna()))) &
                        (((seguridad_social['act_pnea1'] >= 2) & (seguridad_social['act_pnea1'] <= 6)) |
                         ((seguridad_social['act_pnea2'] >= 2) & (seguridad_social['act_pnea2'] <= 6)))), 'pea'] = 0 # PNEA

# Acceso directo a la seguridad social
## Ocupaci贸n principal
seguridad_social['tipo_trab1'] = np.where(seguridad_social['pea'] == 1, 
                                           seguridad_social['tipo_trab1'], 
                                            seguridad_social['tipo_trab1']) # Depende de un patr贸n, jefe o superior 
seguridad_social['tipo_trab1'] = np.where((seguridad_social['pea'] == 0) | (seguridad_social['pea'] == 2), 
                                            np.NAN, 
                                             seguridad_social['tipo_trab1']) # No depende de un jefe y recibe o tiene asignado un sueldo
seguridad_social['tipo_trab1'] = np.where(seguridad_social['pea'].isna(), 
                                           np.NAN, 
                                            seguridad_social['tipo_trab1']) # No depende de un jefe y no recibe o no tiene asignado un sueldo
## Ocupaci贸n secundaria
seguridad_social['tipo_trab2'] = np.where(seguridad_social['pea'] == 1, 
                                           seguridad_social['tipo_trab2'], 
                                            seguridad_social['tipo_trab2']) # Depende de un patr贸n, jefe o superior
seguridad_social['tipo_trab2'] = np.where((seguridad_social['pea'] == 0) | (seguridad_social['pea'] == 2), 
                                            np.NAN, 
                                             seguridad_social['tipo_trab2']) # No depende de un jefe y recibe o tiene asignado un sueldo
seguridad_social['tipo_trab2'] = np.where(seguridad_social['pea'].isna(), 
                                           np.NAN, 
                                            seguridad_social['tipo_trab2']) # No depende de un jefe y no recibe o no tiene asignado un sueldo
## Jubilados y pensionados
seguridad_social['jub'] = np.NAN
seguridad_social.loc[((seguridad_social['trabajo_mp'] == 2) & ((seguridad_social['act_pnea1'] == 2) | 
                      (seguridad_social['act_pnea2'] == 2))), 'jub'] = 1 # Poblaci贸n pensionada o jubilada
seguridad_social.loc[((seguridad_social['ing_pens'] > 0) & (~seguridad_social['ing_pens'].isna())), 'jub'] = 1 # Poblaci贸n pensionada o jubilada
seguridad_social.loc[(seguridad_social['inscr_2'] == 2), 'jub'] = 1 # Poblaci贸n pensionada o jubilada
seguridad_social.loc[(seguridad_social['jub'].isna()), 'jub'] = 0 # Poblaci贸n no pensionada o jubilada

# Prestaciones b谩sicas

# Prestaciones laborales (Servicios m茅dicos)
## Ocupaci贸n principal
seguridad_social['smlab1'] = np.NAN
seguridad_social.loc[(seguridad_social['ocupa1'] == 1), 'smlab1'] = 0 # Con servicios m茅dicos
seguridad_social.loc[((seguridad_social['ocupa1'] == 1) & (seguridad_social['atemed'] == 1) & 
                      ((seguridad_social['inst_1'] == 1) | (seguridad_social['inst_2'] == 2) | 
                       (seguridad_social['inst_3'] == 3) | (seguridad_social['inst_4'] == 4)) & 
                        (seguridad_social['inscr_1'] == 1)), 'smlab1'] = 1 # Sin servicios m茅dicos
## Ocupaci贸n secundaria
seguridad_social['smlab2'] = np.NAN
seguridad_social.loc[(seguridad_social['ocupa2'] == 1), 'smlab2'] = 0 # Con servicios m茅dicos
seguridad_social.loc[((seguridad_social['ocupa2'] == 1) & (seguridad_social['atemed'] == 1) & 
                      ((seguridad_social['inst_1'] == 1) | (seguridad_social['inst_2'] == 2) | 
                       (seguridad_social['inst_3'] == 3) | (seguridad_social['inst_4'] == 4)) & 
                        (seguridad_social['inscr_1'] == 1)), 'smlab2'] = 1 # Sin servicios m茅dicos

# Contrataci贸n voluntaria: servicios m茅dicos y ahorro para el retiro o pensi贸n para la vejez (SAR, Afore, Haber de retiro)
## Servicios m茅dicos
seguridad_social['smcv'] = np.NAN
seguridad_social.loc[((seguridad_social['edad'] >= 12) & (~seguridad_social['edad'].isna())), 'smcv'] = 0 # No cuenta
seguridad_social.loc[((seguridad_social['atemed'] == 1) & ((seguridad_social['inst_1'] == 1) |
                      (seguridad_social['inst_2'] == 2) | (seguridad_social['inst_3'] == 3) |
                       (seguridad_social['inst_4'] == 4)) & (seguridad_social['inscr_6'] == 6) & 
                        ((seguridad_social['edad'] >= 12) & (~seguridad_social['edad'].isna()))), 'smcv'] = 1 # S铆 cuenta
                        
## SAR o Afore
seguridad_social['aforecv'] = np.NAN              
seguridad_social.loc[((seguridad_social['segvol_1'].isna()) & ((seguridad_social['edad'] >= 12) & 
                      (~seguridad_social['edad'].isna()))), 'aforecv'] = 0 # No cuenta    
seguridad_social.loc[((seguridad_social['segvol_1'] == 1) & ((seguridad_social['edad'] >= 12) & 
                      (~seguridad_social['edad'].isna()))), 'aforecv'] = 1 # S铆 cuenta 
                      
## Acceso directo a la seguridad social
seguridad_social['ss_dir'] = np.NAN
seguridad_social.loc[(seguridad_social['ss_dir'].isna()), 'ss_dir'] = 0 # Sin acceso

## Ocupaci贸n principal
seguridad_social.loc[((seguridad_social['tipo_trab1'] == 1) & (seguridad_social['smlab1'] == 1)), 'ss_dir'] = 1 # Con acceso
seguridad_social.loc[((seguridad_social['tipo_trab1'] == 2) & ((seguridad_social['smlab1'] == 1) |
                      (seguridad_social['smcv'] == 1)) & ((seguridad_social['aforlab1'] == 1) | 
                       (seguridad_social['aforecv'] == 1))), 'ss_dir'] = 1 # Con acceso
seguridad_social.loc[((seguridad_social['tipo_trab1'] == 3) & ((seguridad_social['smlab1'] == 1) | 
                       (seguridad_social['smcv'] == 1)) & (seguridad_social['aforecv'] == 1)), 'ss_dir'] = 1 # Con acceso

## Ocupaci贸n secundaria
seguridad_social.loc[((seguridad_social['tipo_trab2'] == 1) & (seguridad_social['smlab2'] == 1)), 'ss_dir'] = 1 # Con acceso
seguridad_social.loc[((seguridad_social['tipo_trab2'] == 2) & ((seguridad_social['smlab2'] == 1) | 
                      (seguridad_social['smcv'] == 1)) & ((seguridad_social['aforlab2'] == 1) | 
                       (seguridad_social['aforecv'] == 1))), 'ss_dir'] = 1 # Con acceso
seguridad_social.loc[((seguridad_social['tipo_trab2'] == 3) & ((seguridad_social['smlab2'] == 1) | 
                       (seguridad_social['smcv'] == 1)) & (seguridad_social['aforecv'] == 1)), 'ss_dir'] = 1 # Con acceso   

## Jubilados y pensionados
seguridad_social.loc[(seguridad_social['jub'] == 1), 'ss_dir'] = 1 # Con acceso 

## N煤cleos familiares   
seguridad_social['par'] = np.NAN
seguridad_social.loc[((seguridad_social['parentesco'] >= 100) & (seguridad_social['parentesco'] < 200)), 'par'] = 1 # Jefe o jefa del hogar
seguridad_social.loc[((seguridad_social['parentesco'] >= 200) & (seguridad_social['parentesco'] < 300)), 'par'] = 2 # C贸nyuge del  jefe/a
seguridad_social.loc[((seguridad_social['parentesco'] >= 300) & (seguridad_social['parentesco'] < 400)), 'par'] = 3 # Hijo del jefe/a
seguridad_social.loc[((seguridad_social['parentesco'] == 601)), 'par'] = 4 # Padre o Madre del jefe/a
seguridad_social.loc[((seguridad_social['parentesco'] == 615)), 'par'] = 5 # Suegro del jefe/a
seguridad_social.loc[(seguridad_social['par'].isna()), 'par'] = 6 # Sin acceso

# Asimismo, se utilizar谩 la informaci贸n relativa a la asistencia a la escuela
seguridad_social['inas_esc'] = np.NAN
seguridad_social.loc[((seguridad_social['asis_esc'] == 1)), 'inas_esc'] = 0 # S铆 asiste
seguridad_social.loc[((seguridad_social['asis_esc'] == 2)), 'inas_esc'] = 1 # No asiste

# En primer lugar se identifican los principales parentescos respecto a la jefatura del hogar y si ese miembro cuenta con acceso directo
seguridad_social['jef'] = np.NAN
seguridad_social.loc[((seguridad_social['par'] == 1) & (seguridad_social['ss_dir'] == 1)), 'jef'] = 1
seguridad_social.loc[((((seguridad_social['inst_2'] == 2) | (seguridad_social['inst_3'] == 3)) & (seguridad_social['inscr_6'] == 6)) & 
                      ((seguridad_social['inst_1'].isna()) & (seguridad_social['inst_4'].isna()) & (seguridad_social['inst_6'].isna())) &
                       ((seguridad_social['inscr_1'].isna()) & (seguridad_social['inscr_2'].isna()) & (seguridad_social['inscr_3'].isna()) &
                        (seguridad_social['inscr_4'].isna()) & (seguridad_social['inscr_5'].isna()) & (seguridad_social['inscr_7'].isna()))), 'jef'] = np.NAN

seguridad_social['cony'] = np.NAN
seguridad_social.loc[((seguridad_social['par'] == 2) & (seguridad_social['ss_dir'] == 1)), 'cony'] = 1
seguridad_social.loc[((((seguridad_social['inst_2'] == 2) | (seguridad_social['inst_3'] == 3)) & (seguridad_social['inscr_6'] == 6)) &
                      ((seguridad_social['inst_1'].isna()) & (seguridad_social['inst_4'].isna()) & (seguridad_social['inst_6'].isna())) &
                       ((seguridad_social['inscr_1'].isna()) & (seguridad_social['inscr_2'].isna()) & (seguridad_social['inscr_3'].isna()) &
                        (seguridad_social['inscr_4'].isna()) & (seguridad_social['inscr_5'].isna()) & (seguridad_social['inscr_7'].isna()))), 'cony'] = np.NAN

seguridad_social['hijo'] = np.NAN
seguridad_social.loc[((seguridad_social['par'] == 3) & (seguridad_social['ss_dir'] == 1) & (seguridad_social['jub'] == 1) & 
                      ((seguridad_social['edad'] > 25) & (~seguridad_social['edad'].isna()))), 'hijo'] = 1
seguridad_social.loc[((seguridad_social['par'] == 3) & (seguridad_social['ss_dir'] == 1) & (seguridad_social['jub'] == 0)), 'hijo'] = 1
seguridad_social.loc[((((seguridad_social['inst_2'] == 2) | (seguridad_social['inst_3'] == 3)) & (seguridad_social['inscr_6'] == 6)) &
                      ((seguridad_social['inst_1'].isna()) & (seguridad_social['inst_4'].isna()) & (seguridad_social['inst_6'].isna())) &
                       ((seguridad_social['inscr_1'].isna()) & (seguridad_social['inscr_2'].isna()) & (seguridad_social['inscr_3'].isna()) &
                        (seguridad_social['inscr_4'].isna()) & (seguridad_social['inscr_5'].isna()) & (seguridad_social['inscr_7'].isna()))), 'hijo'] = np.NAN

seguridad_social = seguridad_social.groupby(['folioviv', 'foliohog']
                                           ).apply(lambda x: pd.Series({'jef_ss': x['jef'].sum(skipna=True),
                                                                        'cony_ss': x['cony'].sum(skipna=True),
                                                                        'hijo_ss': x['hijo'].sum(skipna=True)})
                                                                      ).reset_index().merge(seguridad_social, 
                                                                                             on = ['folioviv', 'foliohog'])

seguridad_social.loc[(seguridad_social['jef_ss'] > 0), 'jef_ss'] = 1 # Acceso directo a servicios de salud de la jefatura del hogar
seguridad_social.loc[(seguridad_social['cony_ss'] > 0), 'cony_ss'] = 1 # Acceso directo a servicios de salud del c贸nyuge de la jefatura del hogar
seguridad_social.loc[(seguridad_social['hijo_ss'] > 0), 'hijo_ss'] = 1 # Acceso directo a servicios de salud de hijos(as) de la jefatura del hogar

# Otros n煤cleos familiares: se identifica a la poblaci贸n con acceso a la seguridad social mediante otros n煤cleos familiares a trav茅s de la afiliaci贸n o inscripci贸n 
#a servicios de salud por alg煤n familiar dentro o fuera del hogar, muerte del asegurado o por contrataci贸n propia.

seguridad_social['s_salud'] = np.NAN
seguridad_social.loc[((~seguridad_social['pop_insabi'].isna()) & (~seguridad_social['atemed'].isna())), 's_salud'] = 0 # Sin acceso
seguridad_social.loc[((seguridad_social['atemed'] == 1) & ((seguridad_social['inst_1'] == 1) |
                      (seguridad_social['inst_2'] == 2) | (seguridad_social['inst_3'] == 3) | 
                       (seguridad_social['inst_4'] == 4)) & ((seguridad_social['inscr_3'] == 3) | 
                        (seguridad_social['inscr_4'] == 4) | (seguridad_social['inscr_6'] == 6) | 
                         (seguridad_social['inscr_7'] == 7))), 's_salud'] = 1 # Con acceso

# Programas sociales de pensiones para adultos mayores
seguridad_social['pam'] = np.NAN
seguridad_social.loc[((seguridad_social['edad'] >= 65) & (~seguridad_social['edad'].isna())), 'pam'] = 0 # No recibe
seguridad_social.loc[((seguridad_social['edad'] >= 65) & (~seguridad_social['edad'].isna()) & 
                      (seguridad_social['ing_pam'] >= lp_pam) & (~seguridad_social['ing_pam'].isna())), 'pam'] = 1 # Recibe

#Indicador de carencia por acceso a la seguridad social
seguridad_social['ic_segsoc'] = np.NAN
## Acceso directo
seguridad_social.loc[(seguridad_social['ss_dir'] == 1), 'ic_segsoc'] = 0 # No presenta carencia

## Parentesco directo: jefatura
seguridad_social.loc[((seguridad_social['par'] == 1) & (seguridad_social['cony_ss'] == 1)), 'ic_segsoc'] = 0 # No presenta carencia
seguridad_social.loc[((seguridad_social['par'] == 1) & (seguridad_social['pea'] == 0) & 
                      (seguridad_social['hijo_ss'] == 1)), 'ic_segsoc'] = 0 # No presenta carencia

## Parentesco directo: c贸nyuge
seguridad_social.loc[((seguridad_social['par'] == 2) & (seguridad_social['jef_ss'] == 1)), 'ic_segsoc'] = 0 # No presenta carencia
seguridad_social.loc[((seguridad_social['par'] == 2) & (seguridad_social['pea'] == 0) & 
                      (seguridad_social['hijo_ss'] == 1)), 'ic_segsoc'] = 0 # No presenta carencia

## Parentesco directo: descendientes
seguridad_social.loc[((seguridad_social['par'] == 3) & (seguridad_social['edad'] < 16) & 
                      (seguridad_social['jef_ss'] == 1)), 'ic_segsoc'] = 0 # No presenta carencia
seguridad_social.loc[((seguridad_social['par'] == 3) & (seguridad_social['edad'] < 16) & 
                      (seguridad_social['cony_ss'] == 1)), 'ic_segsoc'] = 0 # No presenta carencia
seguridad_social.loc[((seguridad_social['par'] == 3) & (seguridad_social['edad'].between(16, 25)) & 
                      (seguridad_social['inas_esc'] == 0) & (seguridad_social['jef_ss'] == 1)), 'ic_segsoc'] = 0 # No presenta carencia
seguridad_social.loc[((seguridad_social['par'] == 3) & (seguridad_social['edad'].between(16, 25)) & 
                      (seguridad_social['inas_esc'] == 0) & (seguridad_social['cony_ss'] == 1)), 'ic_segsoc'] = 0 # No presenta carencia

## Parentesco directo: ascendientes
seguridad_social.loc[((seguridad_social['par'] == 4) & (seguridad_social['pea'] == 0) &
                      (seguridad_social['jef_ss'] == 1)), 'ic_segsoc'] = 0 # No presenta carencia
seguridad_social.loc[((seguridad_social['par'] == 5) & (seguridad_social['pea'] == 0) & 
                      (seguridad_social['cony_ss'] == 1)), 'ic_segsoc'] = 0 # No presenta carencia

## Otros n煤cleos familiares
seguridad_social.loc[(seguridad_social['s_salud'] == 1), 'ic_segsoc'] = 0 # No presenta carencia

## Programa de adultos mayores
seguridad_social.loc[(seguridad_social['pam'] == 1), 'ic_segsoc'] = 0 # No presenta carencia
seguridad_social.loc[(seguridad_social['ic_segsoc'].isna()), 'ic_segsoc'] = 1 # Presenta carencia

seguridad_social = seguridad_social[['folioviv', 'foliohog', 'numren', 'tipo_trab1', 'tipo_trab2', 'aforlab1', 'aforlab2', 'pea', 'jub', 
'smlab1', 'smlab2', 'smcv', 'aforecv', 'ss_dir', 'par', 'jef_ss', 'cony_ss', 'hijo_ss', 's_salud', 'pam', 'ing_pam', 'ic_segsoc']]
```

**Se guarda la base de datos** 
```{python}
seguridad_social.to_csv(current_directory + '/Output/Data/' + '/ic_segsoc22.csv.csv', index = False)
```

#### IV. Indicador de carencia por calidad y espacios de la vivienda 

##### Material de construcci贸n de la vivienda

```{python}
viviendas = pd.read_csv(current_directory + "/Bases de datos/viviendas.csv", low_memory = False)
concentradohogar = pd.read_csv(current_directory + "/Bases de datos/concentradohogar.csv", low_memory = False)
```

**Indicador de carencia por calidad y espacios de la vivienda**  

Se considera en situaci贸n de carencia por calidad y espacios de la vivienda a las personas que residan en viviendas que presenten, al menos, una de las siguientes caracter铆sticas:     
  
1. El material de los pisos de la vivienda es de tierra   
2. El material del techo de la vivienda es de l谩mina de cart贸n o desechos.   
3. El material de los muros de la vivienda es de embarro o bajareque, de carrizo, bamb煤 o palma, de l谩mina de cart贸n, met谩lica o asbesto, o material de desecho.    
4. La raz贸n de personas por cuarto (hacinamiento) es mayor que `2.5`.      

```{python}
calidad_viviendas = viviendas.copy()

calidad_viviendas = pd.merge(calidad_viviendas, concentradohogar, 
                             on = ['folioviv'], 
                              how = 'left')

#Convirtiendo variables string a numericas
calidad_viviendas[['mat_pisos', 'mat_techos', 'mat_pared', 'tot_resid', 'num_cuarto']
      ] = calidad_viviendas[['mat_pisos', 'mat_techos', 'mat_pared', 'tot_resid', 'num_cuarto']].apply(pd.to_numeric, errors='coerce')

# Indicador de carencia por material de piso de la vivienda
## Material de los pisos de la vivienda
calidad_viviendas['icv_pisos'] = np.NAN
calidad_viviendas.loc[(calidad_viviendas['mat_pisos'] >= 2), 'icv_pisos'] = 0
calidad_viviendas.loc[(calidad_viviendas['mat_pisos'] == 1), 'icv_pisos'] = 1

# Indicador de carencia por material de techos de la vivienda
## Material de los techos de la vivienda
calidad_viviendas['icv_techos'] = np.NAN
calidad_viviendas.loc[(calidad_viviendas['mat_techos'] >= 3), 'icv_techos'] = 0
calidad_viviendas.loc[(calidad_viviendas['mat_techos'] <= 2), 'icv_techos'] = 1

# Indicador de carencia por material de muros de la vivienda
## Material de muros en la vivienda
calidad_viviendas['icv_muros'] = np.NAN
calidad_viviendas.loc[(calidad_viviendas['mat_pared'] >= 6), 'icv_muros'] = 0
calidad_viviendas.loc[(calidad_viviendas['mat_pared'] <= 5), 'icv_muros'] = 1

# Espacios en la vivienda (Hacinamiento)
## N煤mero de residentes en la vivienda
calidad_viviendas['num_ind'] = calidad_viviendas['tot_resid']

## N煤mero de cuartos en la vivienda
calidad_viviendas['num_cua'] = calidad_viviendas['num_cuarto']

## ndice de hacinamiento
calidad_viviendas['cv_hac'] = calidad_viviendas['num_ind']/calidad_viviendas['num_cua']

## Indicador de carencia por hacinamiento en la vivienda
calidad_viviendas['icv_hac'] = np.NAN
calidad_viviendas.loc[((calidad_viviendas['cv_hac'] > 2.5) & (~calidad_viviendas['cv_hac'].isna())), 'icv_hac'] = 1
calidad_viviendas.loc[(calidad_viviendas['cv_hac'] <= 2.5), 'icv_hac'] = 0
       
# Indicador de carencia por calidad y espacios de la vivienda
calidad_viviendas['ic_cv'] = np.NAN
calidad_viviendas.loc[((calidad_viviendas['icv_pisos'] == 1) | (calidad_viviendas['icv_techos'] == 1) | (calidad_viviendas['icv_muros'] == 1) | (calidad_viviendas['icv_hac'] == 1)), 'ic_cv'] = 1 # Con carencia
calidad_viviendas.loc[((calidad_viviendas['icv_pisos'] == 0) & (calidad_viviendas['icv_techos'] == 0) & (calidad_viviendas['icv_muros'] == 0) & (calidad_viviendas['icv_hac'] == 0)), 'ic_cv'] = 0 # Sin carencia  
calidad_viviendas.loc[((calidad_viviendas['icv_pisos'].isna()) | (calidad_viviendas['icv_techos'].isna()) | (calidad_viviendas['icv_muros'].isna()) | (calidad_viviendas['icv_hac'].isna())), 'ic_cv'] = np.NAN
            
calidad_viviendas = calidad_viviendas[['folioviv', 'foliohog', 'icv_pisos', 'icv_techos', 'icv_muros', 'icv_hac', 'ic_cv']]    
```


**Se guarda la base de datos**
```{r}
#fwrite(calidad.viviendas, paste0(here::here(), "/Output/Data/ic_cev22.csv"), row.names = F)
save(calidad.viviendas, file = paste0(here::here(), "/Output/Data/ic_cev22.RData"))
```


#### V. Indicador de carencia por acceso a los servicios b谩sicos de la vivienda   

**Indicador de carencia por acceso a los servicios b谩sicos en la vivienda**   

Se considera en situaci贸n de carencia por servicios b谩sicos en la vivienda a las personas que residan en viviendas que presenten, al menos, una de las siguientes caracter铆sticas:   
  
1. El agua se obtiene de un pozo, r铆o, lago, arroyo, pipa, o bien, el agua entubada la adquieren por acarreo de otra vivienda, o de la llave p煤blica o hidrante.  
2. No cuentan con servicio de drenaje o el desag眉e tiene conexi贸n a una tuber铆a que va a dar a un r铆o, lago, mar, barranca o grieta.   
3. No disponen de energ铆a el茅ctrica.   
4. El combustible que se usa para cocinar o calentar los alimentos es le帽a o carb贸n sin chimenea.   

```{r}
servicios.basicos <- concentradohogar %>% 
                      left_join(., viviendas, by = c("folioviv")) %>% 
                       mutate(
                              # Indicador de carencia por acceso al agua
                              isb_agua = case_when(.$procaptar == 1 & .$disp_agua == "4" ~ 0,
                                                 .$disp_agua >= 3 & !is.na(.$disp_agua) ~ 1,
                                                 .$disp_agua <= 2 & !is.na(.$disp_agua) ~ 0),
                              # Indicador de carencia por servicio de drenaje
                              isb_dren = case_when(.$drenaje >= 3 ~1,
                                                 .$drenaje <= 2 ~0),
                              # Indicador de carencia por servicios de electricidad
                              isb_luz = case_when(.$disp_elect >= 5 ~1,
                                                .$disp_elect <= 4 ~0),
                              # Indicador de carencia por combustible para cocinar
                              combus = as.numeric(.$combustible),
                              estufa = as.numeric(.$estufa_chi),
                              isb_combus = case_when((.$combus == 1 | .$combus == 2) & .$estufa == 2 ~ 1, 
                                                     (.$combus == 1 | .$combus == 2) & .$estufa == 1 ~ 0,
                                                       .$combus >= 3 & .$combus <= 6 ~ 0)) %>%
                              # Indicador de carencia por acceso a los servicios b谩sicos en la vivienda
                       mutate(
                              ic_sbv = case_when(
                                                 is.na(.$isb_agua) | is.na(.$isb_dren) | is.na(.$isb_luz) | is.na(.$isb_combus) ~ NA_real_,
                                                 .$isb_agua == 1 | .$isb_dren == 1 | .$isb_luz == 1 | .$isb_combus == 1 ~ 1, # Con carencia
                                                 .$isb_agua == 0 & .$isb_dren == 0 & .$isb_luz == 0 & .$isb_combus == 0 ~ 0)) %>% # Sin carencia
                       select(folioviv, foliohog, isb_agua, isb_dren, isb_luz, isb_combus, ic_sbv)
  
```
**Se guarda la base de datos**
```{r}
#fwrite(servicios.basicos, paste0(here::here(), "/Output/Data/ic_sbv22.csv"), row.names = F)
save(servicios.basicos, file = paste0(here::here(), "/Output/Data/ic_sbv22.RData"))
```

#### VI. Indicador de carencia por acceso a la alimentaci贸n nutritiva y de calidad  
 
```{r}
menores.alimentacion <- poblacion %>%
                         # Poblaci贸n objetivo: no se incluye a hu茅spedes ni trabajadores dom茅sticos
                         filter(!(parentesco >= 400 & parentesco < 500 | parentesco >= 700 & parentesco < 800)) %>% 
                          # Indicador de hogares con menores de 18 a帽os
                          mutate(men = case_when(.$edad >= 0 & .$edad <= 17 ~ 1, 
                                                 TRUE ~ NA)) %>%
                           as.data.frame() %>%
                           # group_by(folioviv, foliohog) %>%
                             summarise(men = sum(men, na.rm = TRUE), .by = c(folioviv, foliohog)) %>%
                              ungroup() %>%
                               mutate(id_men = case_when(.$men >= 1 & !is.na(.$men) ~ 1, 
                                                         .$men == 0 ~ 0)) %>%
                                select(folioviv, foliohog, id_men)
 # Nota: no concuerda la suma de los menores de edad con la funci贸n summarise y la funci贸n DT
 #menores <- as.data.table(menores.alimentacion)[, lapply(.SD, sum, na.rm = TRUE), 
 #                                                by =.(folioviv, foliohog), .SDcols = c("men")] %>%
```

**Se guarda la base de datos**
```{r}
#fwrite(smenores.alimentacion, paste0(here::here(), "/Output/Data/menores22.csv"), row.names = F)
save(menores.alimentacion, file = paste0(here::here(), "/Output/Data/menores22.RData"))
```


##### Grado de inseguridad alimentaria

```{r}
load(file = paste0(here::here(), "/Data/hogares.RData")) 
```

```{r}
alimentacion <- hogares %>% 
                 # Parte 1. Grado de inseguridad alimentaria
                 mutate(
                        # Seis preguntas para hogares sin poblaci贸n menor a 18 a帽os
                        # Alg煤n adulto tuvo una alimentaci贸n basada en muy poca variedad de alimentos
                        ia_1ad = case_when(.$acc_alim4 == 2 ~ 0, # No
                                           .$acc_alim4 == 1 ~ 1, # S铆
                                           is.na(.$acc_alim4) ~ 0), # No
                        # Alg煤n adulto dej贸 de desayunar, comer o cenar
                        ia_2ad = case_when(.$acc_alim5 == 2 ~ 0,  # No
                                           .$acc_alim5 == 1 ~ 1, # S铆
                                           is.na(.$acc_alim5) ~ 0),  # No
                        # Alg煤n adulto comi贸 menos de lo que deb铆a comer
                        ia_3ad = case_when(.$acc_alim6 == 2 ~ 0,  # No
                                           .$acc_alim6 == 1 ~ 1, # S铆
                                           is.na(.$acc_alim6) ~ 0),  # No
                        # El hogar se qued贸 sin comida
                        ia_4ad = case_when(.$acc_alim2 == 2 ~ 0,  # No
                                           .$acc_alim2 == 1 ~ 1, # S铆
                                           is.na(.$acc_alim2) ~ 0), # No
                        # Alg煤n adulto sinti贸 hambre pero no comi贸
                        ia_5ad = case_when(.$acc_alim7 == 2 ~ 0, # No
                                           .$acc_alim7 == 1 ~ 1, # S铆
                                           is.na(.$acc_alim7) ~ 0), # No
                        # Alg煤n adulto solo comi贸 una vez al d铆a o dej贸 de comer todo un d铆a
                        ia_6ad = case_when(.$acc_alim8 == 2 ~ 0,  # No
                                           .$acc_alim8 == 1 ~ 1, # S铆
                                           is.na(.$acc_alim8) ~ 0), # No
            
                        # Seis preguntas para hogares sin poblaci贸n menor a 18 a帽os
            
                        # Alguien de 0 a 17 a帽os tuvo una alimentaci贸n basada en muy poca variedad de alimentos
                        ia_7men = case_when(.$acc_alim11 == 2 ~ 0, # No
                                            .$acc_alim11 == 1 ~ 1, # S铆
                                            is.na(.$acc_alim11) ~ 0), # No
                        # Alguien de 0 a 17 a帽os comi贸 menos de lo que deb铆a
                        ia_8men = case_when(.$acc_alim12 == 2 ~ 0, # No
                                            .$acc_alim12 == 1 ~ 1, # S铆
                                            is.na(.$acc_alim12) ~ 0), # No
                        # Se tuvo que disminuir la cantidad servida en las comidas a alguien de 0 a 17 a帽os
                        ia_9men = case_when(.$acc_alim13 == 2 ~ 0, # No
                                            .$acc_alim13 == 1 ~ 1, # S铆
                                            is.na(.$acc_alim13) ~ 0), # No
                        # Alguien de 0 a 17 a帽os sinti贸 hambre pero no comi贸
                        ia_10men  =case_when(.$acc_alim14 == 2 ~ 0, # No
                                             .$acc_alim14 == 1 ~ 1, # S铆
                                             is.na(.$acc_alim14) ~ 0), # No
                        # Alguien de 0 a 17 a帽os se acost贸 con hambre
                        ia_11men = case_when(.$acc_alim15 == 2 ~ 0, # No
                                             .$acc_alim15 == 1 ~ 1, # S铆
                                             is.na(.$acc_alim15) ~ 0), # No
                        # Alguien de 0 a 17 a帽os comi贸 una vez al d铆a o dej贸 de comer todo un d铆a
                        ia_12men = case_when(.$acc_alim16 == 2 ~ 0, # No
                                             .$acc_alim16 == 1 ~ 1, # S铆
                                             is.na(.$acc_alim16) ~ 0) # No
                        ) %>%
                 # Construcci贸n de la escala de inseguridad alimentaria
                 left_join(., menores.alimentacion, by = c("folioviv", "foliohog")) %>%
                  mutate(
                         # Escala para hogares sin menores de 18 a帽os
                         tot_iaad = case_when(id_men == 0 ~ .$ia_1ad + .$ia_2ad + .$ia_3ad + .$ia_4ad + .$ia_5ad + .$ia_6ad),
                         # Escala para hogares con menores de 18 a帽os
                         tot_iamen = case_when(id_men == 1 ~ .$ia_1ad + .$ia_2ad + .$ia_3ad + .$ia_4ad + .$ia_5ad + .$ia_6ad + .$ia_7men + .$ia_8men + .$ia_9men + .$ia_10men + .$ia_11men + .$ia_12men)) %>% 
                  mutate(
                         # Grado de inseguridad alimentaria
                         ins_ali = case_when(
                                             # Seguridad alimentaria  
                                             .$tot_iaad == 0 | .$tot_iamen == 0 ~ 0, 
                                             # Inseguridad alimentaria leve
                                             .$tot_iaad == 1 | .$tot_iaad == 2 | .$tot_iamen == 1 | .$tot_iamen == 2 | .$tot_iamen == 3 ~ 1,
                                             # Inseguridad alimentaria moderada
                                             .$tot_iaad == 3 | .$tot_iaad == 4 | .$tot_iamen == 4 | .$tot_iamen == 5 | .$tot_iamen == 6 | .$tot_iamen == 7 ~ 2,
                                             # Inseguridad alimentaria severa
                                             .$tot_iaad == 5 | .$tot_iaad == 6 | .$tot_iamen >= 8 & !is.na(.$tot_iamen) ~ 3)) %>%
                  # Se genera el indicador de carencia por acceso a la alimentaci贸n que  considera en situaci贸n de carencia a la poblaci贸n en hogares que  
                  # presenten inseguridad alimentaria moderada o severa.

                  mutate(
                         # Indicador de carencia por acceso a la alimentaci贸n  
                         ic_ali = case_when(.$ins_ali == 2 | .$ins_ali == 3 ~ 1, # Con carencia
                                            .$ins_ali == 0 | .$ins_ali == 1 ~ 0)) # Sin carencia
```

##### Limitaci贸n en el consumo de alimentos  

Se considera el n煤mero de d铆as que se consumieron cada uno de los 12 grupos  de alimentos por el ponderador utilizado por el Programa Mundial de Alimentos (`PMA`) de las Naciones Unidas:   

`Grupo 1`: (ma铆z, avena, arroz, sorgo, mijo, pan y otros cereales) y (yuca, papas, camotes y otros tub茅rculos)  
`Grupo 2`: frijoles, ch铆charos, cacahuates, nueces  
`Grupo 3`: vegetales y hojas  
`Grupo 4`: frutas  
`Grupo 5`: carne de res, cabra, aves, cerdo, huevos y pescado  
`Grupo 6`: leche, yogur y otros l谩cteos  
`Grupo 7`: az煤cares y productos azucarados  
`Grupo 8`: aceites, grasas y mantequilla  
`Grupo 9`: especias, t茅, caf茅, sal, polvo de pescado, peque帽as cantidades de leche para el t茅  

El ponderador para el `Grupo 1` es 2, para el `Grupo 2` es 3, para el `Grupo 3` y `Grupo 4` es 1, para el `Grupo 5` y `Grupo 6` es 4, para el `Grupo 7` y `Grupo 8` es 0.5, y para el `Grupo 9` es 0.    


```{r}
alimentacion <- alimentacion %>%
                 mutate(
                        cpond1 = if_else(.$alim17_1 > .$alim17_2, .$alim17_1, .$alim17_2) * 2,
                        cpond3  = .$alim17_3  * 1,
                        cpond4  = .$alim17_4  * 1,
                        cpond5  = apply(.[,c("alim17_5", "alim17_6", "alim17_7")], 1, max) * 4,
                        cpond8  = .$alim17_8  * 3   ,
                        cpond9  = .$alim17_9  * 4   ,
                        cpond10 = .$alim17_10 * 0.5 ,
                        cpond11 = .$alim17_11 * 0.5 ,
                        cpond12 = .$alim17_12 * 0 
                        ) %>%
                 mutate(
                        # Puntaje total de consumo ponderado de alimentos, indica el n煤mero ponderado 
                        # de grupos de alimentos que se consumieron en los 煤ltimos siete d铆as     
                        tot_cpond = .$cpond1 + .$cpond3 + .$cpond4 + .$cpond5 + .$cpond8 + .$cpond9 + .$cpond10 + .$cpond11 + .$cpond12
                        ) %>%
                 mutate(
                        # Se categoriza la dieta consumida en los hogares
                        # Dieta consumida en los hogares              
                        dch = case_when(.$tot_cpond >=  0 & .$tot_cpond <= 28   ~ 1,  # Pobre 
                                        .$tot_cpond >  28 & .$tot_cpond <= 42   ~ 2,  # Lim铆trofe
                                        .$tot_cpond >  42 & !is.na(.$tot_cpond) ~ 3)) %>% # Aceptable
                 mutate(
                        # Limitaci贸n en el consumo de Alimentos
                        lca = case_when(.$dch == 1 | .$dch == 2 ~ 1,   # Limitado
                                        .$dch == 3 ~ 0))           # No
```


##### Indicador de carencia por acceso a la alimentaci贸n nutritiva y de calidad   

Se considera en situaci贸n de carencia por acceso a la alimentaci贸n nutritiva y de calidad a la poblaci贸n en hogares que presenten, al menos, una de las siguientes caracter铆sticas:
  
1. Grado inseguridad alimentaria moderada o severa.   
2. Limitaci贸n en el consumo de alimentos.  


```{r}
alimentacion <- alimentacion %>%
                 mutate(
                        ic_ali_nc = case_when(.$ic_ali == 0 & .$lca == 0 ~ 0, # Sin carencia
                                              (.$ic_ali == 1 | .$lca == 1) &
                                               (!is.na(.$ic_ali) & !is.na(.$lca)) ~ 1)) %>% # Con carencia
                  select(folioviv, foliohog, id_men, starts_with("ia_"), tot_iaad, tot_iamen, ins_ali, dch, lca, ic_ali, ic_ali_nc)
```


**Se guarda la base de datos**
```{r}
#fwrite(alimentacion, paste0(here::here(), "/Output/Data/ic_ali22.csv"), row.names = F)
save(alimentacion, file = paste0(here::here(), "/Output/Data/ic_ali22.RData"))
```


#### VII. Bienestar econ贸mico (ingresos) {.tabset .tabset-pills}   

##### Ingresos

Para la construcci贸n del ingreso corriente del hogar es necesario utilizar informaci贸n sobre la condici贸n de ocupaci贸n y los ingresos de los individuos.  
Se utiliza la informaci贸n contenida en la base trabajo.csv para identificar a la poblaci贸n ocupada que declara tener como prestaci贸n laboral aguinaldo, ya sea por su trabajo principal o secundario, a fin de incorporar los ingresos por este concepto en la medici贸n

Creaci贸n del ingreso monetario deflactado a pesos de agosto del 2022   

```{r}
load(file = paste0(here::here(), "/Data/trabajos.RData")) 
```


```{r}
aguinaldos <- trabajos %>% 
               select(folioviv, foliohog, numren, id_trabajo, pres_2) %>% 
                as.data.table() %>% 
                 dcast(folioviv + foliohog + numren ~ id_trabajo,
                        value.var = "pres_2") %>% 
                  mutate(
                         # Poblaci贸n con al menos un empleo 
                         trab = 1,
                         # Aguinaldo trabajo principal
                         aguinaldo1 = case_when(.$`1` == 2 ~ 1,  # Dispone de aguinaldo
                                                TRUE ~ 0),   # No dispone de aguinaldo
                         # Aguinaldo trabajo secundario
                         aguinaldo2 = case_when(`2` == 2 ~ 1,   # Dispone de aguinaldo
                                                TRUE ~ 0)) %>% # No dispone de aguinaldo
                   select(folioviv, foliohog, numren, aguinaldo1, aguinaldo2, trab)
```


**Se guarda la base de datos**
```{r}
#fwrite(aguinaldos, paste0(here::here(), "/Output/Data/aguinaldo22.csv"), row.names = F)
save(aguinaldos, file = paste0(here::here(), "/Output/Data/aguinaldo22.RData"))
```


**Ahora se incorpora a la base de ingresos**

```{r}
load(file = paste0(here::here(), "/Data/ingresos.RData")) 
```


```{r}
ingresos <- ingresos %>%
             full_join(., aguinaldos, by = c("folioviv", "foliohog", "numren")) %>%
              mutate(index = case_when(.$clave == "P009" & .$aguinaldo1 != 1 ~ 1,
                                       .$clave == "P016" & .$aguinaldo2 != 1 ~ 1,
                                       TRUE ~ 0)) %>%
               filter(index != 1)
```

Una vez realizado lo anterior, se procede a deflactar el ingreso recibido por los hogares a precios de agosto de 2022. Para ello, se utilizan las variables meses, las cuales toman los valores 2 a 10 e indican el mes en que se recibi贸 el ingreso respectivo.   

**Definici贸n de los deflactores 2022**   

```{r}
{
  dic21	<-	0.94753762025
  ene22	<-	0.95314330024
  feb22	<-	0.96105102461
  mar22	<-	0.97056614137
  abr22	<-	0.97581641802
  may22	<-	0.97753689329
  jun22	<-	0.98579194365
  jul22	<-	0.99309386687
  ago22	<-	1.00000000000
  sep22	<-	1.00620340379
  oct22	<-	1.01189793462
  nov22	<-	1.01772170303
  dic22	<-	1.02160690775
}
```

```{r}
ingresos <- ingresos %>%
             mutate( 
                    ing_6 = ifelse(is.na(.$mes_6), 
                                    .$ing_6,
                                     case_when(.$mes_6 == 2  ~ .$ing_6/feb22,
                                               .$mes_6 == 3  ~ .$ing_6/mar22,
                                               .$mes_6 == 4  ~ .$ing_6/abr22,
                                               .$mes_6 == 5  ~ .$ing_6/may22)),
                    ing_5 = ifelse(is.na(.$mes_5), 
                                    .$ing_5,
                                     case_when(.$mes_5 == 3  ~ .$ing_5/mar22,
                                               .$mes_5 == 4  ~ .$ing_5/abr22,
                                               .$mes_5 == 5  ~ .$ing_5/may22,
                                               .$mes_5 == 6  ~ .$ing_5/jun22)),
                    ing_4 = ifelse(is.na(.$mes_4), 
                                    .$ing_4,
                                     case_when(.$mes_4 == 4  ~ .$ing_4/abr22,
                                               .$mes_4 == 5  ~ .$ing_4/may22,
                                               .$mes_4 == 6  ~ .$ing_4/jun22,
                                               .$mes_4 == 7  ~ .$ing_4/jul22)),
                    ing_3 = ifelse(is.na(.$mes_3), 
                                    .$ing_3,
                                     case_when(.$mes_3 == 5  ~ .$ing_3/may22,
                                               .$mes_3 == 6  ~ .$ing_3/jun22,
                                               .$mes_3 == 7  ~ .$ing_3/jul22,
                                               .$mes_3 == 8  ~ .$ing_3/ago22)),
                    ing_2 = ifelse(is.na(.$mes_2), 
                                    .$ing_2,
                                     case_when(.$mes_2 == 6  ~ .$ing_2/jun22,
                                               .$mes_2 == 7  ~ .$ing_2/jul22,
                                               .$mes_2 == 8  ~ .$ing_2/ago22,
                                               .$mes_2 == 9  ~ .$ing_2/sep22)),
                    ing_1 = ifelse(is.na(.$mes_1), 
                                    .$ing_1,
                                     case_when(.$mes_1 == 7  ~ .$ing_1/jul22,
                                               .$mes_1 == 8  ~ .$ing_1/ago22,
                                               .$mes_1 == 9  ~ .$ing_1/sep22,
                                               .$mes_1 == 10 ~ .$ing_1/oct22))) 
```

Se deflactan las claves P008 y P015 (Reparto de utilidades) y P009 y P016 (aguinaldo) con los deflactores de mayo a agosto 2022 y de diciembre de 2021 a agosto 2022, respectivamente, y se obtiene el promedio mensual.   

```{r} 
index <-c("P008", "P009", "P015", "P016") 
```

```{r}
ingresos <- ingresos %>%
             mutate(ing_1 = ifelse(.$clave == "P008" | .$clave == "P015", 
                                    (.$ing_1/may22)/12, 
                                      .$ing_1), 
                    ing_1 = ifelse(.$clave == "P009" | .$clave == "P016", 
                                    (.$ing_1/dic21)/12, 
                                      .$ing_1),
                    ing_2 = ifelse((.$clave %in%  index) & .$ing_2 == 0, 
                                    NA_real_, 
                                     ing_2),
                    ing_3 = ifelse((.$clave %in%  index) & .$ing_3 == 0, 
                                    NA_real_, 
                                     .$ing_3),
                    ing_4 = ifelse((.$clave %in%  index) & .$ing_4 == 0, 
                                    NA_real_, 
                                     .$ing_4),
                    ing_5 = ifelse((.$clave %in%  index) & .$ing_5 == 0, 
                                    NA_real_, 
                                     .$ing_5),
                    ing_6 = ifelse((.$clave %in%  index) & .$ing_6 == 0, 
                                    NA_real_, 
                                     .$ing_6)) %>%
              # Una vez realizada la deflactaci贸n, se procede a obtener el ingreso mensual promedio en los 煤ltimos seis meses, para cada persona y clave de ingreso 
             mutate(
                    ing_mens = apply(.[,c("ing_1","ing_2","ing_3","ing_4","ing_5","ing_6")], 1, mean, na.rm = TRUE)) %>%
             mutate(
                    # Para obtener el ingreso corriente monetario, se seleccionan las claves de ingreso correspondientes
                    ing_mon = case_when((.$clave >= "P001" & .$clave <= "P009") | (.$clave >= "P011" & .$clave <= "P016") |
                                        (.$clave >= "P018" & .$clave <= "P048") | (.$clave >= "P067" & .$clave <= "P081") |
                                         (.$clave >= "P101" & .$clave <= "P108") ~ .$ing_mens ),
                    # Para obtener el ingreso laboral, se seleccionan las claves de ingreso correspondientes
                    ing_lab = case_when((.$clave >= "P001" & .$clave <= "P009") | (.$clave >= "P011" & .$clave <= "P016") |
                                        (.$clave >= "P018" & .$clave <= "P022") | (.$clave >= "P067" & .$clave <= "P081") ~ .$ing_mens ), 
                    # Para obtener el ingreso por rentas, se seleccionan las claves de ingreso correspondientes
                    ing_ren = case_when((.$clave >= "P023" & .$clave <= "P031") ~ .$ing_mens ), 
                    # Para obtener el ingreso por transferencias, se seleccionan las claves de ingreso correspondientes 
                    ing_tra = case_when((.$clave >= "P032" & .$clave <= "P048") | (.$clave >= "P101" & .$clave <= "P108") ~ .$ing_mens )
                    ) %>%
              # Se estima el total de ingresos de cada  hogar
              group_by(folioviv, foliohog) %>%
               summarise(across(c(ing_mon, ing_lab, ing_ren, ing_tra), sum, na.rm = TRUE)) %>%
                ungroup() 
```

**Se guarda la base de datos**
```{r}
#fwrite(ingresos, paste0(here::here(), "/Output/Data/ingreso_deflactado22.csv"), row.names = F)
save(ingresos, file = paste0(here::here(), "/Output/Data/ingreso_deflactado22.RData"))
```


##### No Monetario  

En el caso de la informaci贸n de gasto no monetario, para deflactar se utiliza la decena de levantamiento de la encuesta, la cual se encuentra en la octava posici贸n del folio de la vivienda. En primer lugar se obtiene una variable que identifique la decena de levantamiento.   

Creaci贸n del ingreso no monetario deflactado a pesos de agosto del 2022.  

```{r}
load(file = paste0(here::here(), "/Data/gastoshogar.RData")) 
load(file = paste0(here::here(), "/Data/gastospersona.RData"))

gastoshogar <- gastoshogar %>% 
                mutate(base = 1)

gastospersona <- gastospersona  %>% 
                  mutate(base = 2) 
```

```{r}
no.monetario <- gastospersona %>%
                 bind_rows(., gastoshogar) %>%
                  mutate(frecuencia = ifelse(.$base == 2, 
                                              .$frec_rem, 
                                               .$frecuencia), 
                          # En el caso de la informaci贸n de gasto no monetario, para deflactar se utiliza la decena 
                          # de levantamiento de la encuesta, la cual se encuentra en la octava posici贸n del folio de la vivienda. 
                          # En primer lugar se obtiene una variable que identifique la decena de levantamiento.
                         decena = str_sub(str_pad(.$folioviv, 10, "left", pad = "0"), 8, 8))
```

**Definici贸n de los deflactores**

```{r}
# Rubro 1.1 semanal, Alimentos		
  d11w07	<-	0.9869825057
  d11w08	<-	1.0000000000
  d11w09	<-	1.0130754464
  d11w10	<-	1.0178275200
  d11w11	<-	1.0207468579
  
  # Rubro 1.2 semanal, Bebidas alcoh贸licas y tabaco		
  d12w07	<-	0.9923340135
  d12w08	<-	1.0000000000
  d12w09	<-	1.0035071112
  d12w10	<-	1.0111808568
  d12w11	<-	1.0131982216
  
  # Rubro 2 trimestral, Vestido, calzado y accesorios		
  d2t05	<-	0.9899050815
  d2t06	<-	0.9941003723
  d2t07	<-	0.9997465345
  d2t08	<-	1.0083352270
  
  # Rubro 3 mensual, viviendas		
  d3m07	<-	0.9998142481
  d3m08	<-	1.0000000000
  d3m09	<-	0.9978682753
  d3m10	<-	1.0031577830
  d3m11	<-	1.0197073965
  
  # Rubro 4.2 mensual, Accesorios y art铆culos de limpieza para el hogar		
  d42m07	<-	0.9894769136
  d42m08	<-	1.0000000000
  d42m09	<-	1.0086286240
  d42m10	<-	1.0182083142
  d42m11	<-	1.0237613131
  
  # Rubro 4.2 trimestral, Accesorios y art铆culos de limpieza para el hogar		
  d42t05	<-	0.9787953163
  d42t06	<-	0.9897197934
  d42t07	<-	0.9993685126
  d42t08	<-	1.0089456461
  
  # Rubro 4.1 semestral, Muebles y aparatos d贸mesticos		
  d41s02	<-	1.0003069312
  d41s03	<-	0.9993861376
  d41s04	<-	0.9992122603
  d41s05	<-	0.9991442214
  
  # Rubro 5.1 trimestral, Salud		
  d51t05	<-	0.9909917367
  d51t06	<-	0.9954834527
  d51t07	<-	0.9994564693
  d51t08	<-	1.0030487384
  
  # Rubro 6.1.1 semanal, Transporte p煤blico urbano		
  d611w07	<-	0.9963207274
  d611w08	<-	1.0000000000
  d611w09	<-	1.0034865488
  d611w10	<-	1.0052385833
  d611w11	<-	1.0064912880
  
  # Rubro 6 mensual, Transporte		
  d6m07	<-	0.9987845893
  d6m08	<-	1.0000000000
  d6m09	<-	1.0001664946
  d6m10	<-	1.0057274150
  d6m11	<-	1.0076837268
  
  # Rubro 6 semestral, Transporte		
  d6s02	<-	0.9808628306
  d6s03	<-	0.9879901879
  d6s04	<-	0.9927380596
  d6s05	<-	0.9969378864
  
  # Rubro 7 mensual, Educaci贸n y esparcimiento		
  d7m07	<-	0.9961413091
  d7m08	<-	1.0000000000
  d7m09	<-	1.0095233900
  d7m10	<-	1.0144128271
  d7m11	<-	1.0174522069
  
  # Rubro 2.3 mensual, Accesorios y cuidados del vestido		
  d23m07	<-	0.9952443607
  d23m08	<-	1.0000000000
  d23m09	<-	1.0081869233
  d23m10	<-	1.0108184343
  d23m11	<-	1.0072323555
  
  # Rubro 2.3 trimestral,  Accesorios y cuidados del vestido		
  d23t05	<-	0.9914948875
  d23t06	<-	0.9956428139
  d23t07	<-	1.0011437613
  d23t08	<-	1.0063351192
  
  # INPC semestral		
  dINPCs02 <-	0.9773093813
  dINPCs03 <-	0.9838008772
  dINPCs04 <-	0.9897404209
  dINPCs05 <-	0.9957540070
```


**Una vez definidos los deflactores, se seleccionan los rubros** 

```{r}
no.monetario <- no.monetario %>%
                 mutate(gasnomon = .$gas_nm_tri/3,
                        esp = if_else(.$tipo_gasto == "G4", 1, NA_real_),
                        reg = if_else(.$tipo_gasto == "G5" | .$tipo_gasto == "G6", 1, NA_real_))  %>%
                 filter(!(tipo_gasto %in% c("G2", "G3", "G7"))) %>%
                 # Control para la frecuencia de los regalos recibidos por persona
                 filter(!(((frecuencia >= 5 & frecuencia <= 6) | is.na(frecuencia) | frecuencia == 0) & base == 1 & tipo_gasto == "G5")) %>%
                 filter(!(((frecuencia == 9) | is.na(frecuencia)) & base == 2 & tipo_gasto == "G5")) %>%
                 mutate(
                        # Se definen las asignaciones para las diferentes claves de ingreso
                        ali_nm = if_else(between(.$clave, "A001", "A222") | between(.$clave, "A242", "A247"), .$gasnomon, NA_real_),
                        alta_nm = if_else(between(.$clave, "A223", "A241"), .$gasnomon, NA_real_),
                        veca_nm = if_else(between(.$clave, "H001", "H122") | .$clave == "H136", .$gasnomon, NA_real_),
                        viv_nm = if_else(between(.$clave, "G001", "G016") | between(.$clave, "R001", "R004") | .$clave == "R013", .$gasnomon, NA_real_),
                        lim_nm = if_else(between(.$clave, "C001", "C024"), .$gasnomon, NA_real_),
                        cris_nm = if_else(between(.$clave, "I001", "I026"), .$gasnomon, NA_real_),
                        ens_nm = if_else(between(.$clave, "K001", "K037"), .$gasnomon, NA_real_),
                        sal_nm = if_else(between(.$clave, "J001", "J072"), .$gasnomon, NA_real_),
                        tpub_nm = if_else(between(.$clave, "B001", "B007"), .$gasnomon, NA_real_),
                        tfor_nm = if_else(between(.$clave, "M001", "M018") | between(.$clave, "F007", "F014"), .$gasnomon, NA_real_),
                        com_nm = if_else(between(.$clave, "F001", "F006") | between(.$clave, "R005", "R008") | between(.$clave, "R010", "R011"), .$gasnomon, NA_real_),
                        edre_nm = if_else(between(.$clave, "E001", "E034") | between(.$clave, "H134", "H135") | between(.$clave, "L001", "L029") | between(.$clave, "N003", "N005") | .$clave == "R009", .$gasnomon, NA_real_),
                        edba_nm = if_else((between(.$clave, "E002", "E003") | between(.$clave, "H134", "H135")), .$gasnomon, NA_real_),
                        cuip_nm = if_else(between(.$clave, "D001", "D026") | .$clave == "H132", .$gasnomon, NA_real_),
                        accp_nm = if_else(between(.$clave, "H123", "H131") | .$clave == "H133", .$gasnomon, NA_real_),
                        otr_nm = if_else(between(.$clave, "N001", "N002") | between(.$clave, "N006", "N016") | between(.$clave, "T901", "T915") | .$clave == "R012", .$gasnomon, NA_real_),
                        
                        reda_nm = if_else(between(.$clave, "T901", "T915") | .$clave == "N013", .$gasnomon, NA_real_)
                        ) %>% 
                 # Se deflactan los rubros del gasto no monetario seg煤n la decena de levantamiento
                   mutate(
                          # Gasto no monetario en Alimentos deflactado (semanal)
                          ali_nm = case_when(.$decena %in% c(1, 2, 3) ~ .$ali_nm/d11w08,
                                             .$decena %in% c(4, 5, 6) ~ .$ali_nm/d11w09,
                                             .$decena %in% c(7, 8, 9) ~ .$ali_nm/d11w10,
                                             .$decena %in% c(0) ~ .$ali_nm/d11w11),
                          # Gasto no monetario en Alcohol y tabaco deflactado (semanal)
                          alta_nm = case_when(.$decena %in% c(1,2,3) ~ .$alta_nm/d12w08,
                                              .$decena %in% c(4,5,6) ~ .$alta_nm/d12w09,
                                              .$decena %in% c(7,8,9) ~ .$alta_nm/d12w10,
                                              .$decena %in% c(0) ~ .$alta_nm/d12w11),
                          # Gasto no monetario en Vestido y calzado deflactado (trimestral)
                          veca_nm = case_when(.$decena %in% c(1,2) ~ .$veca_nm/d2t05,
                                              .$decena %in% c(3,4,5) ~ .$veca_nm/d2t06,
                                              .$decena %in% c(6,7,8) ~ .$veca_nm/d2t07,
                                              .$decena %in% c(9,0) ~ .$veca_nm/d2t08),
                          # Gasto no monetario en viviendas y servicios de conservaci贸n deflactado (mensual)
                          viv_nm = case_when(.$decena %in% c(1,2) ~ .$viv_nm/d3m07,
                                             .$decena %in% c(3,4,5) ~ .$viv_nm/d3m08,
                                             .$decena %in% c(6,7,8) ~ .$viv_nm/d3m09,
                                             .$decena %in% c(9,0) ~ .$viv_nm/d3m10),
                          # Gasto no monetario en Art铆culos de limpieza deflactado (mensual)
                          lim_nm = case_when(.$decena %in% c(1,2) ~ .$lim_nm/d42m07,
                                             .$decena %in% c(3,4,5) ~ .$lim_nm/d42m08,
                                             .$decena %in% c(6,7,8) ~ .$lim_nm/d42m09,
                                             .$decena %in% c(9,0) ~ .$lim_nm/d42m10),
                          # Gasto no monetario en Cristaler铆a y blancos deflactado (trimestral)
                          cris_nm = case_when(.$decena %in% c(1,2) ~ .$cris_nm/d42t05,
                                              .$decena %in% c(3,4,5) ~ .$cris_nm/d42t06,
                                              .$decena %in% c(6,7,8) ~ .$cris_nm/d42t07,
                                              .$decena %in% c(9,0) ~ .$cris_nm/d42t08),
                          # Gasto no monetario en Enseres dom茅sticos y muebles deflactado (semestral)
                          ens_nm = case_when(.$decena %in% c(1,2) ~ .$ens_nm/d41s02,
                                             .$decena %in% c(3,4,5) ~ .$ens_nm/d41s03,
                                             .$decena %in% c(6,7,8) ~ .$ens_nm/d41s04,
                                             .$decena %in% c(9,0) ~ .$ens_nm/d41s05),
                          # Gasto no monetario en Salud deflactado (trimestral)
                          sal_nm = case_when(.$decena %in% c(1,2) ~ .$sal_nm/d51t05,
                                             .$decena %in% c(3,4,5) ~ .$sal_nm/d51t06,
                                             .$decena %in% c(6,7,8) ~ .$sal_nm/d51t07,
                                             .$decena %in% c(9,0) ~ .$sal_nm/d51t08),
                          # Gasto no monetario en Transporte p煤blico deflactado (semanal)
                          tpub_nm = case_when(.$decena %in% c(1,2,3) ~ .$tpub_nm/d611w08,
                                              .$decena %in% c(4,5,6) ~ .$tpub_nm/d611w09,
                                              .$decena %in% c(7,8,9) ~ .$tpub_nm/d611w10,
                                              .$decena %in% c(0) ~ .$tpub_nm/d611w11),
                          # Gasto no monetario en Transporte for谩neo deflactado (semestral)
                          tfor_nm = case_when(.$decena %in% c(1,2) ~ .$tfor_nm/d6s02,
                                              .$decena %in% c(3,4,5) ~ .$tfor_nm/d6s03,
                                              .$decena %in% c(6,7,8) ~ .$tfor_nm/d6s04,
                                              .$decena %in% c(9,0) ~ .$tfor_nm/d6s05),
                          # Gasto no monetario en Comunicaciones deflactado (mensual)
                          com_nm = case_when(.$decena %in% c(1,2) ~ .$com_nm/d6m07,
                                             .$decena %in% c(3,4,5) ~ .$com_nm/d6m08,
                                             .$decena %in% c(6,7,8) ~ .$com_nm/d6m09,
                                             .$decena %in% c(9,0) ~ .$com_nm/d6m10),
                          # Gasto no monetario en Educaci贸n y recreaci贸n deflactado (mensual)
                          edre_nm = case_when(.$decena %in% c(1,2) ~ .$edre_nm/d7m07,
                                              .$decena %in% c(3,4,5) ~ .$edre_nm/d7m08,
                                              .$decena %in% c(6,7,8) ~ .$edre_nm/d7m09,
                                              .$decena %in% c(9,0) ~ .$edre_nm/d7m10),
                          # Gasto no monetario en Educaci贸n b谩sica deflactado (mensual)
                          edba_nm = case_when(.$decena %in% c(1,2) ~ .$edba_nm/d7m07,
                                              .$decena %in% c(3,4,5) ~ .$edba_nm/d7m08,
                                              .$decena %in% c(6,7,8) ~ .$edba_nm/d7m09,
                                              .$decena %in% c(9,0) ~ .$edba_nm/d7m10),
                          # Gasto no monetario en Cuidado personal deflactado (mensual)
                          cuip_nm = case_when(.$decena %in% c(1,2) ~ .$cuip_nm/d23m07,
                                              .$decena %in% c(3,4,5) ~ .$cuip_nm/d23m08,
                                              .$decena %in% c(6,7,8) ~ .$cuip_nm/d23m09,
                                              .$decena %in% c(9,0) ~ .$cuip_nm/d23m10),
                          # Gasto no monetario en Accesorios personales deflactado (trimestral)
                          accp_nm = case_when(.$decena %in% c(1,2) ~ .$accp_nm/d23t05,
                                              .$decena %in% c(3,4,5) ~ .$accp_nm/d23t06,
                                              .$decena %in% c(6,7,8) ~ .$accp_nm/d23t07,
                                              .$decena %in% c(9,0) ~ .$accp_nm/d23t08),
                           # Gasto no monetario en Otros gastos y transferencias deflactado (semestral)
                          otr_nm = case_when(.$decena %in% c(1,2) ~ .$otr_nm/dINPCs02,
                                             .$decena %in% c(3,4,5) ~ .$otr_nm/dINPCs03,
                                             .$decena %in% c(6,7,8) ~ .$otr_nm/dINPCs04,
                                             .$decena %in% c(9,0) ~ .$otr_nm/dINPCs05),
                          # Gasto no monetario en Regalos Otorgados deflactado
                          reda_nm = case_when(.$decena %in% c(1,2) ~ .$reda_nm/dINPCs02,
                                              .$decena %in% c(3,4,5) ~ .$reda_nm/dINPCs03,
                                              .$decena %in% c(6,7,8) ~ .$reda_nm/dINPCs04,
                                              .$decena %in% c(9,0) ~ .$reda_nm/dINPCs05))
```

**Se guarda la base de datos**
```{r}
#fwrite(no.monetario, paste0(here::here(), "/Output/Data/ingresonomonetario_def22.csv"), row.names = F)
save(no.monetario, file = paste0(here::here(), "/Output/Data/ingresonomonetario_def22.RData"))
```

**Construcci贸n de la base de pagos en especie a partir de la base de gasto no monetario**  

```{r}
pagos.especie <- no.monetario %>%
                  filter(esp == 1) %>%
                   group_by(folioviv, foliohog) %>% 
                    summarise(across(all_of(names(.)[endsWith(names(.), "_nm")]), ~sum(., na.rm = TRUE))) %>%
                     rename_with(~ paste0(., "e"), 4:20)
```


**Se guarda la base de datos**
```{r}
#fwrite(pagos.especie, paste0(here::here(), "/Output/Data/esp_def22.csv"), row.names = F)
save(pagos.especie, file = paste0(here::here(), "/Output/Data/esp_def22.RData"))
```

**Construcci贸n de base de regalos a partir de la base no monetaria**  

```{r}
regalos <- no.monetario %>% 
            filter(reg == 1) %>%
             group_by(folioviv, foliohog) %>% 
              summarise(across(all_of(names(.)[endsWith(names(.), "_nm")]), ~sum(., na.rm = TRUE))) %>%
               rename_with(~ paste0(., "r"), 4:20)
```


**Se guarda la base de datos**
```{r}
#fwrite(regalos, paste0(here::here(), "/Output/Data/reg_def22.csv"), row.names = F)
save(regalos, file = paste0(here::here(), "/Output/Data/reg_def22.RData"))
```



### Construcci贸n del ingreso corriente total   {.tabset .tabset-pills .top2-tiles} 

#### Ingreso corriente total {}

```{r}
load(file = paste0(here::here(), "/Data/concentradohogar.RData")) 
load(file = paste0(here::here(), "/Output/Data/ingreso_deflactado22.RData"))
load(file = paste0(here::here(), "/Output/Data/esp_def22.RData"))
```

```{r}
ingreso.corriente <- concentradohogar %>%
                      select(folioviv, foliohog, tam_loc, factor, tot_integ, est_dis, upm, ubica_geo) %>% 
                       # Incorporaci贸n de la base de ingreso monetario deflactado
                       left_join(., ingresos, by = c("folioviv", "foliohog")) %>% 
                       # Incorporaci贸n de la base de ingreso no monetario deflactado: pago en especie
                       left_join(., pagos.especie, by = c("folioviv", "foliohog")) %>% 
                       # Incorporaci贸n de la base de ingreso no monetario deflactado: regalos en especie
                       left_join(., regalos, by = c("folioviv", "foliohog")) %>% 
                        mutate(
                               rururb = case_when(.$tam_loc == 4 ~ 1, # Rural
                                                  .$tam_loc <= 3 ~ 0), # Urbano
                               pago_esp = apply(.[,c("ali_nme", "alta_nme", "veca_nme", "viv_nme", 
                                                     "lim_nme", "cris_nme", "ens_nme", "sal_nme", 
                                                     "tpub_nme", "tfor_nme", "com_nme", "edre_nme", 
                                                     "cuip_nme", "accp_nme", "otr_nme")], 
                                                1, 
                                                 sum, 
                                                  na.rm = TRUE), 
                              reg_esp  = apply(.[,c("ali_nmr", "alta_nmr", "veca_nmr", "viv_nmr", 
                                                      "lim_nmr", "cris_nmr", "ens_nmr", "sal_nmr", 
                                                      "tpub_nmr", "tfor_nmr", "com_nmr", "edre_nmr", 
                                                      "cuip_nmr", "accp_nmr", "otr_nmr")], 
                                                1, 
                                                 sum, 
                                                  na.rm = TRUE)) %>% 
                        mutate(
                               nomon = apply(.[,c("pago_esp","reg_esp")], 1, sum, na.rm = TRUE)) %>%
                        # Se construye el Ingreso Corriente Total con el ingreso monetario  y el ingreso no monetario 
                        mutate(ict = apply(.[,c("ing_mon", "nomon")], 1, sum, na.rm = TRUE)) %>% 
                         select(!c(gasto_nm.x, gasto_nm.y))
```

**Se guarda la base de datos**
```{r}
#fwrite(ingreso.corriente, paste0(here::here(), "/Output/Data/ingresotot22.csv"), row.names = F)
save(ingreso.corriente, file = paste0(here::here(), "/Output/Data/ingresotot22.RData"))
```


#### Construcci贸n del tama帽o de hogar con econom铆as de escala y escalas de equivalencia   {.tabset .tabset-pills} 

```{r}
tam_hogar.escala <- poblacion %>% 
                     # Poblaci贸n objetivo: no se incluye a hu茅spedes ni trabajadores dom茅sticos
                     filter(!(parentesco >= 400 & parentesco < 500 | parentesco >= 700 & parentesco < 800)) %>%
                      mutate(ind = 1) %>%
                       group_by(folioviv, foliohog) %>%
                        mutate(tot_ind = sum(ind, na.rm = TRUE)) %>%
                         ungroup() %>%
                          # Escalas de equivalencia  
                          mutate(tamhogesc = case_when(.$tot_ind == 1 ~ 1,
                                                       .$edad <= 5 ~ .7031,
                                                       .$edad >= 6 & .$edad<=12 ~ .7382,
                                                       .$edad >= 13 & .$edad<=18 ~ .7057,
                                                       .$edad >= 19 & !is.na(.$edad) ~ .9945)) %>%
                           select(folioviv, foliohog, numren, tamhogesc) %>% 
                            group_by(folioviv, foliohog) %>%
                             summarise(tamhogesc = sum(tamhogesc, na.rm = TRUE)) %>%
                              ungroup()
```

**Se guarda la base de datos**
```{r}
#fwrite(tam_hogar.escala, paste0(here::here(), "/Output/Data/tamhogesc22.csv"), row.names = F)
save(tam_hogar.escala, file = paste0(here::here(), "/Output/Data/tamhogesc22.RData"))
```


#### Bienestar econ贸mico {.tabset .tabset-pills} 

Incorporaci贸n de la informaci贸n sobre el tama帽o del hogar ajustado

```{r}
load(file = paste0(here::here(), "/Output/Data/ingresotot22.RData"))
load(file = paste0(here::here(), "/Output/Data/tamhogesc22.RData"))
```

**Indicadores de Bienestar econ贸mico**    

`LP I`: Valor de la Canasta alimentaria   
`LP II`: Valor monetario de la canasta alimentaria m谩s el valor monetario de la canasta no alimentaria (ver Anexo A del documento metodol贸gico).    

En este programa se construyen los indicadores de bienestar econ贸mico mediante las 2 l铆neas definidas por CONEVAL, denomin谩ndolas:   
  
`lp1` : L铆nea de Pobreza Extrema por Ingresos (`LPEI`)   
`lp2` : L铆nea de Pobreza por Ingresos (`LPI`)    

Para m谩s informaci贸n, se sugiere consultar el documento metodol贸gico de Construcci贸n de las l铆neas de pobreza por ingresos. Disponible en: https://www.coneval.org.mx/InformesPublicaciones/InformesPublicaciones/Documents/Lineas_pobreza.pdf     

```{r}
#L铆nea de pobreza extrema por ingresos (LPEI);
# Valor monetario de la canasta alimentaria;
lp1_urb <- 2086.21
lp1_rur <- 1600.18

# L铆nea de pobreza por ingresos (LPI)
# Valor monetario de la canasta alimentaria m谩s el valor monetario de la canasta no alimentaria
lp2_urb <- 4158.35
lp2_rur <- 2970.76
```


```{r}
p_ingreso <- ingreso.corriente %>% 
              left_join(., tam_hogar.escala, by = c("folioviv", "foliohog")) %>% 
               # Informaci贸n per c谩pita
               mutate(ictpc = .$ict/.$tamhogesc) %>% 
               # Se identifica a los hogares bajos de la l铆nea de la pobreza
               mutate(
                      # Se identifica a los hogares bajo lp1
                      plp_e = case_when(.$ictpc < lp1_urb  & .$rururb == 0  ~ 1,
                                        .$ictpc >= lp1_urb  & .$rururb == 0 & !is.na(.$ictpc) ~ 0,
                                        .$ictpc < lp1_rur  & .$rururb == 1  ~ 1,
                                        .$ictpc >= lp1_rur  & .$rururb == 1 & !is.na(.$ictpc) ~ 0),
                      # Se identifica a los hogares bajo lp2
                      plp = case_when(.$ictpc < lp2_urb  & .$rururb == 0  ~ 1,
                                      .$ictpc >= lp2_urb  & .$rururb == 0 & !is.na(.$ictpc) ~ 0,
                                      .$ictpc < lp2_rur  & .$rururb == 1  ~ 1,
                                      .$ictpc >= lp2_rur  & .$rururb == 1 & !is.na(.$ictpc) ~ 0)) %>% 
                select(folioviv, foliohog, factor, tam_loc, rururb, tamhogesc, ict, ictpc, plp_e, plp, est_dis, upm, ubica_geo, 
                       tot_integ, ing_mon, ing_lab, ing_ren, ing_tra, nomon, pago_esp, reg_esp)  
```


**Se guarda la base de datos**
```{r}
#fwrite(p_ingreso, paste0(here::here(), "/Output/Data/p_ingresos22.csv"), row.names = F)
save(p_ingreso, file = paste0(here::here(), "/Output/Data/p_ingresos22.RData"))
```


## Pobreza multidimensional  {.tabset .tabset-pills .top3-tiles} 

### Integraci贸n de las bases 

**Se vuelven a cargar las bases de datos**  

```{r}
# Rezago eductivo 
load(file = paste0(here::here(), "/Output/Data/ic_rezedu22.RData"))
# Carencia por acceso a los servicios de salud
load(file = paste0(here::here(), "/Output/Data/ic_asalud22.RData"))
# Carencia por acceso a la seguridad social
load(file = paste0(here::here(), "/Output/Data/ic_segsoc22.RData"))
# Carencia por calidad y espacios de la vivienda
load(file = paste0(here::here(), "/Output/Data/ic_cev22.RData"))
# Carencia por acceso a los servicios b谩sicos de la vivienda
load(file = paste0(here::here(), "/Output/Data/ic_sbv22.RData"))
# Carencia por acceso a la alimentaci贸n nutritiva y de calidad 
load(file = paste0(here::here(), "/Output/Data/ic_ali22.RData"))
# L铆nea de pobreza por ingresos (LPI)
load(file = paste0(here::here(), "/Output/Data/p_ingresos22.RData"))
```

Se integran las seis bases de datos.  

```{r}
require(tidyr)
pobreza <- rezago.educativo %>%  
            left_join(., salud, by = c("folioviv", "foliohog", "numren")) %>% 
             left_join(., seguridad.social, by = c("folioviv", "foliohog", "numren")) %>% 
              left_join(., calidad.viviendas, by = c("folioviv", "foliohog")) %>% 
               left_join(., servicios.basicos, by = c("folioviv", "foliohog")) %>% 
                left_join(., alimentacion, by = c("folioviv", "foliohog")) %>% 
                 left_join(., p_ingreso, by = c("folioviv", "foliohog")) %>% 
                  mutate_at(vars(c(ing_mon, ing_lab, ing_ren, ing_tra)),  ~ if_else(is.na(.), 0, .)) %>% 
                   # Se eliminan posibles duplicados
                   distinct(folioviv, foliohog, numren, .keep_all = TRUE) %>% 
                    mutate(
                           folioviv = str_pad(.$folioviv, 10, "left", pad = "0"),
                           ent = as.numeric(str_sub(.$folioviv, 1,2))) %>%
                    mutate(          
                           entidad = case_when(.$ent == 1  ~ "Aguascalientes",
                                               .$ent == 2  ~ "Baja California",
                                               .$ent == 3  ~ "Baja California Sur",
                                               .$ent == 4  ~ "Campeche",
                                               .$ent == 5  ~ "Coahuila",
                                               .$ent == 6  ~ "Colima",
                                               .$ent == 7  ~ "Chiapas",
                                               .$ent == 8  ~ "Chihuahua",
                                               .$ent == 9  ~ "Ciudad de M茅xico",
                                               .$ent == 10 ~	"Durango",
                                               .$ent == 11 ~	"Guanajuato",
                                               .$ent == 12 ~	"Guerrero",
                                               .$ent == 13 ~	"Hidalgo",
                                               .$ent == 14 ~	"Jalisco",
                                               .$ent == 15 ~	"M茅xico",
                                               .$ent == 16 ~	"Michoac谩n",
                                               .$ent == 17 ~	"Morelos",
                                               .$ent == 18 ~	"Nayarit",
                                               .$ent == 19 ~	"Nuevo Le贸n",
                                               .$ent == 20 ~	"Oaxaca",
                                               .$ent == 21 ~	"Puebla",
                                               .$ent == 22 ~	"Quer茅taro",
                                               .$ent == 23 ~	"Quintana Roo",
                                               .$ent == 24 ~	"San Luis Potos铆",
                                               .$ent == 25 ~	"Sinaloa",
                                               .$ent == 26 ~	"Sonora",
                                               .$ent == 27 ~	"Tabasco",
                                               .$ent == 28 ~	"Tamaulipas",
                                               .$ent == 29 ~	"Tlaxcala",
                                               .$ent == 30 ~	"Veracruz",
                                               .$ent == 31 ~	"Yucat谩n",
                                               .$ent == 32 ~	"Zacatecas"))
```


### ndice de Privaci贸n Social 

```{r}
pobreza <- pobreza %>%
            group_by(folioviv, foliohog, numren) %>%
             mutate(i_privacion = sum(ic_rezedu, ic_asalud, ic_segsoc, ic_cv, ic_sbv, ic_ali_nc, 
                                      na.rm = TRUE)) %>%
              ungroup()
```


### Pobreza multidimensional 

```{r}
pobreza <- pobreza %>% 
            mutate(
                  # Pobreza
                  pobreza = case_when(.$plp == 1 & (.$i_privacion >= 1 & !is.na(.$i_privacion)) ~ 1, # Pobre
                                       (.$plp == 0 | .$i_privacion == 0) & (!is.na(.$plp) & !is.na(.$i_privacion)) ~ 0), # No pobre
                  # Pobreza extrema
                  pobreza_e = case_when(.$plp_e == 1 & (.$i_privacion >= 3 & !is.na(.$i_privacion)) ~ 1, # Pobre extremo
                                          (.$plp_e == 0 | .$i_privacion < 3 ) & (!is.na(.$plp_e) & !is.na(.$i_privacion)) ~ 0)) %>% # No pobre extremo
           mutate(
                  # Pobreza moderada
                  pobreza_m = case_when(.$pobreza == 1 & .$pobreza_e == 0 ~ 1, # Pobre moderado 
                                         .$pobreza == 0 | (.$pobreza == 1 & .$pobreza_e == 1) ~ 0) # No pobre moderado
                  )
```


### Poblaci贸n vulnerable

```{r}
pobreza <- pobreza %>% 
            mutate(
                   # Vulnerables por carencias
                   vul_car = case_when(.$plp == 0 & (.$i_privacion >= 1 & !is.na(.$i_privacion)) ~ 1, # Vulnerable
                                        is.na(.$pobreza) ~ NA_real_,
                                         TRUE ~ 0), # No vulnerable
                   # Vulnerables por ingresos
                   vul_ing = case_when(.$plp == 1 & .$i_privacion == 0 ~ 1, # Vulnerable
                                        is.na(.$pobreza)~  NA_real_,
                                         TRUE~0)) # No vulnerable
```


### Poblaci贸n no pobre y no vulnerable 

```{r}
pobreza <- pobreza %>% 
            mutate(
                   # Poblaci贸n no pobre y no vulnerable
                   no_pobv = case_when(.$plp == 0 & .$i_privacion == 0 ~ 1,  # Vulnerable
                                        is.na(.$pobreza) ~ NA_real_,
                                         TRUE ~ 0))  # No vulnerable
```


### Poblaci贸n con carencias sociales   

```{r}
pobreza <- pobreza %>% 
            mutate(
                   # Poblaci贸n con al menos una carencia
                   carencias = case_when(.$i_privacion >= 1 & !is.na(.$i_privacion) ~ 1, # Poblaci贸n con al menos una carencia
                                          is.na(.$pobreza) ~ NA_real_,
                                           TRUE ~ 0), # Poblaci贸n sin carencias
                   # Poblaci贸n con tres o m谩s carencias                  
                   carencias3 = case_when(.$i_privacion >= 3 & !is.na(.$i_privacion) ~ 1, # Poblaci贸n con al menos tres o m谩s carencias
                                           is.na(.$pobreza) ~ NA_real_,
                                            TRUE ~ 0)) # Poblaci贸n con menos de tres carencias
```


### Cuadrantes

```{r}
pobreza <- pobreza %>% 
            mutate(
                   cuadrantes=case_when(.$plp == 1 & (.$i_privacion >= 1 & !is.na(.$i_privacion)) ~ 1, # Pobres
                                        .$plp == 0 & (.$i_privacion >= 1 & !is.na(.$i_privacion)) ~ 2, # Vulnerables por carencias
                                        .$plp == 1 & .$i_privacion == 0 ~ 3,  # Vulnerables por ingresos     
                                        .$plp == 0 & .$i_privacion == 0 ~ 4))  # No pobres y no vulnerables
```


### Profundidad en el espacio del bienestar econ贸mico  

```{r}
#L铆nea de pobreza extrema por ingresos (LPEI);
# Valor monetario de la canasta alimentaria
lp1_urb <- 2086.21
lp1_rur <- 1600.18

# L铆nea de pobreza por ingresos (LPI)
# Valor monetario de la canasta alimentaria m谩s el valor monetario de la canasta no alimentaria
lp2_urb <- 4158.35
lp2_rur <- 2970.76
```


```{r}
pobreza <- pobreza %>% 
            mutate( 
                   # FGT (a=1)
                   # Distancia normalizada del ingreso respecto a la l铆nea de pobreza por ingresos
                   prof1 = case_when(.$rururb ==1 & .$plp == 1 ~ (lp2_rur - .$ictpc)/(lp2_rur), 
                                     .$rururb ==0 & .$plp == 1 ~ (lp2_urb - .$ictpc)/(lp2_urb),
                                     !is.na(.$ictpc) ~ 0),
                   # Distancia normalizada del ingreso respecto a la l铆nea de pobreza extrema por ingresos
                   prof_e1 = case_when(.$rururb==1 & .$plp_e == 1 ~ (lp1_rur - .$ictpc)/(lp1_rur),
                                       .$rururb==0 & .$plp_e == 1 ~ (lp1_urb - .$ictpc)/(lp1_urb),
                                        !is.na(.$ictpc) ~ 0))
```


### Profundidad de la privaci贸n social  

```{r}
pobreza <- pobreza %>% 
            mutate( 
                   profun = .$i_privacion/6
                   ) %>% 
               #   Intensidad de la privaci贸n social      
            mutate(        
                   ### Intensidad de la privaci贸n social: pobres
                   int_pob = .$profun * .$pobreza,
                   
                   ### Intensidad de la privaci贸n social: pobres extremos
                   int_pobe = .$profun * .$pobreza_e,
                   
                   ### Intensidad de la privaci贸n social: Poblaci贸n vulnerable por carencias
                   int_vulcar = .$profun * .$vul_car,
                   
                   ### Intensidad de la privaci贸n social: Poblaci贸n con carencias sociales
                   int_caren = .$profun * .$carencias) %>% 
             select( folioviv, foliohog, numren, est_dis.x, upm.x, factor.x, tam_loc, rururb, ent, ubica_geo, edad.x, sexo, parentesco.x,
                     ic_rezedu, anac_e, inas_esc.x, niv_ed, ic_asalud, ic_segsoc,sa_dir, ss_dir, s_salud.x, par.x, jef_ss, cony_ss,
                     hijo_ss, pea.x, jub, pam, ing_pam, ic_cv, icv_pisos, icv_muros, icv_techos, icv_hac, ic_sbv, isb_agua, isb_dren,
                     isb_luz, isb_combus, ic_ali_nc, id_men, tot_iaad, tot_iamen, ins_ali, ic_ali, lca, dch, plp_e, plp, 
                     pobreza, pobreza_e, pobreza_m, vul_car, vul_ing, no_pobv,  i_privacion, carencias, carencias3, cuadrantes, 
                     prof1, prof_e1, profun,  int_pob, int_pobe, int_vulcar, int_caren,tamhogesc, ictpc, ict, ing_mon, 
                     ing_lab, ing_ren, ing_tra, nomon, pago_esp, reg_esp, hli, discap)
```


```{r}
pobreza <- pobreza %>%
            rename("est_dis" = "est_dis.x",
                   "upm" = "upm.x",
                   "factor" = "factor.x",
                   "edad" = "edad.x",
                   "parentesco" = "parentesco.x",
                   "inas_esc" = "inas_esc.x",
                   "s_salud" = "s_salud.x",
                   "par" = "par.x",
                   "pea" = "pea.x")
```

**Se guarda la base de datos**
```{r}
#fwrite(pobreza, paste0(here::here(), "/Output/Data/pobreza_22.csv"), row.names = F)
save(pobreza, file = paste0(here::here(), "/Output/Data/pobreza_22.RData"))
```

## Resultados 

###  Nivel nacional 

```{r}
pob_w <- pobreza %>% 
          as_survey_design(weights = factor, 
                            nest = TRUE) %>% 
           filter(!is.na(pobreza))

vars  <- c("pobreza", "pobreza_m", "pobreza_e", "vul_car", "vul_ing", "no_pobv", "carencias", "carencias3", "ic_rezedu", 
           "ic_asalud", "ic_segsoc", "ic_cv", "ic_sbv", "ic_ali_nc", "plp_e", "plp")

por <- pob_w %>%  
        select(vars) %>% 
         summarise_all(survey_mean, vartype = NULL) %>%  
          round(digits = 6) %>%
           t() %>% 
            as.data.frame() %>%
             mutate_at(vars(1),function(x) x * 100)

tot <- pob_w %>%  
        select(vars) %>% 
         summarise_all(survey_total, vartype = NULL) %>%  
          t() %>% 
           as.data.frame() %>%
            mutate_at(vars(1),function(x) x / 1000000) 


nac <- bind_cols(por, tot)

rownames(nac) <-vars
colnames(nac) <- c("Porcentaje", "Millones de personas")
```



###  Porcentaje y n煤mero de personas por indicador de pobreza, entidad federativa.   

```{r}
vars  <- c("pobreza", "pobreza_m", "pobreza_e", "vul_car", "vul_ing", "no_pobv")

pob_ent_por <- pob_w %>% 
                group_by(ent) %>%  
                 select(vars) %>%
                  summarise_all(survey_mean, vartype = NULL)

pob_ent_tot <- pob_w %>% 
                group_by(ent) %>%  
                 select(vars) %>%
                  summarise_all(survey_total, vartype = NULL)

pob_ent <- pob_ent_por %>% 
            left_join(., pob_ent_tot, 
                       by = "ent")
```


###  Porcentaje y n煤mero de personas por indicador de carencia social, entidad federativa.    

```{r}
vars  <- c("ic_rezedu", "ic_asalud", "ic_segsoc", "ic_cv", "ic_sbv", "ic_ali_nc", "carencias", "carencias3", "plp_e", "plp")

care_ent_por <- pob_w %>% 
                 group_by(ent) %>%  
                  select(vars) %>%
                   summarise_all(survey_mean, vartype = NULL)

care_ent_tot <- pob_w %>% 
                 group_by(ent) %>%  
                  select(vars) %>%
                   summarise_all(survey_total, vartype = NULL)

pob_ent <- pob_ent %>% 
            left_join(., care_ent_por, by = "ent") %>% 
             left_join(care_ent_tot, by = "ent")
```


**Se guarda la base de datos final **
```{r}
#fwrite(pob_ent, paste0(here::here(), "/Output/Data/indice de pobreza a nivel entidad.csv"), row.names = F)
save(pob_ent, file = paste0(here::here(), "/Output/Data/indice de pobreza a nivel entidad.RData"))
```