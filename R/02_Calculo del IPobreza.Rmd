---
title: "Cálculo del índice"
subtitle: 'Índice de pobreza 2022'
author: "Diana Villasana Ocampo"
output:
   html_document:
      highlight: tango
      theme: flatly
      toc: yes
      toc_depth: 2
      toc_float:
        collapsed: yes
---

\usepackage{color}

```{=html}
<style>
code.r{
  font-size: 10px;
}
pre {
  font-size: 12px
}
</style>

<style>
body {
text-align: justify;
font-style: normal;
font-family: "Montserrat";
font-size: 12px
}
h1.title {
  font-size: 40px;
  color: #000D3B;
}
h1 {
  color: #B6854D;
}
h2 {
  color: #172984;
}
h3 {
  color: #172984;
}
</style>
```

```{=html}
<style>
.nav>li>a {
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #0A2687;
}
.nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus {
    color: #ffffff;
    background-color: #09C2BC;
}
</style>
```

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = FALSE, cache.lazy = FALSE, 
                         eval = FALSE, class.source = "fold-show")
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(digits = 2, encoding = "UTF8")
```   
 

```{r, echo=FALSE}
rm(list = ls())
```

```{r, echo=FALSE}
setwd(here::here())
```

**Librerías que se utilizaron en el documento**

```{r}
if (!require(pacman)) install.packages("pacman")
library(pacman) ; p_load("data.table", "tidyverse", "gdata", "srvyr", "bit64")
```

## Medición multidimensional del índice de pobreza 2022 {.tabset .tabset-pills}       

Se sigue la estructura del índice de pobreza, presentado en la página oficial del CONEVAL.   

De acuerdo con los Lineamientos y criterios generales para la definición, identificación y medición de la pobreza (2018) que se pueden consultar en el [Diario Oficial de la Federación](https://www.dof.gob.mx/nota_detalle.php?codigo=5542421&fecha=30/10/2018) y la Metodología para la medición multidimensional de la pobreza en México, tercera edición (https://www.coneval.org.mx/InformesPublicaciones/InformesPublicaciones/Documents/Metodologia-medicion-multidimensional-3er-edicion.pdf).   

Siguiendo la estructura del cálculo del índice multidimensional de la pobreza, se simplifican los códigos para entender el orden del cálculo de los indicadores sociodemográficos.      


### Indicadores de carencias sociales  {.tabset .tabset-pills}    

#### Indicador de rezago educativo  

```{r}
poblacion <- load(file = paste0(here::here(), "/Data/poblacion.RData")) %>% 
              rename_all(tolower)
```

**Indicador de carencia por rezago educativo `ic_rezedu`**

Se considera en situación de carencia por rezago educativo a la población que cumpla con alguno de los siguientes criterios:

1. Tiene de tres a 21 años, no cuenta con la educación obligatoria y no asiste a un centro de educación formal. 
2. Tiene 22 años o más, nació a partir del año 1998 y no ha terminado la educación obligatoria (media superior).   
3. Tiene 16 años o más, nació entre 1982 y 1997 y no cuenta con el nivel de educación obligatorio vigente en el momento en que debía haberlo cursado (secundaria completa).   
4. Tiene 16 años o más, nació antes de 1982 y no cuenta con el nivel de educación obligatorio vigente en el momento en que debía haberlo cursado (primaria completa).	  


```{r}
rezago.educativo <- poblacion %>%
                     filter(!(parentesco >= 400 & parentesco < 500 | parentesco >= 700 & parentesco < 800)) %>%
                      mutate(# Año de nacimiento
                             anac_e = case_when(!is.na(edad) ~ 2022 - edad),
                             # Inasistencia escolar (se reporta para personas de 3 años o más)
                             inas_esc = case_when(.$asis_esc == 1 ~ 0 ,  # Sí asiste
                                                  .$asis_esc == 2 ~ 1),  # No asiste
                             # Nivel educativo  
                             niv_ed = case_when(
                                                # Con primaria incompleta o menos
                                                (.$nivelaprob < 2) | (.$nivelaprob == 2 & .$gradoaprob < 6) ~ 0, 
                                                # Primaria completa o secundaria incompleta
                                                (.$nivelaprob == 2 & .$gradoaprob == 6) | 
                                                 (.$nivelaprob == 3 & .$gradoaprob < 3) | 
                                                  (.$nivelaprob == 5 | .$nivelaprob == 6) & 
                                                    .$gradoaprob < 3 & 
                                                     .$antec_esc == 1 ~ 1,
                                                # Secundaria completa o media superior incompleta
                                                (.$nivelaprob == 3 & .$gradoaprob == 3) | 
                                                 (.$nivelaprob == 4 & .$gradoaprob < 3) | 
                                                  (.$nivelaprob == 5 & .$antec_esc == 1 & .$gradoaprob >= 3) |
                                                   (.$nivelaprob == 6 & .$antec_esc == 1 & .$gradoaprob >= 3) | 
                                                    (.$nivelaprob == 5 & .$antec_esc == 2 & .$gradoaprob < 3) | 
                                                     (.$nivelaprob == 6 & .$antec_esc == 2 & .$gradoaprob < 3) ~ 2, 
                                                # Media superior completa o mayor nivel educativo
                                                (.$nivelaprob == 4 & .$gradoaprob == 3) | 
                                                 (.$nivelaprob == 5 & .$antec_esc == 2 & .$gradoaprob>=3) | 
                                                  (.$nivelaprob == 6 & .$antec_esc == 2 & .$gradoaprob>=3) |
                                                   (.$nivelaprob == 5 & .$antec_esc > 2) | 
                                                    (.$nivelaprob == 6 & .$antec_esc > 2) |
                                                     (.$nivelaprob >= 7 & !is.na(.$nivelaprob)) ~ 3),
                             # Hablante de lengua indígena 
                             hli = case_when(.$hablaind == 1 & edad >= 3 ~ 1,   # Habla lengua indígena
                                             .$hablaind == 2 & edad >= 3 ~ 0)) %>%  # No habla lengua indígena
                       # Indicador de carencia por rezago educativo 
                        mutate(ic_rezedu = case_when(
                                                     # Presenta carencia
                                                      .$anac_e >= 1998 & (.$edad >= 3 & .$edad <= 21) & .$inas_esc == 1 & .$niv_ed < 3 ~ 1, # Presenta carencia
                                                     (.$anac_e >= 1982 & .$anac_e <= 1997) & .$edad >= 16 & .$niv_ed < 2 ~ 1, # Presenta carencia
                                                      .$anac_e <= 1981 & .$edad >= 16 & .$niv_ed == 0 ~ 1, # Presenta carencia
                                                      .$anac_e >= 1998 & .$edad >= 22 & .$niv_ed < 3 ~ 1, # Presenta carencia
                                                     # No presenta carencia             
                                                      .$edad >= 0 & .$edad <=2 ~ 0, 
                                                      .$anac_e >= 1998 & (.$edad >= 3 & .$edad <= 21) & .$inas_esc == 0 ~ 0, # No presenta carencia
                                                      .$niv_ed == 3 ~ 0, # No presenta carencia
                                                     (.$anac_e >= 1982 & .$anac_e <= 1997) & .$edad >= 16 & (.$niv_ed >= 2 & !is.na(.$niv_ed)) ~ 0, # No presenta carencia
                                                      .$anac_e <= 1981 & .$edad >= 16 & (.$niv_ed >= 1 & !is.na(.$niv_ed)) ~ 0)) %>% # No presenta carencia)     
                         select(folioviv, folioviv, foliohog, numren, edad, anac_e, inas_esc, niv_ed, ic_rezedu, parentesco, hli)
```


**Se guarda la base de datos**
```{r}
fwrite(rezago.educativo, paste0(here::here(), "/Output/Data/ic_rezedu22.csv"), row.names = F)
save(rezago.educativo, file = paste0(here::here(), "/Output/Data/ic_rezedu22.RData"))
gdata::keep(rezago.educativo, poblacion, sure = T)
```


#### Indicador de carencia por acceso a los servicios de salud

```{r}
load(file = paste0(here::here(), "/Data/trabajos.RData")) %>% 
```

```{r}
ocupados <- trabajos %>%
             mutate(
                    # Tipo de trabajador: identifica la población subordinada e independiente
                    tipo_trab = case_when(
                                          #Subordinados
                                          .$subor == 1 ~ 1,
                                          #Independientes que reciben un pago
                                          .$subor == 2 & .$indep == 1 & .$tiene_suel == 1 ~ 2,
                                          .$subor == 2 & .$indep == 2 & .$pago == 1 ~ 2,
                                          #Independientes que no reciben un pago
                                          .$subor == 2 & .$indep == 1 & .$tiene_suel == 2 ~ 3,
                                          .$subor == 2 & .$indep == 2 & (.$pago == 2 | .$pago == 3) ~ 3),
                    # Ocupación principal o secundaria
                    ocupa = case_when(.$id_trabajo == 1 ~ 1, 
                                      .$id_trabajo == 2 ~ 1)) %>% 
              select(folioviv, foliohog, numren, id_trabajo, tipo_trab, ocupa) %>%
              # Distinción de prestaciones en trabajo principal y secundario
               as.data.table() %>%
                dcast(folioviv + foliohog + numren ~  id_trabajo, 
                       value.var = c("tipo_trab", "ocupa"), 
                        sep = "", 
                         fill = 0) %>% 
                 as.data.frame()
```


**Formato .RData**

```{r}
save(concentradohogar, file = paste0(here::here(), "/Data/concentradohogar.RData"))
save(gastoshogar, file = paste0(here::here(), "/Data/gastoshogar.RData"))
save(gastospersona, file = paste0(here::here(), "/Data/gastospersona.RData"))
save(hogares, file = paste0(here::here(), "/Data/hogares.RData"))
save(ingresos, file = paste0(here::here(), "/Data/ingresos.RData"))
save(poblacion, file = paste0(here::here(), "/Data/poblacion.RData"))
save(trabajos, file = paste0(here::here(), "/Data/trabajos.RData"))
save(viviendas, file = paste0(here::here(), "/Data/viviendas.RData"))
```


