---
title: "Cálculo del índice"
subtitle: 'Índice de pobreza 2022'
author: "Diana Villasana Ocampo"
output:
   html_document:
      highlight: tango
      theme: flatly
      toc: yes
      toc_depth: 2
      toc_float:
        collapsed: yes
---

\usepackage{color}

```{=html}
<style>
code.r{
  font-size: 10px;
}
pre {
  font-size: 12px
}
</style>

<style>
body {
text-align: justify;
font-style: normal;
font-family: "Montserrat";
font-size: 12px
}
h1.title {
  font-size: 40px;
  color: #000D3B;
}
h1 {
  color: #B6854D;
}
h2 {
  color: #172984;
}
h3 {
  color: #172984;
}
</style>
```

```{=html}
<style>
.nav>li>a {
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #0A2687;
}
.nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus {
    color: #ffffff;
    background-color: #09C2BC;
}
</style>
```

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = FALSE, cache.lazy = FALSE, 
                         eval = FALSE, class.source = "fold-show")
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(digits = 2, encoding = "UTF8")
```   
 

```{r, echo=FALSE}
rm(list = ls())
```

```{r, echo=FALSE}
setwd(here::here())
```

**Librerías que se utilizaron en el documento**

```{r}
if (!require(pacman)) install.packages("pacman")
library(pacman) ; p_load("data.table", "tidyverse", "gdata", "srvyr", "bit64")
```

## Medición multidimensional del índice de pobreza 2022 {.tabset .tabset-pills}       

Se sigue la estructura del índice de pobreza, presentado en la página oficial del CONEVAL.   

De acuerdo con los Lineamientos y criterios generales para la definición, identificación y medición de la pobreza (2018) que se pueden consultar en el [Diario Oficial de la Federación](https://www.dof.gob.mx/nota_detalle.php?codigo=5542421&fecha=30/10/2018) y la Metodología para la medición multidimensional de la pobreza en México, tercera edición (https://www.coneval.org.mx/InformesPublicaciones/InformesPublicaciones/Documents/Metodologia-medicion-multidimensional-3er-edicion.pdf).   

Siguiendo la estructura del cálculo del índice multidimensional de la pobreza, se simplifican los códigos para entender el orden del cálculo de los indicadores sociodemográficos.      


### Indicadores de carencias sociales  {.tabset .tabset-pills}    

#### I. Indicador de rezago educativo  

```{r}
load(file = paste0(here::here(), "/Data/poblacion.RData")) 
```

**Indicador de carencia por rezago educativo `ic_rezedu`**

Se considera en situación de carencia por rezago educativo a la población que cumpla con alguno de los siguientes criterios:

1. Tiene de tres a 21 años, no cuenta con la educación obligatoria y no asiste a un centro de educación formal. 
2. Tiene 22 años o más, nació a partir del año 1998 y no ha terminado la educación obligatoria (media superior).   
3. Tiene 16 años o más, nació entre 1982 y 1997 y no cuenta con el nivel de educación obligatorio vigente en el momento en que debía haberlo cursado (secundaria completa).   
4. Tiene 16 años o más, nació antes de 1982 y no cuenta con el nivel de educación obligatorio vigente en el momento en que debía haberlo cursado (primaria completa).	  


```{r}
rezago.educativo <- poblacion %>%
                     filter(!(parentesco >= 400 & parentesco < 500 | parentesco >= 700 & parentesco < 800)) %>%
                      mutate(# Año de nacimiento
                             anac_e = case_when(!is.na(edad) ~ 2022 - edad),
                             # Inasistencia escolar (se reporta para personas de 3 años o más)
                             inas_esc = case_when(.$asis_esc == 1 ~ 0 ,  # Sí asiste
                                                  .$asis_esc == 2 ~ 1),  # No asiste
                             # Nivel educativo  
                             niv_ed = case_when(
                                                # Con primaria incompleta o menos
                                                (.$nivelaprob < 2) | (.$nivelaprob == 2 & .$gradoaprob < 6) ~ 0, 
                                                # Primaria completa o secundaria incompleta
                                                (.$nivelaprob == 2 & .$gradoaprob == 6) | 
                                                 (.$nivelaprob == 3 & .$gradoaprob < 3) | 
                                                  (.$nivelaprob == 5 | .$nivelaprob == 6) & 
                                                    .$gradoaprob < 3 & 
                                                     .$antec_esc == 1 ~ 1,
                                                # Secundaria completa o media superior incompleta
                                                (.$nivelaprob == 3 & .$gradoaprob == 3) | 
                                                 (.$nivelaprob == 4 & .$gradoaprob < 3) | 
                                                  (.$nivelaprob == 5 & .$antec_esc == 1 & .$gradoaprob >= 3) |
                                                   (.$nivelaprob == 6 & .$antec_esc == 1 & .$gradoaprob >= 3) | 
                                                    (.$nivelaprob == 5 & .$antec_esc == 2 & .$gradoaprob < 3) | 
                                                     (.$nivelaprob == 6 & .$antec_esc == 2 & .$gradoaprob < 3) ~ 2, 
                                                # Media superior completa o mayor nivel educativo
                                                (.$nivelaprob == 4 & .$gradoaprob == 3) | 
                                                 (.$nivelaprob == 5 & .$antec_esc == 2 & .$gradoaprob>=3) | 
                                                  (.$nivelaprob == 6 & .$antec_esc == 2 & .$gradoaprob>=3) |
                                                   (.$nivelaprob == 5 & .$antec_esc > 2) | 
                                                    (.$nivelaprob == 6 & .$antec_esc > 2) |
                                                     (.$nivelaprob >= 7 & !is.na(.$nivelaprob)) ~ 3),
                             # Hablante de lengua indígena 
                             hli = case_when(.$hablaind == 1 & edad >= 3 ~ 1,   # Habla lengua indígena
                                             .$hablaind == 2 & edad >= 3 ~ 0)) %>%  # No habla lengua indígena
                       # Indicador de carencia por rezago educativo 
                        mutate(ic_rezedu = case_when(
                                                     # Presenta carencia
                                                      .$anac_e >= 1998 & (.$edad >= 3 & .$edad <= 21) & .$inas_esc == 1 & .$niv_ed < 3 ~ 1, # Presenta carencia
                                                     (.$anac_e >= 1982 & .$anac_e <= 1997) & .$edad >= 16 & .$niv_ed < 2 ~ 1, # Presenta carencia
                                                      .$anac_e <= 1981 & .$edad >= 16 & .$niv_ed == 0 ~ 1, # Presenta carencia
                                                      .$anac_e >= 1998 & .$edad >= 22 & .$niv_ed < 3 ~ 1, # Presenta carencia
                                                     # No presenta carencia             
                                                      .$edad >= 0 & .$edad <=2 ~ 0, 
                                                      .$anac_e >= 1998 & (.$edad >= 3 & .$edad <= 21) & .$inas_esc == 0 ~ 0, # No presenta carencia
                                                      .$niv_ed == 3 ~ 0, # No presenta carencia
                                                     (.$anac_e >= 1982 & .$anac_e <= 1997) & .$edad >= 16 & (.$niv_ed >= 2 & !is.na(.$niv_ed)) ~ 0, # No presenta carencia
                                                      .$anac_e <= 1981 & .$edad >= 16 & (.$niv_ed >= 1 & !is.na(.$niv_ed)) ~ 0)) %>% # No presenta carencia)     
                         select(folioviv, folioviv, foliohog, numren, edad, anac_e, inas_esc, niv_ed, ic_rezedu, parentesco, hli)
```


**Se guarda la base de datos**
```{r}
#fwrite(rezago.educativo, paste0(here::here(), "/Output/Data/ic_rezedu22.csv"), row.names = F)
save(rezago.educativo, file = paste0(here::here(), "/Output/Data/ic_rezedu22.RData"))
gdata::keep(rezago.educativo, poblacion, sure = T)
```


#### II. Indicador de carencia por acceso a los servicios de salud

```{r}
load(file = paste0(here::here(), "/Data/trabajos.RData")) 
```

**Indicador de carencia por servicios de salud `ic_asalud`**  

Se considera en situación de carencia por acceso a servicios de salud a la población que:    
 
 1. No se encuentra inscrita al Seguro Popular* o afiliada a alguna institución  por prestación laboral, contratación voluntaria o afiliación de un familiar por parentesco directo a recibir servicios médicos por alguna institución que los preste como: las instituciones de seguridad social (`IMSS`, `ISSSTE federal o estatal`, `Pemex`, `Ejército` o `Marina`), los servicios médicos privados, u otra institución médica.      
 
 - Se reporta la población que respondió estar afiliado o inscrito al Seguro Popular, o que tiene derecho a los servicios del
 Instituto de Salud para el Bienestar (`INSABI`), lo anterior de acuerdo con el cuestionario de la ENIGH 2022.    

```{r}
ocupados <- trabajos %>%
             mutate(
                    # Tipo de trabajador: identifica la población subordinada e independiente
                    tipo_trab = case_when(
                                          #Subordinados
                                          .$subor == 1 ~ 1,
                                          #Independientes que reciben un pago
                                          .$subor == 2 & .$indep == 1 & .$tiene_suel == 1 ~ 2,
                                          .$subor == 2 & .$indep == 2 & .$pago == 1 ~ 2,
                                          #Independientes que no reciben un pago
                                          .$subor == 2 & .$indep == 1 & .$tiene_suel == 2 ~ 3,
                                          .$subor == 2 & .$indep == 2 & (.$pago == 2 | .$pago == 3) ~ 3),
                    # Ocupación principal o secundaria
                    ocupa = case_when(.$id_trabajo == 1 ~ 1, 
                                      .$id_trabajo == 2 ~ 1)) %>% 
              select(folioviv, foliohog, numren, id_trabajo, tipo_trab, ocupa) %>%
              # Distinción de prestaciones en trabajo principal y secundario
               as.data.table() %>%
                dcast(folioviv + foliohog + numren ~  id_trabajo, 
                       value.var = c("tipo_trab", "ocupa"), 
                        sep = "", 
                         fill = 0) %>% 
                 as.data.frame() %>%
                  mutate(
                         # Identificación de la población trabajadora 
                          # (toda la que reporta al menos un empleo en la base de trabajos)
                         trab = 1
                         ) %>%
                   select(folioviv, foliohog, numren, trab,starts_with("tipo_trab"), starts_with("ocupa"))
```


**Se guarda la base de datos**
```{r}
#fwrite(ocupados, paste0(here::here(), "/Output/Data/ocupados22.csv"), row.names = F)
save(ocupados, file = paste0(here::here(), "/Output/Data/ocupados22.RData"))
```


**Indicador de carencia por acceso a los servicios de salud** 

```{r}
salud <- poblacion %>% 
          filter(!(parentesco >= 400 & parentesco < 500 | parentesco >= 700 & parentesco < 800)) %>%
           left_join(., ocupados, by = c("folioviv", "foliohog", "numren")) %>%
            mutate(
                   # PEA (personas de 16 años o más)
                   pea = case_when(.$trab == 1 & (.$edad >= 16 & !is.na(.$edad)) ~ 1, # PEA: ocupada
                                   (.$act_pnea1 == 1 | .$act_pnea2 == 1) & (.$edad >= 16 & !is.na(.$edad)) ~ 2, # PEA: desocupada
                                    (.$edad >= 16 & !is.na(.$edad)) & 
                                     ((.$act_pnea1 != 1 | is.na(.$act_pnea1)) & (.$act_pnea2 != 1 | is.na(.$act_pnea2))) & 
                                      ((.$act_pnea1 >= 2 & .$act_pnea1 <= 6) | (.$act_pnea2 >= 2 & .$act_pnea2 <= 6)) ~ 0)) %>% # PNEA
                  # Tipo de trabajo
                  # Ocupación principal
                  mutate(tipo_trab1 = case_when(.$pea %in% 1 ~ .$tipo_trab1, # Depende de un patrón, jefe o superior  
                                                .$pea %in% 0 | .$pea %in% 2 ~ .$tipo_trab1, # No depende de un jefe y recibe o tiene asignado un sueldo
                                                 is.na(.$pea) ~ NA), # No depende de un jefe y no recibe o no tiene asignado un sueldo
                         tipo_trab2 = case_when(.$pea %in% 1 ~ .$tipo_trab2, # Depende de un patrón, jefe o superior  
                                                .$pea %in% 0 | .$pea %in% 2 ~ .$tipo_trab2,  # No depende de un jefe y recibe o tiene asignado un sueldo
                                                 is.na(.$pea) ~ NA)) %>% # No depende de un jefe y no recibe o no tiene asignado un sueldo
                  # Servicios médicos prestaciones laborales
                  mutate(
                         # Ocupación principal
                         smlab1 = case_when(.$ocupa1 == 1 & .$atemed == 1 & 
                                            (.$inst_1 == 1 | .$inst_2 == 2 |  .$inst_3 == 3 |.$inst_4 == 4) & 
                                             (.$inscr_1 == 1) ~ 1, # Con servicios médicos
                                            .$ocupa1 == 1 ~ 0), # Sin servicios médicos
                         # Ocupación secundaria
                         smlab2 = case_when(.$ocupa2 == 1 & .$atemed == 1 & 
                                             (.$inst_1 == 1 | .$inst_2 == 2 |.$inst_3 == 3 | .$inst_4 == 4) & 
                                              (.$inscr_1 == 1) ~  1, # Con servicios médicos  
                                            .$ocupa2 == 1 ~ 0), # Sin servicios médicos
                          # Contratación voluntaria de servicios médicos
                         smcv = case_when(.$atemed == 1 & 
                                           (.$inst_1 == 1 | .$inst_2 == 2 | .$inst_3 == 3 | .$inst_4 == 4) & 
                                             .$inscr_6 == 6 & (.$edad >= 12 & !is.na(.$edad)) ~  1, # Sí cuenta
                                           (.$edad >= 12 & !is.na(.$edad)) ~ 0)) %>%  # No cuenta
                  # Acceso directo a servicios de salud
                  mutate(sa_dir = case_when(
                                           # Ocupación principal
                                           .$tipo_trab1 == 1 & (.$smlab1 == 1) ~ 1, # Con acceso
                                           .$tipo_trab1 == 2 & (.$smlab1 == 1 | .$smcv == 1) ~ 1, # Con acceso
                                           .$tipo_trab1 == 3 & (.$smlab1 == 1 | .$smcv == 1) ~ 1, # Con acceso
                                           # Ocupación secundaria
                                           .$tipo_trab2==1 & (.$smlab2 == 1) ~ 1, # Con acceso
                                           .$tipo_trab2==2 & (.$smlab2 == 1 | .$smcv == 1) ~ 1, # Con acceso
                                           .$tipo_trab2==3 & (.$smlab2 == 1 | .$smcv == 1 ) ~ 1, # Con acceso
                                            TRUE ~0)) %>% # Sin acceso
                  # Núcleos familiares
                  mutate(
                         par = case_when((.$parentesco >= 100 & .$parentesco < 200) ~ 1, # Jefe o jefa del hogar 
                                         (.$parentesco >= 200 & .$parentesco < 300) ~ 2, # Cónyuge del  jefe/a 
                                         (.$parentesco >= 300 & .$parentesco < 400) ~ 3, # Hijo del jefe/a 
                                          .$parentesco == 601 ~ 4, # Padre o Madre del jefe/a
                                          .$parentesco == 615 ~ 5, # Suegro del jefe/a
                                          TRUE ~ 6), # Sin parentesco directo
                         # Asimismo, se utilizará la información relativa a la asistencia a la escuela
                         inas_esc = case_when(.$asis_esc == 1 ~ 0,   # Sí asiste
                                              .$asis_esc == 2 ~ 1 )) %>% # No asiste
                  # En primer lugar se identifican los principales parentescos respecto a la jefatura del hogar y si ese miembro cuenta con acceso directo
                  mutate(
                         jef = case_when(.$par == 1 & .$sa_dir == 1 & 
                                          (((.$inst_2 == 2 | .$inst_3 == 3) & .$inscr_6 == 6) & 
                                           (is.na(.$inst_1) & is.na(.$inst_4) & is.na(.$inst_6)) &
                                            (is.na(.$inscr_1) & is.na(.$inscr_2) & is.na(.$inscr_3) & 
                                              is.na(.$inscr_4) & is.na(.$inscr_5) & is.na(.$inscr_7))) ~ NA_real_,
                                         .$par == 1 & .$sa_dir == 1 ~ 1),
                          cony = case_when(.$par == 2 & .$sa_dir == 1 & 
                                            (((.$inst_2 == 2 | .$inst_3 == 3) & .$inscr_6 == 6) &
                                             (is.na(.$inst_1) & is.na(.$inst_4) & is.na(.$inst_6)) &
                                              (is.na(.$inscr_1) & is.na(.$inscr_2) & is.na(.$inscr_3) & 
                                                is.na(.$inscr_4) & is.na(.$inscr_5) & is.na(.$inscr_7))) ~ NA_real_,
                                           .$par == 2 & .$sa_dir == 1 ~ 1),
                          hijo = case_when(.$par == 3 & .$sa_dir == 1 & 
                                            (((.$inst_2==2 | .$inst_3==3) & .$inscr_6==6) & 
                                             (is.na(.$inst_1) & is.na(.$inst_4) & is.na(.$inst_6)) & 
                                              (is.na(.$inscr_1) & is.na(.$inscr_2) & is.na(.$inscr_3) & 
                                                is.na(.$inscr_4) & is.na(.$inscr_5) & is.na(.$inscr_7) )) ~ NA_real_,
                                           .$par == 3 & .$sa_dir == 1 ~ 1)) %>%
                           as.data.table() %>%
                            group_by(folioviv, foliohog) %>%
                             mutate(jef_sa = sum(jef, na.rm = TRUE), # Acceso directo a servicios de salud de la jefatura del hogar
                                    cony_sa = sum(cony, na.rm = TRUE), # Acceso directo a servicios de salud del cónyuge de la jefatura del hogar
                                    hijo_sa = sum(hijo, na.rm = TRUE)) %>% # Acceso directo a servicios de salud de hijos(as) de la jefatura del hogar
                              ungroup() %>%
                  mutate(jef_sa = if_else(.$jef_sa > 0, 1, .$jef_sa),  # Acceso directo a servicios de salud de la jefatura del hogar
                         cony_sa = if_else(.$cony_sa > 0, 1, .$cony_sa), # Acceso directo a servicios de salud del cónyuge de la jefatura del hogar
                         hijo_sa = if_else(.$hijo_sa > 0, 1, .$hijo_sa), # Acceso directo a servicios de salud de hijos(as) de la jefatura del hogar
                         
                         # Otros núcleos familiares: se identifica a la población con acceso a servicios de salud mediante otros núcleos familiares a través de la 
                         # afiliación o inscripción a servicios de salud por algún familiar dentro o fuera del hogar, muerte del asegurado o por contratación propia;  
                         s_salud = case_when(.$atemed == 1 & (.$inst_1 == 1 | .$inst_2 == 2 | .$inst_3 == 3 | .$inst_4 == 4) & 
                                              (.$inscr_3 == 3| .$inscr_4 == 4 | .$inscr_6 == 6 | .$inscr_7 == 7) ~ 1, # Sí cuenta
                                             !is.na(.$pop_insabi) & !is.na(.$atemed) ~ 0)) %>%  # No cuenta
                  # Indicador de carencia por acceso a los servicios de salud
                  mutate(ic_asalud = case_when(
                                               # Parentesco directo: jefatura
                                               .$sa_dir == 1 ~ 0, 
                                               .$par == 1 & .$cony_sa == 1 ~ 0, # No presenta carencia
                                               .$par == 1 & .$pea == 0 & .$hijo_sa == 1 ~ 0, # No presenta carencia
                                               # Parentesco directo: cónyuge
                                               .$par == 2 & .$jef_sa == 1 ~ 0, # No presenta carencia
                                               .$par == 2 & .$pea == 0 & .$hijo_sa == 1 ~ 0, # No presenta carencia
                                               # Parentesco directo: descendientes
                                               .$par == 3 & .$edad < 16 & .$jef_sa == 1 ~ 0, # No presenta carencia
                                               .$par == 3 & .$edad < 16 & .$cony_sa == 1 ~ 0, # No presenta carencia
                                               .$par == 3 & (.$edad >= 16 & .$edad <= 25) & .$inas_esc == 0 & .$jef_sa == 1 ~ 0, # No presenta carencia
                                               .$par == 3 & (.$edad >= 16 & .$edad <= 25) & .$inas_esc == 0 & .$cony_sa == 1 ~ 0, # No presenta carencia
                                               # Parentesco directo: ascendientes
                                               .$par == 4 & .$pea == 0 & .$jef_sa == 1 ~ 0, # No presenta carencia
                                               .$par == 5 & .$pea == 0 & .$cony_sa == 1 ~ 0, # No presenta carencia
                                               # Otros núcleos familiares
                                               .$s_salud == 1 ~ 0, # No presenta carencia
                                               # Acceso reportado
                                               .$pop_insabi == 1 | (.$pop_insabi == 2 & .$atemed == 1 & 
                                                (.$inst_1 == 1 | .$inst_2 == 2 | inst_3 == 3 | 
                                                  .$inst_4 == 4 | .$inst_5 == 5 | .$inst_6 == 6)) | 
                                                   .$segvol_2 == 2 ~ 0, # No presenta carencia
                                               TRUE ~ 1
                                               ), # Presenta carencia
                         # Población con presencia de discapacidad, sea física o mental
                         discap = case_when(.$disc_camin >= "1" & .$disc_camin<= "2" ~1, # Con presencia de discapacidad
                                            .$disc_ver >= "1" & .$disc_ver <= "2" ~1, # Con presencia de discapacidad
                                            .$disc_brazo >= "1" & .$disc_brazo <= "2" ~1, # Con presencia de discapacidad
                                            .$disc_apren >= "1" & .$disc_apren <= "2" ~1, # Con presencia de discapacidad  
                                            .$disc_oir >= "1" & .$disc_oir <= "2" ~1, # Con presencia de discapacidad
                                            .$disc_vest >= "1" & .$disc_vest <= "2" ~1, # Con presencia de discapacidad
                                            .$disc_habla >= "1" & .$disc_habla <= "2" ~1, # Con presencia de discapacidad 
                                            .$disc_acti >= "1" & .$disc_acti <= "2"  ~1,  # Con presencia de discapacidad
                                            .$disc_camin == "&" & .$disc_ver == "&" &
                                            .$disc_brazo == "&" & .$disc_apren == "&" &
                                            .$disc_oir == "&" & .$disc_vest == "&" &
                                            .$disc_habla == "&" & .$disc_acti == "&" ~ NA_real_,
                                            TRUE ~ 0) # Sin presencia de discapacidad
                         ) %>%  
                   select(folioviv, foliohog, numren, sexo, starts_with("sa_"), ends_with("_sa"), pop_insabi, atemed, starts_with("inst_"), 
                          starts_with("inscr_"), starts_with("segvol_"), ic_asalud, discap, par, inas_esc, jef, cony, pea, act_pnea1, act_pnea2)

names(salud)
```


**Se guarda la base de datos**
```{r}
#fwrite(salud, paste0(here::here(), "/Output/Data/ic_asalud22.csv"), row.names = F)
save(salud, file = paste0(here::here(), "/Output/Data/ic_asalud22.RData"))
```


#### III. Indicador de carencia por acceso a la seguridad social

```{r}
# Prestaciones laborales
load(file = paste0(here::here(), "/Data/trabajos.RData")) 
```

```{r}
trabajos <- trabajos %>%
             mutate(tipo_trab = case_when(
                                          # Subordinados   
                                          .$subor == 1 ~ 1,
                                          # Independientes que reciben un pago
                                          .$subor == 2 & .$indep == 1 & .$tiene_suel == 1 ~ 2,
                                          .$subor == 2 & .$indep == 2 & .$pago == 1 ~ 2,
                                          # Independientes que no reciben un pago
                                          .$subor == 2 & .$indep == 1 & .$tiene_suel == 2 ~ 3,
                                          .$subor == 2 & .$indep == 2 & (.$pago == 2 | .$pago == 3) ~ 3) ,
                    # Ahorro para el retiro o pensión para la vejez (SAR, Afore)
                    aforlab = case_when(is.na(.$pres_8) ~ 0,
                                        .$pres_8 == 8 ~ 1),
                    # Ocupación principal o secundaria
                    id_trabajo = as.numeric(.$id_trabajo),
                    ocupa = case_when(.$id_trabajo == 1 ~ 1,
                                      .$id_trabajo == 2 ~ 1)) %>%
             # Distinción de prestaciones en trabajo principal y secundario
             select(folioviv, foliohog, numren, id_trabajo, tipo_trab, aforlab, ocupa) %>% 
              as.data.table() %>% 
               dcast(folioviv + foliohog + numren ~ id_trabajo, 
                      value.var = c("tipo_trab", "aforlab", "ocupa"), 
                       sep = "", 
                        fill = 0) %>%
                # Identificación de la población trabajadora toda la que reporta al menos un empleo en la base de trabajos)
                 mutate(trab = 1) %>%
                  select(folioviv, foliohog, numren, trab, tipo_trab1, tipo_trab2, aforlab1, aforlab2, ocupa1, ocupa2)
```


**Se guarda la base de datos**
```{r}
#fwrite(trabajos, paste0(here::here(), "/Output/Data/prestaciones22.csv"), row.names = F)
save(trabajos, file = paste0(here::here(), "/Output/Data/prestaciones22.RData"))
```

##### Ingresos por jubilaciones o pensiones

```{r}
# Ingresos por jubilaciones o pensiones
load(file = paste0(here::here(), "/Data/ingresos.RData")) 

ingresos <- ingresos %>%
             filter(clave == "P032" | clave == "P033" | clave =="P104" | clave =="P045") 

# Definición de los deflactores 2022 
{
  dic21	<-	0.94753762025
  ene22	<-	0.95314330024
  feb22	<-	0.96105102461
  mar22	<-	0.97056614137
  abr22	<-	0.97581641802
  may22	<-	0.97753689329
  jun22	<-	0.98579194365
  jul22	<-	0.99309386687
  ago22	<-	1.00000000000
  sep22	<-	1.00620340379
  oct22	<-	1.01189793462
  nov22	<-	1.01772170303
  dic22	<-	1.02160690775
}

```

```{r}
pensiones <- ingresos %>%
              mutate( 
                     # Se deflactan los ingresos por jubilaciones, pensiones y programas de adultos mayores de acuerdo con el mes de levantamiento
                     ing_6 = case_when(.$mes_6 == 2 ~ .$ing_6/feb22,
                                       .$mes_6 == 3 ~ .$ing_6/mar22,
                                       .$mes_6 == 4 ~ .$ing_6/abr22,
                                       .$mes_6 == 5 ~ .$ing_6/may22),
                     ing_5 = case_when(.$mes_5 == 3 ~ .$ing_5/mar22,
                                       .$mes_5 == 4 ~ .$ing_5/abr22,
                                       .$mes_5 == 5 ~ .$ing_5/may22,
                                       .$mes_5 == 6 ~ .$ing_5/jun22),
                     ing_4 = case_when(.$mes_4 == 4 ~ .$ing_4/abr22,
                                       .$mes_4 == 5 ~ .$ing_4/may22,
                                       .$mes_4 == 6 ~ .$ing_4/jun22,
                                       .$mes_4 == 7 ~ .$ing_4/jul22),
                     ing_3 = case_when(.$mes_3 == 5 ~ .$ing_3/may22,
                                       .$mes_3 == 6 ~ .$ing_3/jun22,
                                       .$mes_3 == 7 ~ .$ing_3/jul22,
                                       .$mes_3 == 8 ~ .$ing_3/ago22),
                     ing_2 = case_when(.$mes_2 == 6 ~ .$ing_2/jun22,
                                       .$mes_2 == 7 ~ .$ing_2/jul22,
                                       .$mes_2 == 8 ~ .$ing_2/ago22,
                                       .$mes_2 == 9 ~ .$ing_2/sep22),
                     ing_1 = case_when(.$mes_1 == 7 ~ .$ing_1/jul22,
                                       .$mes_1 == 8 ~ .$ing_1/ago22,
                                       .$mes_1 == 9 ~ .$ing_1/sep22,
                                       .$mes_1 == 10 ~ .$ing_1/oct22)) %>%
              mutate(
                     # Ingreso promedio mensual por jubilaciones y pensiones
                     ing_pam = case_when(.$clave=="P104" | .$clave=="P045" ~  apply(select(., ing_1, ing_2, ing_3, ing_4, ing_5, ing_6), 1, mean),
                                         TRUE ~ 0),
                     # Ingreso promedio mensual por programas de adultos mayores
                     ing_pens = case_when(.$clave=="P032" | .$clave=="P033" ~ apply(dplyr::select(., ing_1, ing_2, ing_3, ing_4, ing_5, ing_6), 1, mean),
                                         TRUE ~0))  %>%
                      group_by(folioviv, foliohog, numren) %>%
                       mutate(ing_pens = sum(.$ing_pens, na.rm = TRUE),
                              ing_pam = sum(.$ing_pam, na.rm = TRUE)) %>%
                        ungroup()
```


**Se guarda la base de datos**
```{r}
#fwrite(pensiones, paste0(here::here(), "/Output/Data/pensiones22.csv"), row.names = F)
save(pensiones, file = paste0(here::here(), "/Output/Data/pensiones22.RData"))
```

##### Construcción del indicador

**Indicador de carencia por acceso a la seguridad social** 

Se encuentra en situación de carencia por acceso a la seguridad social a la población que:    
1. No disponga de acceso directo a la seguridad social.   
2. No cuente con parentesco directo con alguna persona dentro del hogar que tenga acceso directo.    
3. No recibe servicios médicos por parte de algún familiar dentro o fuera del hogar, por muerte del asegurado o por contratación propia.  
4. No recibe ingreso por parte de un programa de adultos mayores donde el monto sea mayor o igual al valor promedio de la canasta alimentaria rural y urbana.    

```{r}
# Valor monetario de las líneas de pobreza extrema por ingresos rural y urbana
lp1_urb <- 2086.21
lp1_rur <- 1600.18
lp_pam <- (lp1_urb + lp1_rur)/2
```

 
```{r}
seguridad.social <- poblacion %>%
                     # Población objetivo: no se incluye a huéspedes ni trabajadores domésticos
                     filter(!(.$parentesco >= 400 & .$parentesco < 500 | .$parentesco >= 700 & .$parentesco < 800)) %>%
                     # Núcleos familiares
                     mutate(
                            par = case_when((.$parentesco >= 100 & .$parentesco < 200) ~ 1, # Jefe o jefa del hogar 
                                            (.$parentesco >= 200 & .$parentesco < 300) ~ 2, # Cónyuge del  jefe/a 
                                            (.$parentesco >= 300 & .$parentesco < 400) ~ 3, # Hijo del jefe/a 
                                             .$parentesco == 601 ~ 4, # Padre o Madre del jefe/a
                                             .$parentesco == 615 ~ 5, # Suegro del jefe/a
                                             TRUE ~ 6),  # Sin parentesco directo
                            # Asimismo, se utilizará la información relativa a la asistencia a la escuela
                            inas_esc = case_when(.$asis_esc == 1 ~ 0,   # Sí asiste
                                                 .$asis_esc == 2 ~ 1) # No asiste
                     ) %>%
                     # Integración de bases 
                      left_join(., trabajos, by = c("folioviv", "foliohog", "numren")) %>%
                      left_join(., pensiones, by = c("folioviv", "foliohog", "numren")) %>%
                     mutate(
                            # PEA (personas de 16 años o más)
                            pea = case_when(.$trab == 1 & (.$edad >= 16 & !is.na(.$edad)) ~ 1, # PEA: ocupada
                                             (.$act_pnea1 == 1 | .$act_pnea2 == 1) & (.$edad >= 16 & !is.na(.$edad)) ~ 2, # PEA: desocupada
                                            (.$edad >= 16 & !is.na(.$edad)) & 
                                             ((.$act_pnea1 != 1 | is.na(.$act_pnea1)) & 
                                              (.$act_pnea2 != 1 | is.na(.$act_pnea2))) & 
                                               ((.$act_pnea1 >= 2 & .$act_pnea1 <= 6) | (.$act_pnea2 >= 2 & .$act_pnea2 <= 6))  ~ 0)) %>% # PNEA
                     mutate(
                            # Tipo de trabajo
                            # Ocupación principal
                            tipo_trab1 = case_when(.$pea %in% 1 ~ .$tipo_trab1, # Depende de un patrón, jefe o superior  
                                                   .$pea %in% 0 | .$pea %in% 2 ~ .$tipo_trab1, # No depende de un jefe y recibe o tiene asignado un sueldo
                                                    is.na(.$pea) ~ NA), # No depende de un jefe y no recibe o no tiene asignado un sueldo
                            # Ocupación secundaria
                            tipo_trab2 = case_when(.$pea %in% 1 ~ .$tipo_trab2, # Depende de un patrón, jefe o superior  
                                                   .$pea %in% 0 | .$pea %in% 2 ~ .$tipo_trab2,  # No depende de un jefe y recibe o tiene asignado un sueldo
                                                    is.na(.$pea) ~ NA), # No depende de un jefe y no recibe o no tiene asignado un sueldo
                                           
                            # Jubilados o pensionados
                            jub = case_when(.$trabajo_mp == 2 & .$act_pnea1 == 2 | .$act_pnea2 == 2 ~ 1, # Población pensionada o jubilada
                                            .$ing_pens > 0 &  !is.na(.$ing_pens) ~ 1, # Población pensionada o jubilada
                                            .$inscr_2 == 2 ~ 1, # Población pensionada o jubilada
                                            TRUE ~ 0), # Población no pensionada o jubilada
                            # Prestaciones básicas
                            # Prestaciones laborales (Servicios médicos)
               
                            # Ocupación principal
                            smlab1 = case_when(.$ocupa1 == 1 & .$atemed == 1 & 
                                                (.$inst_1 == 1 | .$inst_2 == 2 | .$inst_3 == 3 | .$inst_4 == 4) & 
                                                 (.$inscr_1 == 1) ~ 1, # Sin servicios médicos
                                               .$ocupa1 == 1 ~ 0), # Con servicios médicos
                            # Ocupación secundaria
                            smlab2 = case_when(.$ocupa2 == 1 & .$atemed == 1 & 
                                                (.$inst_1 == 1 | .$inst_2 == 2 | .$inst_3 == 3 | .$inst_4 == 4) & 
                                                 (.$inscr_1 == 1) ~  1, # Sin servicios médicos
                                               .$ocupa2 == 1 ~ 0), # Con servicios médicos
                            # Contratación voluntaria: servicios médicos y ahorro para el retiro o pensión para la vejez (SAR, Afore, Haber de retiro)
              
                            # Servicios médicos
                            smcv = case_when(.$atemed == 1 & (.$inst_1 == 1 | .$inst_2 == 2 | .$inst_3 == 3 | .$inst_4 == 4) &
                                               .$inscr_6 == 6 & (.$edad >= 12 & !is.na(.$edad)) ~ 1, # Sí cuenta
                                             (.$edad >= 12 & !is.na(.$edad)) ~ 0), # No cuenta
                            # SAR o Afore
                            aforecv = case_when(.$segvol_1 == 1 & (.$edad >= 12 & !is.na(.$edad)) ~ 1, # Sí cuenta
                                                 is.na(.$segvol_1) & (.$edad>=12 & !is.na(.$edad)) ~ 0)) %>% # No cuenta
                     # Acceso directo a la seguridad social
                     mutate(
                            # Acceso directo a la seguridad social
                            ss_dir = case_when(  
                                               # Ocupación principal
                                               .$tipo_trab1 == 1 & .$smlab1 == 1 ~ 1, # Con acceso
                                               .$tipo_trab1 == 2 & ((.$smlab1 == 1 | .$smcv == 1) & (.$aforlab1 == 1 | .$aforecv == 1)) ~ 1, # Con acceso
                                               .$tipo_trab1 == 3 & ((.$smlab1 ==1 | .$smcv == 1) & .$aforecv == 1) ~ 1, # Con acceso
                                               # Ocupación secundaria
                                               .$tipo_trab2 == 1 & .$smlab2 == 1 ~ 1, # Con acceso
                                               .$tipo_trab2 == 2 & ((.$smlab2 == 1 | .$smcv == 1) & (.$aforlab2 == 1 | .$aforecv == 1)) ~ 1, # Con acceso  
                                               .$tipo_trab2 == 3 & ((.$smlab2 == 1 | .$smcv == 1) & .$aforecv == 1) ~ 1, # Con acceso
                                               # Jubilados y pensionados
                                               .$jub == 1 ~ 1, # Con acceso
                                               TRUE ~ 0)
                            ) %>%  # Sin acceso
                     # En primer lugar se identifican los principales parentescos respecto a la jefatura del hogar y si ese miembro cuenta con acceso directo
                     mutate(
                            jef = case_when(.$par == 1 & .$ss_dir == 1 & 
                                             (((.$inst_2 == "2" | .$inst_3 == "3") & .$inscr_6 == "6") & 
                                              (is.na(.$inst_1) & is.na(.$inst_4) & is.na(.$inst_6)) &
                                               (is.na(.$inscr_1) & is.na(.$inscr_2) & is.na(.$inscr_3) & 
                                                is.na(.$inscr_4) & is.na(.$inscr_5)  & is.na(.$inscr_7))) ~ NA_real_,
                                            .$par == 1 & .$ss_dir == 1 ~ 1),
                            
                            cony = case_when(.$par == 2 & .$ss_dir == 1 & 
                                              (((.$inst_2 == "2" | inst_3 == "3") & inscr_6 == "6") &
                                               (is.na(.$inst_1) & is.na(.$inst_4) & is.na(.$inst_6)) &
                                                (is.na(.$inscr_1) & is.na(.$inscr_2) & is.na(.$inscr_3) & 
                                                 is.na(.$inscr_4) & is.na(.$inscr_5) & is.na(.$inscr_7) )) ~ NA_real_,
                                             .$par == 2 & .$ss_dir == 1 ~ 1),
                            
                            hijo = case_when(.$par == 3 & .$ss_dir == 1 & 
                                              (((.$inst_2 == "2" | .$inst_3 == "3") & .$inscr_6 == "6") & 
                                               (is.na(.$inst_1) & is.na(.$inst_4) & is.na(.$inst_6)) & 
                                               (is.na(.$inscr_1) & is.na(.$inscr_2) & is.na(.$inscr_3) & 
                                                is.na(.$inscr_4) & is.na(.$inscr_5) & is.na(.$inscr_7) )) ~ NA_real_,
                                             .$par == 3 & .$ss_dir == 1 & .$jub == 1 & (.$edad > 25 & !is.na(.$edad)) ~ 1,
                                             .$par == 3 & .$ss_dir == 1 & .$jub == 0 ~ 1)) %>%
                      as.data.table() %>%
                       group_by(folioviv, foliohog) %>%
                        mutate(jef_ss = sum(jef, na.rm = TRUE), # Acceso directo a servicios de salud de la jefatura del hogar
                               cony_ss = sum(cony, na.rm = TRUE), # Acceso directo a servicios de salud del cónyuge de la jefatura del hogar
                               hijo_ss = sum(hijo, na.rm = TRUE)) %>% # Acceso directo a servicios de salud de hijos(as) de la jefatura del hogar
                         ungroup() %>%
                          mutate(jef_ss = if_else(.$jef_ss > 0, 1, .$jef_ss), # Acceso directo a la seguridad social de la jefatura del hogar
                                 cony_ss = if_else(.$cony_ss > 0, 1, .$cony_ss), # Acceso directo a la seguridad social de cónyuge de la jefatura del hogar
                                 hijo_ss = if_else(.$hijo_ss > 0, 1, .$hijo_ss)) %>% # Acceso directo a la seguridad social de hijos(as) de la jefatura del hogar
                          # Otros núcleos familiares: se identifica a la población con acceso a la seguridad social mediante otros núcleos 
                          # familiares a través de la afiliación o inscripción a servicios de salud por algún familiar dentro o fuera del 
                          # hogar, muerte del asegurado o por contratación propia
  
                          mutate(s_salud = case_when(.$atemed == 1 & 
                                                      (.$inst_1 == 1 | .$inst_2 == 2 | .$inst_3 == 3 | .$inst_4 == 4) & 
                                                        (.$inscr_3 == 3 | .$inscr_4 == 4 | .$inscr_6 == 6 | inscr_7 == 7) ~ 1, # Con acceso
                                                          !is.na(.$pop_insabi) & !is.na(.$atemed) ~ 0) # Sin acceso
                                 ) %>% 
                          # Programas sociales de pensiones para adultos mayores 

                          # Se identifica a las personas de 65 años o más que reciben un programa para adultos mayores si el monto recibido 
                          # es mayor o igual al promedio de la línea de pobreza extrema por ingresos rural y urbana.
                          mutate(pam = case_when(.$edad >= 65 & !is.na(.$edad) & .$ing_pam >= lp_pam & !is.na(.$ing_pam) ~ 1, # Recibe
                                                 .$edad >= 65 & !is.na(.$edad) ~ 0) # No recibe
                                 ) %>% 
  
                         # Indicador de carencia por acceso a la seguridad social
                         
                          mutate(
                                 ic_segsoc = case_when(
                                                       # Acceso directo
                                                       .$ss_dir == 1 ~ 0, # No presenta carencia
                                                       # Parentesco directo: jefatura
                                                       .$par == 1 & .$cony_ss == 1 ~ 0, # No presenta carencia
                                                       .$par == 1 & .$pea == 0 & .$hijo_ss == 1 ~ 0, # No presenta carencia
                                                       # Parentesco directo: cónyuge
                                                       .$par == 2 & .$jef_ss == 1 ~ 0, # No presenta carencia 
                                                       .$par == 2 & .$pea == 0 & .$hijo_ss == 1 ~ 0, # No presenta carencia
                                                       # Parentesco directo: descendientes
                                                       .$par == 3 & .$edad < 16 & .$jef_ss == 1 ~ 0, # No presenta carencia
                                                       .$par == 3 & .$edad < 16 & .$cony_ss == 1 ~ 0, # No presenta carencia
                                                       .$par == 3 & (.$edad >= 16 & .$edad <= 25) & .$inas_esc == 0 & .$jef_ss == 1 ~ 0, # No presenta carencia
                                                       .$par == 3 & (.$edad >= 16 & .$edad <= 25) & .$inas_esc == 0 & .$cony_ss == 1 ~ 0, # No presenta carencia
                                                       # Parentesco directo: ascendientes
                                                       .$par == 4 & .$pea == 0 & .$jef_ss == 1 ~ 0, # No presenta carencia
                                                       .$par == 5 & .$pea == 0 & .$cony_ss == 1 ~ 0, # No presenta carencia
                                                       # Otros núcleos familiares
                                                       .$s_salud == 1 ~ 0, # No presenta carencia
                                                       # Programa de adultos mayores
                                                       .$pam == 1 ~ 0, # No presenta carencia
                                                        TRUE ~ 1) # Presenta carencia
                                 ) %>%
                           select(folioviv, foliohog, numren,starts_with("tipo_trab"), starts_with("aforlab"), starts_with("smlab"), smcv, aforecv, 
                                  pea, jub, ss_dir, par, ends_with("_ss"), s_salud, pam, ing_pam, ic_segsoc)
```

**Se guarda la base de datos**
```{r}
#fwrite(seguridad.social, paste0(here::here(), "/Output/Data/ic_segsoc22.csv"), row.names = F)
save(seguridad.social, file = paste0(here::here(), "/Output/Data/ic_segsoc22.RData"))
```


#### IV. Indicador de carencia por calidad y espacios de la vivienda 

##### Material de construcción de la vivienda

```{r}
load(file = paste0(here::here(), "/Data/viviendas.RData")) 
load(file = paste0(here::here(), "/Data/concentradohogar.RData")) 
```

**Indicador de carencia por calidad y espacios de la vivienda**  

Se considera en situación de carencia por calidad y espacios de la vivienda a las personas que residan en viviendas que presenten, al menos, una de las siguientes características:     
  
1. El material de los pisos de la vivienda es de tierra   
2. El material del techo de la vivienda es de lámina de cartón o desechos.   
3. El material de los muros de la vivienda es de embarro o bajareque, de carrizo, bambú o palma, de lámina de cartón, metálica o asbesto, o material de desecho.    
4. La razón de personas por cuarto (hacinamiento) es mayor que `2.5`.      

```{r}
calidad.viviendas <- viviendas %>% 
                      left_join(., concentradohogar,  by = c("folioviv")) %>% 
                       mutate(
                              icv_pisos = as.numeric(.$mat_pisos), # Material de los pisos de la vivienda
                              icv_techos = as.numeric(.$mat_techos), # Material de los techos de la vivienda
                              icv_muros = as.numeric(.$mat_pared), # Material de muros en la vivienda
                              num_ind = .$tot_resid, # Número de residentes en la vivienda
                              num_cua = .$num_cuarto # Número de cuartos en la vivienda
                              ) %>% 
                       mutate(
                              # Indicador de carencia por material de piso de la vivienda
                              icv_pisos = case_when(.$icv_pisos >= 2 ~ 0,
                                                    .$icv_pisos == 1 ~ 1),
                              # Indicador de carencia por material de techos de la vivienda
                              icv_techos = case_when(.$icv_techos >= 3 ~ 0,
                                                     .$icv_techos <= 2 ~ 1),
                              # Indicador de carencia por material de muros de la vivienda
                              icv_muros = case_when(.$icv_muros >= 6 ~ 0,
                                                    .$icv_muros <= 5 ~ 1),
              
                              # Espacios en la vivienda (Hacinamiento)
                              # Índice de hacinamiento
                              cv_hac = .$num_ind/.$num_cua) %>%
                       # Indicador de carencia por hacinamiento en la vivienda
                       mutate(
                              icv_hac = case_when(
                                                  .$cv_hac > 2.5 & !is.na(.$cv_hac) ~ 1,
                                                  .$cv_hac <= 2.5 ~ 0)
                              ) %>%
                      # Indicador de carencia por calidad y espacios de la vivienda 

                      mutate(
                             ic_cv = case_when(
                                               is.na(.$icv_pisos) | is.na(.$icv_techos) | is.na(.$icv_muros) | is.na(.$icv_hac) ~ NA_real_,
                                               .$icv_pisos == 1 | .$icv_techos == 1 | .$icv_muros == 1 | .$icv_hac == 1 ~ 1,     # Con carencia
                                               .$icv_pisos == 0 & .$icv_techos == 0 & .$icv_muros == 0 & .$icv_hac == 0 ~ 0)) %>% # Sin carencia
                       select(folioviv, foliohog, icv_pisos, icv_techos, icv_muros, icv_hac, ic_cv) 
```


**Se guarda la base de datos**
```{r}
#fwrite(calidad.viviendas, paste0(here::here(), "/Output/Data/ic_cev22.csv"), row.names = F)
save(calidad.viviendas, file = paste0(here::here(), "/Output/Data/ic_cev22.RData"))
```


#### V. Indicador de carencia por acceso a los servicios básicos de la vivienda   

**Indicador de carencia por acceso a los servicios básicos en la vivienda**   

Se considera en situación de carencia por servicios básicos en la vivienda a las personas que residan en viviendas que presenten, al menos, una de las siguientes características:   
  
1. El agua se obtiene de un pozo, río, lago, arroyo, pipa, o bien, el agua entubada la adquieren por acarreo de otra vivienda, o de la llave pública o hidrante.  
2. No cuentan con servicio de drenaje o el desagüe tiene conexión a una tubería que va a dar a un río, lago, mar, barranca o grieta.   
3. No disponen de energía eléctrica.   
4. El combustible que se usa para cocinar o calentar los alimentos es leña o carbón sin chimenea.   

```{r}
servicios.basicos <- concentradohogar %>% 
                      left_join(., viviendas, by = c("folioviv")) %>% 
                       mutate(
                              # Indicador de carencia por acceso al agua
                              isb_agua = case_when(.$procaptar == 1 & .$disp_agua == "4" ~ 0,
                                                 .$disp_agua >= 3 & !is.na(.$disp_agua) ~ 1,
                                                 .$disp_agua <= 2 & !is.na(.$disp_agua) ~ 0),
                              # Indicador de carencia por servicio de drenaje
                              isb_dren = case_when(.$drenaje >= 3 ~1,
                                                 .$drenaje <= 2 ~0),
                              # Indicador de carencia por servicios de electricidad
                              isb_luz = case_when(.$disp_elect >= 5 ~1,
                                                .$disp_elect <= 4 ~0),
                              # Indicador de carencia por combustible para cocinar
                              combus = as.numeric(.$combustible),
                              estufa = as.numeric(.$estufa_chi),
                              isb_combus = case_when((.$combus == 1 | .$combus == 2) & .$estufa == 2 ~ 1, 
                                                     (.$combus == 1 | .$combus == 2) & .$estufa == 1 ~ 0,
                                                       .$combus >= 3 & .$combus <= 6 ~ 0)) %>%
                              # Indicador de carencia por acceso a los servicios básicos en la vivienda
                       mutate(
                              ic_sbv = case_when(
                                                 is.na(.$isb_agua) | is.na(.$isb_dren) | is.na(.$isb_luz) | is.na(.$isb_combus) ~ NA_real_,
                                                 .$isb_agua == 1 | .$isb_dren == 1 | .$isb_luz == 1 | .$isb_combus == 1 ~ 1, # Con carencia
                                                 .$isb_agua == 0 & .$isb_dren == 0 & .$isb_luz == 0 & .$isb_combus == 0 ~ 0)) %>% # Sin carencia
                       select(folioviv, foliohog, isb_agua, isb_dren, isb_luz, isb_combus, ic_sbv)
  
```
**Se guarda la base de datos**
```{r}
#fwrite(servicios.basicos, paste0(here::here(), "/Output/Data/ic_sbv22.csv"), row.names = F)
save(servicios.basicos, file = paste0(here::here(), "/Output/Data/ic_sbv22.RData"))
```

#### VI. Indicador de carencia por acceso a la alimentación nutritiva y de calidad  
 
```{r}
menores.alimentacion <- poblacion %>%
                         # Población objetivo: no se incluye a huéspedes ni trabajadores domésticos
                         filter(!(parentesco >= 400 & parentesco < 500 | parentesco >= 700 & parentesco < 800)) %>% 
                          # Indicador de hogares con menores de 18 años
                          mutate(men = case_when(.$edad >= 0 & .$edad <= 17 ~ 1, 
                                                 TRUE ~ NA)) %>%
                           as.data.frame() %>%
                           # group_by(folioviv, foliohog) %>%
                             summarise(men = sum(men, na.rm = TRUE), .by = c(folioviv, foliohog)) %>%
                              ungroup() %>%
                               mutate(id_men = case_when(.$men >= 1 & !is.na(.$men) ~ 1, 
                                                         .$men == 0 ~ 0)) %>%
                                select(folioviv, foliohog, id_men)
 # Nota: no concuerda la suma de los menores de edad con la función summarise y la función DT
 #menores <- as.data.table(menores.alimentacion)[, lapply(.SD, sum, na.rm = TRUE), 
 #                                                by =.(folioviv, foliohog), .SDcols = c("men")] %>%
```

**Se guarda la base de datos**
```{r}
#fwrite(smenores.alimentacion, paste0(here::here(), "/Output/Data/menores22.csv"), row.names = F)
save(menores.alimentacion, file = paste0(here::here(), "/Output/Data/menores22.RData"))
```


##### Grado de inseguridad alimentaria

```{r}
load(file = paste0(here::here(), "/Data/hogares.RData")) 
```

```{r}
alimentacion <- hogares %>% 
                 # Parte 1. Grado de inseguridad alimentaria
                 mutate(
                        # Seis preguntas para hogares sin población menor a 18 años
                        # Algún adulto tuvo una alimentación basada en muy poca variedad de alimentos
                        ia_1ad = case_when(.$acc_alim4 == 2 ~ 0, # No
                                           .$acc_alim4 == 1 ~ 1, # Sí
                                           is.na(.$acc_alim4) ~ 0), # No
                        # Algún adulto dejó de desayunar, comer o cenar
                        ia_2ad = case_when(.$acc_alim5 == 2 ~ 0,  # No
                                           .$acc_alim5 == 1 ~ 1, # Sí
                                           is.na(.$acc_alim5) ~ 0),  # No
                        # Algún adulto comió menos de lo que debía comer
                        ia_3ad = case_when(.$acc_alim6 == 2 ~ 0,  # No
                                           .$acc_alim6 == 1 ~ 1, # Sí
                                           is.na(.$acc_alim6) ~ 0),  # No
                        # El hogar se quedó sin comida
                        ia_4ad = case_when(.$acc_alim2 == 2 ~ 0,  # No
                                           .$acc_alim2 == 1 ~ 1, # Sí
                                           is.na(.$acc_alim2) ~ 0), # No
                        # Algún adulto sintió hambre pero no comió
                        ia_5ad = case_when(.$acc_alim7 == 2 ~ 0, # No
                                           .$acc_alim7 == 1 ~ 1, # Sí
                                           is.na(.$acc_alim7) ~ 0), # No
                        # Algún adulto solo comió una vez al día o dejó de comer todo un día
                        ia_6ad = case_when(.$acc_alim8 == 2 ~ 0,  # No
                                           .$acc_alim8 == 1 ~ 1, # Sí
                                           is.na(.$acc_alim8) ~ 0), # No
            
                        # Seis preguntas para hogares sin población menor a 18 años
            
                        # Alguien de 0 a 17 años tuvo una alimentación basada en muy poca variedad de alimentos
                        ia_7men = case_when(.$acc_alim11 == 2 ~ 0, # No
                                            .$acc_alim11 == 1 ~ 1, # Sí
                                            is.na(.$acc_alim11) ~ 0), # No
                        # Alguien de 0 a 17 años comió menos de lo que debía
                        ia_8men = case_when(.$acc_alim12 == 2 ~ 0, # No
                                            .$acc_alim12 == 1 ~ 1, # Sí
                                            is.na(.$acc_alim12) ~ 0), # No
                        # Se tuvo que disminuir la cantidad servida en las comidas a alguien de 0 a 17 años
                        ia_9men = case_when(.$acc_alim13 == 2 ~ 0, # No
                                            .$acc_alim13 == 1 ~ 1, # Sí
                                            is.na(.$acc_alim13) ~ 0), # No
                        # Alguien de 0 a 17 años sintió hambre pero no comió
                        ia_10men  =case_when(.$acc_alim14 == 2 ~ 0, # No
                                             .$acc_alim14 == 1 ~ 1, # Sí
                                             is.na(.$acc_alim14) ~ 0), # No
                        # Alguien de 0 a 17 años se acostó con hambre
                        ia_11men = case_when(.$acc_alim15 == 2 ~ 0, # No
                                             .$acc_alim15 == 1 ~ 1, # Sí
                                             is.na(.$acc_alim15) ~ 0), # No
                        # Alguien de 0 a 17 años comió una vez al día o dejó de comer todo un día
                        ia_12men = case_when(.$acc_alim16 == 2 ~ 0, # No
                                             .$acc_alim16 == 1 ~ 1, # Sí
                                             is.na(.$acc_alim16) ~ 0) # No
                        ) %>%
                 # Construcción de la escala de inseguridad alimentaria
                 left_join(., menores.alimentacion, by = c("folioviv", "foliohog")) %>%
                  mutate(
                         # Escala para hogares sin menores de 18 años
                         tot_iaad = case_when(id_men == 0 ~ .$ia_1ad + .$ia_2ad + .$ia_3ad + .$ia_4ad + .$ia_5ad + .$ia_6ad),
                         # Escala para hogares con menores de 18 años
                         tot_iamen = case_when(id_men == 1 ~ .$ia_1ad + .$ia_2ad + .$ia_3ad + .$ia_4ad + .$ia_5ad + .$ia_6ad + .$ia_7men + .$ia_8men + .$ia_9men + .$ia_10men + .$ia_11men + .$ia_12men)) %>% 
                  mutate(
                         # Grado de inseguridad alimentaria
                         ins_ali = case_when(
                                             # Seguridad alimentaria  
                                             .$tot_iaad == 0 | .$tot_iamen == 0 ~ 0, 
                                             # Inseguridad alimentaria leve
                                             .$tot_iaad == 1 | .$tot_iaad == 2 | .$tot_iamen == 1 | .$tot_iamen == 2 | .$tot_iamen == 3 ~ 1,
                                             # Inseguridad alimentaria moderada
                                             .$tot_iaad == 3 | .$tot_iaad == 4 | .$tot_iamen == 4 | .$tot_iamen == 5 | .$tot_iamen == 6 | .$tot_iamen == 7 ~ 2,
                                             # Inseguridad alimentaria severa
                                             .$tot_iaad == 5 | .$tot_iaad == 6 | .$tot_iamen >= 8 & !is.na(.$tot_iamen) ~ 3)) %>%
                  # Se genera el indicador de carencia por acceso a la alimentación que  considera en situación de carencia a la población en hogares que  
                  # presenten inseguridad alimentaria moderada o severa.

                  mutate(
                         # Indicador de carencia por acceso a la alimentación  
                         ic_ali = case_when(.$ins_ali == 2 | .$ins_ali == 3 ~ 1, # Con carencia
                                            .$ins_ali == 0 | .$ins_ali == 1 ~ 0)) # Sin carencia
```

##### Limitación en el consumo de alimentos  

Se considera el número de días que se consumieron cada uno de los 12 grupos  de alimentos por el ponderador utilizado por el Programa Mundial de Alimentos (`PMA`) de las Naciones Unidas:   

`Grupo 1`: (maíz, avena, arroz, sorgo, mijo, pan y otros cereales) y (yuca, papas, camotes y otros tubérculos)  
`Grupo 2`: frijoles, chícharos, cacahuates, nueces  
`Grupo 3`: vegetales y hojas  
`Grupo 4`: frutas  
`Grupo 5`: carne de res, cabra, aves, cerdo, huevos y pescado  
`Grupo 6`: leche, yogur y otros lácteos  
`Grupo 7`: azúcares y productos azucarados  
`Grupo 8`: aceites, grasas y mantequilla  
`Grupo 9`: especias, té, café, sal, polvo de pescado, pequeñas cantidades de leche para el té  

El ponderador para el `Grupo 1` es 2, para el `Grupo 2` es 3, para el `Grupo 3` y `Grupo 4` es 1, para el `Grupo 5` y `Grupo 6` es 4, para el `Grupo 7` y `Grupo 8` es 0.5, y para el `Grupo 9` es 0.    


```{r}
alimentacion <- alimentacion %>%
                 mutate(
                        cpond1 = if_else(.$alim17_1 > .$alim17_2, .$alim17_1, .$alim17_2) * 2,
                        cpond3  = .$alim17_3  * 1,
                        cpond4  = .$alim17_4  * 1,
                        cpond5  = apply(.[,c("alim17_5", "alim17_6", "alim17_7")], 1, max) * 4,
                        cpond8  = .$alim17_8  * 3   ,
                        cpond9  = .$alim17_9  * 4   ,
                        cpond10 = .$alim17_10 * 0.5 ,
                        cpond11 = .$alim17_11 * 0.5 ,
                        cpond12 = .$alim17_12 * 0 
                        ) %>%
                 mutate(
                        # Puntaje total de consumo ponderado de alimentos, indica el número ponderado 
                        # de grupos de alimentos que se consumieron en los últimos siete días     
                        tot_cpond = .$cpond1 + .$cpond3 + .$cpond4 + .$cpond5 + .$cpond8 + .$cpond9 + .$cpond10 + .$cpond11 + .$cpond12
                        ) %>%
                 mutate(
                        # Se categoriza la dieta consumida en los hogares
                        # Dieta consumida en los hogares              
                        dch = case_when(.$tot_cpond >=  0 & .$tot_cpond <= 28   ~ 1,  # Pobre 
                                        .$tot_cpond >  28 & .$tot_cpond <= 42   ~ 2,  # Limítrofe
                                        .$tot_cpond >  42 & !is.na(.$tot_cpond) ~ 3)) %>% # Aceptable
                 mutate(
                        # Limitación en el consumo de Alimentos
                        lca = case_when(.$dch == 1 | .$dch == 2 ~ 1,   # Limitado
                                        .$dch == 3 ~ 0))           # No
```


##### Indicador de carencia por acceso a la alimentación nutritiva y de calidad   

Se considera en situación de carencia por acceso a la alimentación nutritiva y de calidad a la población en hogares que presenten, al menos, una de las siguientes características:
  
1. Grado inseguridad alimentaria moderada o severa.   
2. Limitación en el consumo de alimentos.  


```{r}
alimentacion <- alimentacion %>%
                 mutate(
                        ic_ali_nc = case_when(.$ic_ali == 0 & .$lca == 0 ~ 0, # Sin carencia
                                              (.$ic_ali == 1 | .$lca == 1) &
                                               (!is.na(.$ic_ali) & !is.na(.$lca)) ~ 1)) %>% # Con carencia
                  select(folioviv, foliohog, id_men, starts_with("ia_"), tot_iaad, tot_iamen, ins_ali, dch, lca, ic_ali, ic_ali_nc)
```


**Se guarda la base de datos**
```{r}
#fwrite(alimentacion, paste0(here::here(), "/Output/Data/ic_ali22.csv"), row.names = F)
save(alimentacion, file = paste0(here::here(), "/Output/Data/ic_ali22.RData"))
```


#### VII. Bienestar económico (ingresos) {.tabset .tabset-pills}   

##### Ingresos

Para la construcción del ingreso corriente del hogar es necesario utilizar información sobre la condición de ocupación y los ingresos de los individuos.  
Se utiliza la información contenida en la base trabajo.csv para identificar a la población ocupada que declara tener como prestación laboral aguinaldo, ya sea por su trabajo principal o secundario, a fin de incorporar los ingresos por este concepto en la medición

Creación del ingreso monetario deflactado a pesos de agosto del 2022   

```{r}
load(file = paste0(here::here(), "/Data/trabajos.RData")) 
```


```{r}
aguinaldos <- trabajos %>% 
               select(folioviv, foliohog, numren, id_trabajo, pres_2) %>% 
                as.data.table() %>% 
                 dcast(folioviv + foliohog + numren ~ id_trabajo,
                        value.var = "pres_2") %>% 
                  mutate(
                         # Población con al menos un empleo 
                         trab = 1,
                         # Aguinaldo trabajo principal
                         aguinaldo1 = case_when(.$`1` == 2 ~ 1,  # Dispone de aguinaldo
                                                TRUE ~ 0),   # No dispone de aguinaldo
                         # Aguinaldo trabajo secundario
                         aguinaldo2 = case_when(`2` == 2 ~ 1,   # Dispone de aguinaldo
                                                TRUE ~ 0)) %>% # No dispone de aguinaldo
                   select(folioviv, foliohog, numren, aguinaldo1, aguinaldo2, trab)
```


**Se guarda la base de datos**
```{r}
#fwrite(aguinaldos, paste0(here::here(), "/Output/Data/aguinaldo22.csv"), row.names = F)
save(aguinaldos, file = paste0(here::here(), "/Output/Data/aguinaldo22.RData"))
```


**Ahora se incorpora a la base de ingresos**

```{r}
load(file = paste0(here::here(), "/Data/ingresos.RData")) 
```


```{r}
ingresos <- ingresos %>%
             full_join(., aguinaldos, by = c("folioviv", "foliohog", "numren")) %>%
              mutate(index = case_when(.$clave == "P009" & .$aguinaldo1 != 1 ~ 1,
                                       .$clave == "P016" & .$aguinaldo2 != 1 ~ 1,
                                       TRUE ~ 0)) %>%
               filter(index != 1)
```

Una vez realizado lo anterior, se procede a deflactar el ingreso recibido por los hogares a precios de agosto de 2022. Para ello, se utilizan las variables meses, las cuales toman los valores 2 a 10 e indican el mes en que se recibió el ingreso respectivo.   

**Definición de los deflactores 2022**   

```{r}
{
  dic21	<-	0.94753762025
  ene22	<-	0.95314330024
  feb22	<-	0.96105102461
  mar22	<-	0.97056614137
  abr22	<-	0.97581641802
  may22	<-	0.97753689329
  jun22	<-	0.98579194365
  jul22	<-	0.99309386687
  ago22	<-	1.00000000000
  sep22	<-	1.00620340379
  oct22	<-	1.01189793462
  nov22	<-	1.01772170303
  dic22	<-	1.02160690775
}
```

```{r}
ingresos <- ingresos %>%
             mutate( 
                    ing_6 = ifelse(is.na(.$mes_6), 
                                    .$ing_6,
                                     case_when(.$mes_6 == 2  ~ .$ing_6/feb22,
                                               .$mes_6 == 3  ~ .$ing_6/mar22,
                                               .$mes_6 == 4  ~ .$ing_6/abr22,
                                               .$mes_6 == 5  ~ .$ing_6/may22)),
                    ing_5 = ifelse(is.na(.$mes_5), 
                                    .$ing_5,
                                     case_when(.$mes_5 == 3  ~ .$ing_5/mar22,
                                               .$mes_5 == 4  ~ .$ing_5/abr22,
                                               .$mes_5 == 5  ~ .$ing_5/may22,
                                               .$mes_5 == 6  ~ .$ing_5/jun22)),
                    ing_4 = ifelse(is.na(.$mes_4), 
                                    .$ing_4,
                                     case_when(.$mes_4 == 4  ~ .$ing_4/abr22,
                                               .$mes_4 == 5  ~ .$ing_4/may22,
                                               .$mes_4 == 6  ~ .$ing_4/jun22,
                                               .$mes_4 == 7  ~ .$ing_4/jul22)),
                    ing_3 = ifelse(is.na(.$mes_3), 
                                    .$ing_3,
                                     case_when(.$mes_3 == 5  ~ .$ing_3/may22,
                                               .$mes_3 == 6  ~ .$ing_3/jun22,
                                               .$mes_3 == 7  ~ .$ing_3/jul22,
                                               .$mes_3 == 8  ~ .$ing_3/ago22)),
                    ing_2 = ifelse(is.na(.$mes_2), 
                                    .$ing_2,
                                     case_when(.$mes_2 == 6  ~ .$ing_2/jun22,
                                               .$mes_2 == 7  ~ .$ing_2/jul22,
                                               .$mes_2 == 8  ~ .$ing_2/ago22,
                                               .$mes_2 == 9  ~ .$ing_2/sep22)),
                    ing_1 = ifelse(is.na(.$mes_1), 
                                    .$ing_1,
                                     case_when(.$mes_1 == 7  ~ .$ing_1/jul22,
                                               .$mes_1 == 8  ~ .$ing_1/ago22,
                                               .$mes_1 == 9  ~ .$ing_1/sep22,
                                               .$mes_1 == 10 ~ .$ing_1/oct22))) 
```

Se deflactan las claves P008 y P015 (Reparto de utilidades) y P009 y P016 (aguinaldo) con los deflactores de mayo a agosto 2022 y de diciembre de 2021 a agosto 2022, respectivamente, y se obtiene el promedio mensual.   

```{r} 
index <-c("P008", "P009", "P015", "P016") 
```

```{r}
ingresos <- ingresos %>%
             mutate(ing_1 = ifelse(.$clave == "P008" | .$clave == "P015", 
                                    (.$ing_1/may22)/12, 
                                      .$ing_1), 
                    ing_1 = ifelse(.$clave == "P009" | .$clave == "P016", 
                                    (.$ing_1/dic21)/12, 
                                      .$ing_1),
                    ing_2 = ifelse((.$clave %in%  index) & .$ing_2 == 0, 
                                    NA_real_, 
                                     ing_2),
                    ing_3 = ifelse((.$clave %in%  index) & .$ing_3 == 0, 
                                    NA_real_, 
                                     .$ing_3),
                    ing_4 = ifelse((.$clave %in%  index) & .$ing_4 == 0, 
                                    NA_real_, 
                                     .$ing_4),
                    ing_5 = ifelse((.$clave %in%  index) & .$ing_5 == 0, 
                                    NA_real_, 
                                     .$ing_5),
                    ing_6 = ifelse((.$clave %in%  index) & .$ing_6 == 0, 
                                    NA_real_, 
                                     .$ing_6)) %>%
              # Una vez realizada la deflactación, se procede a obtener el ingreso mensual promedio en los últimos seis meses, para cada persona y clave de ingreso 
             mutate(
                    ing_mens = apply(.[,c("ing_1","ing_2","ing_3","ing_4","ing_5","ing_6")], 1, mean, na.rm = TRUE)) %>%
             mutate(
                    # Para obtener el ingreso corriente monetario, se seleccionan las claves de ingreso correspondientes
                    ing_mon = case_when((.$clave >= "P001" & .$clave <= "P009") | (.$clave >= "P011" & .$clave <= "P016") |
                                        (.$clave >= "P018" & .$clave <= "P048") | (.$clave >= "P067" & .$clave <= "P081") |
                                         (.$clave >= "P101" & .$clave <= "P108") ~ .$ing_mens ),
                    # Para obtener el ingreso laboral, se seleccionan las claves de ingreso correspondientes
                    ing_lab = case_when((.$clave >= "P001" & .$clave <= "P009") | (.$clave >= "P011" & .$clave <= "P016") |
                                        (.$clave >= "P018" & .$clave <= "P022") | (.$clave >= "P067" & .$clave <= "P081") ~ .$ing_mens ), 
                    # Para obtener el ingreso por rentas, se seleccionan las claves de ingreso correspondientes
                    ing_ren = case_when((.$clave >= "P023" & .$clave <= "P031") ~ .$ing_mens ), 
                    # Para obtener el ingreso por transferencias, se seleccionan las claves de ingreso correspondientes 
                    ing_tra = case_when((.$clave >= "P032" & .$clave <= "P048") | (.$clave >= "P101" & .$clave <= "P108") ~ .$ing_mens )
                    ) %>%
              # Se estima el total de ingresos de cada  hogar
              group_by(folioviv, foliohog) %>%
               summarise(across(c(ing_mon, ing_lab, ing_ren, ing_tra), sum, na.rm = TRUE)) %>%
                ungroup() 
```

**Se guarda la base de datos**
```{r}
#fwrite(ingresos, paste0(here::here(), "/Output/Data/ingreso_deflactado22.csv"), row.names = F)
save(ingresos, file = paste0(here::here(), "/Output/Data/ingreso_deflactado22.RData"))
```


##### No Monetario  

En el caso de la información de gasto no monetario, para deflactar se utiliza la decena de levantamiento de la encuesta, la cual se encuentra en la octava posición del folio de la vivienda. En primer lugar se obtiene una variable que identifique la decena de levantamiento.   

Creación del ingreso no monetario deflactado a pesos de agosto del 2022.  

```{r}
load(file = paste0(here::here(), "/Data/gastoshogar.RData")) 
load(file = paste0(here::here(), "/Data/gastospersona.RData"))

gastoshogar <- gastoshogar %>% 
                mutate(base = 1)

gastospersona <- gastospersona  %>% 
                  mutate(base = 2) 
```

```{r}
no.monetario <- gastospersona %>%
                 bind_rows(., gastoshogar) %>%
                  mutate(frecuencia = ifelse(.$base == 2, 
                                              .$frec_rem, 
                                               .$frecuencia), 
                          # En el caso de la información de gasto no monetario, para deflactar se utiliza la decena 
                          # de levantamiento de la encuesta, la cual se encuentra en la octava posición del folio de la vivienda. 
                          # En primer lugar se obtiene una variable que identifique la decena de levantamiento.
                         decena = str_sub(str_pad(.$folioviv, 10, "left", pad = "0"), 8, 8))
```

**Definición de los deflactores**

```{r}
# Rubro 1.1 semanal, Alimentos		
  d11w07	<-	0.9869825057
  d11w08	<-	1.0000000000
  d11w09	<-	1.0130754464
  d11w10	<-	1.0178275200
  d11w11	<-	1.0207468579
  
  # Rubro 1.2 semanal, Bebidas alcohólicas y tabaco		
  d12w07	<-	0.9923340135
  d12w08	<-	1.0000000000
  d12w09	<-	1.0035071112
  d12w10	<-	1.0111808568
  d12w11	<-	1.0131982216
  
  # Rubro 2 trimestral, Vestido, calzado y accesorios		
  d2t05	<-	0.9899050815
  d2t06	<-	0.9941003723
  d2t07	<-	0.9997465345
  d2t08	<-	1.0083352270
  
  # Rubro 3 mensual, viviendas		
  d3m07	<-	0.9998142481
  d3m08	<-	1.0000000000
  d3m09	<-	0.9978682753
  d3m10	<-	1.0031577830
  d3m11	<-	1.0197073965
  
  # Rubro 4.2 mensual, Accesorios y artículos de limpieza para el hogar		
  d42m07	<-	0.9894769136
  d42m08	<-	1.0000000000
  d42m09	<-	1.0086286240
  d42m10	<-	1.0182083142
  d42m11	<-	1.0237613131
  
  # Rubro 4.2 trimestral, Accesorios y artículos de limpieza para el hogar		
  d42t05	<-	0.9787953163
  d42t06	<-	0.9897197934
  d42t07	<-	0.9993685126
  d42t08	<-	1.0089456461
  
  # Rubro 4.1 semestral, Muebles y aparatos dómesticos		
  d41s02	<-	1.0003069312
  d41s03	<-	0.9993861376
  d41s04	<-	0.9992122603
  d41s05	<-	0.9991442214
  
  # Rubro 5.1 trimestral, Salud		
  d51t05	<-	0.9909917367
  d51t06	<-	0.9954834527
  d51t07	<-	0.9994564693
  d51t08	<-	1.0030487384
  
  # Rubro 6.1.1 semanal, Transporte público urbano		
  d611w07	<-	0.9963207274
  d611w08	<-	1.0000000000
  d611w09	<-	1.0034865488
  d611w10	<-	1.0052385833
  d611w11	<-	1.0064912880
  
  # Rubro 6 mensual, Transporte		
  d6m07	<-	0.9987845893
  d6m08	<-	1.0000000000
  d6m09	<-	1.0001664946
  d6m10	<-	1.0057274150
  d6m11	<-	1.0076837268
  
  # Rubro 6 semestral, Transporte		
  d6s02	<-	0.9808628306
  d6s03	<-	0.9879901879
  d6s04	<-	0.9927380596
  d6s05	<-	0.9969378864
  
  # Rubro 7 mensual, Educación y esparcimiento		
  d7m07	<-	0.9961413091
  d7m08	<-	1.0000000000
  d7m09	<-	1.0095233900
  d7m10	<-	1.0144128271
  d7m11	<-	1.0174522069
  
  # Rubro 2.3 mensual, Accesorios y cuidados del vestido		
  d23m07	<-	0.9952443607
  d23m08	<-	1.0000000000
  d23m09	<-	1.0081869233
  d23m10	<-	1.0108184343
  d23m11	<-	1.0072323555
  
  # Rubro 2.3 trimestral,  Accesorios y cuidados del vestido		
  d23t05	<-	0.9914948875
  d23t06	<-	0.9956428139
  d23t07	<-	1.0011437613
  d23t08	<-	1.0063351192
  
  # INPC semestral		
  dINPCs02 <-	0.9773093813
  dINPCs03 <-	0.9838008772
  dINPCs04 <-	0.9897404209
  dINPCs05 <-	0.9957540070
```


**Una vez definidos los deflactores, se seleccionan los rubros** 

```{r}
no.monetario <- no.monetario %>%
                 mutate(gasnomon = .$gas_nm_tri/3,
                        esp = if_else(.$tipo_gasto == "G4", 1, NA_real_),
                        reg = if_else(.$tipo_gasto == "G5" | .$tipo_gasto == "G6", 1, NA_real_))  %>%
                 filter(!(tipo_gasto %in% c("G2", "G3", "G7"))) %>%
                 # Control para la frecuencia de los regalos recibidos por persona
                 filter(!(((frecuencia >= 5 & frecuencia <= 6) | is.na(frecuencia) | frecuencia == 0) & base == 1 & tipo_gasto == "G5")) %>%
                 filter(!(((frecuencia == 9) | is.na(frecuencia)) & base == 2 & tipo_gasto == "G5")) %>%
                 mutate(
                        # Se definen las asignaciones para las diferentes claves de ingreso
                        ali_nm = if_else(between(.$clave, "A001", "A222") | between(.$clave, "A242", "A247"), .$gasnomon, NA_real_),
                        alta_nm = if_else(between(.$clave, "A223", "A241"), .$gasnomon, NA_real_),
                        veca_nm = if_else(between(.$clave, "H001", "H122") | .$clave == "H136", .$gasnomon, NA_real_),
                        viv_nm = if_else(between(.$clave, "G001", "G016") | between(.$clave, "R001", "R004") | .$clave == "R013", .$gasnomon, NA_real_),
                        lim_nm = if_else(between(.$clave, "C001", "C024"), .$gasnomon, NA_real_),
                        cris_nm = if_else(between(.$clave, "I001", "I026"), .$gasnomon, NA_real_),
                        ens_nm = if_else(between(.$clave, "K001", "K037"), .$gasnomon, NA_real_),
                        sal_nm = if_else(between(.$clave, "J001", "J072"), .$gasnomon, NA_real_),
                        tpub_nm = if_else(between(.$clave, "B001", "B007"), .$gasnomon, NA_real_),
                        tfor_nm = if_else(between(.$clave, "M001", "M018") | between(.$clave, "F007", "F014"), .$gasnomon, NA_real_),
                        com_nm = if_else(between(.$clave, "F001", "F006") | between(.$clave, "R005", "R008") | between(.$clave, "R010", "R011"), .$gasnomon, NA_real_),
                        edre_nm = if_else(between(.$clave, "E001", "E034") | between(.$clave, "H134", "H135") | between(.$clave, "L001", "L029") | between(.$clave, "N003", "N005") | .$clave == "R009", .$gasnomon, NA_real_),
                        edba_nm = if_else((between(.$clave, "E002", "E003") | between(.$clave, "H134", "H135")), .$gasnomon, NA_real_),
                        cuip_nm = if_else(between(.$clave, "D001", "D026") | .$clave == "H132", .$gasnomon, NA_real_),
                        accp_nm = if_else(between(.$clave, "H123", "H131") | .$clave == "H133", .$gasnomon, NA_real_),
                        otr_nm = if_else(between(.$clave, "N001", "N002") | between(.$clave, "N006", "N016") | between(.$clave, "T901", "T915") | .$clave == "R012", .$gasnomon, NA_real_),
                        
                        reda_nm = if_else(between(.$clave, "T901", "T915") | .$clave == "N013", .$gasnomon, NA_real_)
                        ) %>% 
                 # Se deflactan los rubros del gasto no monetario según la decena de levantamiento
                   mutate(
                          # Gasto no monetario en Alimentos deflactado (semanal)
                          ali_nm = case_when(.$decena %in% c(1, 2, 3) ~ .$ali_nm/d11w08,
                                             .$decena %in% c(4, 5, 6) ~ .$ali_nm/d11w09,
                                             .$decena %in% c(7, 8, 9) ~ .$ali_nm/d11w10,
                                             .$decena %in% c(0) ~ .$ali_nm/d11w11),
                          # Gasto no monetario en Alcohol y tabaco deflactado (semanal)
                          alta_nm = case_when(.$decena %in% c(1,2,3) ~ .$alta_nm/d12w08,
                                              .$decena %in% c(4,5,6) ~ .$alta_nm/d12w09,
                                              .$decena %in% c(7,8,9) ~ .$alta_nm/d12w10,
                                              .$decena %in% c(0) ~ .$alta_nm/d12w11),
                          # Gasto no monetario en Vestido y calzado deflactado (trimestral)
                          veca_nm = case_when(.$decena %in% c(1,2) ~ .$veca_nm/d2t05,
                                              .$decena %in% c(3,4,5) ~ .$veca_nm/d2t06,
                                              .$decena %in% c(6,7,8) ~ .$veca_nm/d2t07,
                                              .$decena %in% c(9,0) ~ .$veca_nm/d2t08),
                          # Gasto no monetario en viviendas y servicios de conservación deflactado (mensual)
                          viv_nm = case_when(.$decena %in% c(1,2) ~ .$viv_nm/d3m07,
                                             .$decena %in% c(3,4,5) ~ .$viv_nm/d3m08,
                                             .$decena %in% c(6,7,8) ~ .$viv_nm/d3m09,
                                             .$decena %in% c(9,0) ~ .$viv_nm/d3m10),
                          # Gasto no monetario en Artículos de limpieza deflactado (mensual)
                          lim_nm = case_when(.$decena %in% c(1,2) ~ .$lim_nm/d42m07,
                                             .$decena %in% c(3,4,5) ~ .$lim_nm/d42m08,
                                             .$decena %in% c(6,7,8) ~ .$lim_nm/d42m09,
                                             .$decena %in% c(9,0) ~ .$lim_nm/d42m10),
                          # Gasto no monetario en Cristalería y blancos deflactado (trimestral)
                          cris_nm = case_when(.$decena %in% c(1,2) ~ .$cris_nm/d42t05,
                                              .$decena %in% c(3,4,5) ~ .$cris_nm/d42t06,
                                              .$decena %in% c(6,7,8) ~ .$cris_nm/d42t07,
                                              .$decena %in% c(9,0) ~ .$cris_nm/d42t08),
                          # Gasto no monetario en Enseres domésticos y muebles deflactado (semestral)
                          ens_nm = case_when(.$decena %in% c(1,2) ~ .$ens_nm/d41s02,
                                             .$decena %in% c(3,4,5) ~ .$ens_nm/d41s03,
                                             .$decena %in% c(6,7,8) ~ .$ens_nm/d41s04,
                                             .$decena %in% c(9,0) ~ .$ens_nm/d41s05),
                          # Gasto no monetario en Salud deflactado (trimestral)
                          sal_nm = case_when(.$decena %in% c(1,2) ~ .$sal_nm/d51t05,
                                             .$decena %in% c(3,4,5) ~ .$sal_nm/d51t06,
                                             .$decena %in% c(6,7,8) ~ .$sal_nm/d51t07,
                                             .$decena %in% c(9,0) ~ .$sal_nm/d51t08),
                          # Gasto no monetario en Transporte público deflactado (semanal)
                          tpub_nm = case_when(.$decena %in% c(1,2,3) ~ .$tpub_nm/d611w08,
                                              .$decena %in% c(4,5,6) ~ .$tpub_nm/d611w09,
                                              .$decena %in% c(7,8,9) ~ .$tpub_nm/d611w10,
                                              .$decena %in% c(0) ~ .$tpub_nm/d611w11),
                          # Gasto no monetario en Transporte foráneo deflactado (semestral)
                          tfor_nm = case_when(.$decena %in% c(1,2) ~ .$tfor_nm/d6s02,
                                              .$decena %in% c(3,4,5) ~ .$tfor_nm/d6s03,
                                              .$decena %in% c(6,7,8) ~ .$tfor_nm/d6s04,
                                              .$decena %in% c(9,0) ~ .$tfor_nm/d6s05),
                          # Gasto no monetario en Comunicaciones deflactado (mensual)
                          com_nm = case_when(.$decena %in% c(1,2) ~ .$com_nm/d6m07,
                                             .$decena %in% c(3,4,5) ~ .$com_nm/d6m08,
                                             .$decena %in% c(6,7,8) ~ .$com_nm/d6m09,
                                             .$decena %in% c(9,0) ~ .$com_nm/d6m10),
                          # Gasto no monetario en Educación y recreación deflactado (mensual)
                          edre_nm = case_when(.$decena %in% c(1,2) ~ .$edre_nm/d7m07,
                                              .$decena %in% c(3,4,5) ~ .$edre_nm/d7m08,
                                              .$decena %in% c(6,7,8) ~ .$edre_nm/d7m09,
                                              .$decena %in% c(9,0) ~ .$edre_nm/d7m10),
                          # Gasto no monetario en Educación básica deflactado (mensual)
                          edba_nm = case_when(.$decena %in% c(1,2) ~ .$edba_nm/d7m07,
                                              .$decena %in% c(3,4,5) ~ .$edba_nm/d7m08,
                                              .$decena %in% c(6,7,8) ~ .$edba_nm/d7m09,
                                              .$decena %in% c(9,0) ~ .$edba_nm/d7m10),
                          # Gasto no monetario en Cuidado personal deflactado (mensual)
                          cuip_nm = case_when(.$decena %in% c(1,2) ~ .$cuip_nm/d23m07,
                                              .$decena %in% c(3,4,5) ~ .$cuip_nm/d23m08,
                                              .$decena %in% c(6,7,8) ~ .$cuip_nm/d23m09,
                                              .$decena %in% c(9,0) ~ .$cuip_nm/d23m10),
                          # Gasto no monetario en Accesorios personales deflactado (trimestral)
                          accp_nm = case_when(.$decena %in% c(1,2) ~ .$accp_nm/d23t05,
                                              .$decena %in% c(3,4,5) ~ .$accp_nm/d23t06,
                                              .$decena %in% c(6,7,8) ~ .$accp_nm/d23t07,
                                              .$decena %in% c(9,0) ~ .$accp_nm/d23t08),
                           # Gasto no monetario en Otros gastos y transferencias deflactado (semestral)
                          otr_nm = case_when(.$decena %in% c(1,2) ~ .$otr_nm/dINPCs02,
                                             .$decena %in% c(3,4,5) ~ .$otr_nm/dINPCs03,
                                             .$decena %in% c(6,7,8) ~ .$otr_nm/dINPCs04,
                                             .$decena %in% c(9,0) ~ .$otr_nm/dINPCs05),
                          # Gasto no monetario en Regalos Otorgados deflactado
                          reda_nm = case_when(.$decena %in% c(1,2) ~ .$reda_nm/dINPCs02,
                                              .$decena %in% c(3,4,5) ~ .$reda_nm/dINPCs03,
                                              .$decena %in% c(6,7,8) ~ .$reda_nm/dINPCs04,
                                              .$decena %in% c(9,0) ~ .$reda_nm/dINPCs05))
```

**Se guarda la base de datos**
```{r}
#fwrite(no.monetario, paste0(here::here(), "/Output/Data/ingresonomonetario_def22.csv"), row.names = F)
save(no.monetario, file = paste0(here::here(), "/Output/Data/ingresonomonetario_def22.RData"))
```

**Construcción de la base de pagos en especie a partir de la base de gasto no monetario**  

```{r}
pagos.especie <- no.monetario %>%
                  filter(esp == 1) %>%
                   group_by(folioviv, foliohog) %>% 
                    summarise(across(all_of(names(.)[endsWith(names(.), "_nm")]), ~sum(., na.rm = TRUE))) %>%
                     rename_with(~ paste0(., "e"), 4:20)
```


**Se guarda la base de datos**
```{r}
#fwrite(pagos.especie, paste0(here::here(), "/Output/Data/esp_def22.csv"), row.names = F)
save(pagos.especie, file = paste0(here::here(), "/Output/Data/esp_def22.RData"))
```

**Construcción de base de regalos a partir de la base no monetaria**  

```{r}
regalos <- no.monetario %>% 
            filter(reg == 1) %>%
             group_by(folioviv, foliohog) %>% 
              summarise(across(all_of(names(.)[endsWith(names(.), "_nm")]), ~sum(., na.rm = TRUE))) %>%
               rename_with(~ paste0(., "r"), 4:20)
```


**Se guarda la base de datos**
```{r}
#fwrite(regalos, paste0(here::here(), "/Output/Data/reg_def22.csv"), row.names = F)
save(regalos, file = paste0(here::here(), "/Output/Data/reg_def22.RData"))
```


